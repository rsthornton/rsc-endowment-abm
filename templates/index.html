<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSC Endowment ABM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-alt: #0d0d0d;
            --bg-panel: #0f0f0f;
            --bg-card: #111;
            --bg-hover: #151515;
            --border: #1a1a1a;
            --border-light: #2a2a2a;
            --text: #d0d0d0;
            --text-muted: #888;
            --text-dim: #555;
            --accent: #c9a227;
            --success: #50c878;
            --danger: #e05555;
            --info: #4a9eff;
            --purple: #7856ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            padding: 24px;
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header { margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        h1 {
            color: var(--accent);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .subtitle { color: var(--text-muted); font-size: 13px; }

        .controls {
            display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.15s;
        }
        button:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
            color: var(--accent);
        }
        button.primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }
        button.primary:hover { background: #d4ad32; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .step-badge {
            background: var(--bg-panel);
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
        }
        .step-badge span { color: var(--accent); font-weight: 600; }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .card-header {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }
        .span-6 { grid-column: span 6; }
        .span-8 { grid-column: span 8; }
        .span-12 { grid-column: span 12; }
        @media (max-width: 1000px) {
            .span-3, .span-4, .span-6, .span-8 { grid-column: span 12; }
        }

        .metrics-row { display: flex; gap: 16px; flex-wrap: wrap; }
        .metric {
            flex: 1; min-width: 100px;
            text-align: center;
            padding: 12px;
            background: var(--bg-panel);
            border-radius: 4px;
        }
        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'SF Mono', monospace;
        }
        .metric-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .tier-bar {
            display: flex; height: 24px; border-radius: 4px; overflow: hidden;
            margin-bottom: 12px; border: 1px solid var(--border);
        }
        .tier-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 600; color: #000;
        }
        .tier-flexible { background: #536471; }
        .tier-3month { background: #4a9eff; }
        .tier-6month { background: #7856ff; }
        .tier-12month { background: var(--accent); }

        .tier-legend { display: flex; gap: 16px; flex-wrap: wrap; font-size: 11px; }
        .tier-legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .tier-dot { width: 8px; height: 8px; border-radius: 2px; }

        .list { max-height: 280px; overflow-y: auto; }
        .list-item {
            background: var(--bg-panel);
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .list-item:last-child { margin-bottom: 0; }

        .proposal-id { font-weight: 600; color: var(--text); font-family: monospace; }
        .progress-bar {
            width: 80px; height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            margin: 0 12px;
            overflow: hidden;
        }
        .progress-fill { height: 100%; background: var(--success); border-radius: 2px; }

        .status { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-open { color: var(--info); }
        .status-funded { color: var(--success); }
        .status-completed { color: var(--success); }
        .status-failed { color: var(--danger); }

        .event {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }
        .event:last-child { border-bottom: none; }
        .event-step {
            color: var(--text-dim);
            font-family: monospace;
            margin-right: 8px;
        }
        .event-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }
        .event-type.funded { background: rgba(80,200,120,0.2); color: var(--success); }
        .event-type.completed { background: rgba(80,200,120,0.2); color: var(--success); }
        .event-type.failed { background: rgba(224,85,85,0.2); color: var(--danger); }
        .event-type.new_proposal { background: rgba(74,158,255,0.2); color: var(--info); }
        .event-type.init { background: rgba(201,162,39,0.2); color: var(--accent); }
        .event-type.churn { background: rgba(224,85,85,0.15); color: #c07070; }

        .chart-container { height: 180px; }

        /* Parameter Sliders */
        .param-sliders {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        .slider-label { color: var(--text-muted); }
        .slider-value { color: var(--accent); font-weight: 600; font-family: monospace; }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .slider-hint {
            font-size: 9px;
            color: var(--text-dim);
        }
        .apply-params {
            margin-top: 12px;
            width: 100%;
        }

        /* Archetype section */
        .archetype-bar {
            display: flex; height: 24px; border-radius: 4px; overflow: hidden;
            margin-bottom: 12px; border: 1px solid var(--border);
        }
        .arch-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 600; color: #000;
            transition: width 0.3s;
        }
        .arch-believer { background: var(--success); }
        .arch-yield_seeker { background: var(--accent); }
        .arch-governance { background: var(--purple); }
        .arch-speculator { background: var(--danger); }

        .arch-legend { display: flex; gap: 12px; flex-wrap: wrap; font-size: 11px; margin-bottom: 12px; }
        .arch-legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .arch-dot { width: 8px; height: 8px; border-radius: 2px; }

        .arch-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            font-size: 11px;
        }
        @media (max-width: 800px) {
            .arch-metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .arch-metric-card {
            background: var(--bg-panel);
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid var(--border-light);
        }
        .arch-metric-card.believer { border-left-color: var(--success); }
        .arch-metric-card.yield_seeker { border-left-color: var(--accent); }
        .arch-metric-card.governance { border-left-color: var(--purple); }
        .arch-metric-card.speculator { border-left-color: var(--danger); }
        .arch-card-name {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .arch-card-name.believer { color: var(--success); }
        .arch-card-name.yield_seeker { color: var(--accent); }
        .arch-card-name.governance { color: var(--purple); }
        .arch-card-name.speculator { color: var(--danger); }
        .arch-stat { display: flex; justify-content: space-between; color: var(--text-muted); padding: 2px 0; }
        .arch-stat-val { color: var(--text); font-family: monospace; }

        .questions-section { margin-top: 24px; }
        .question {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .question-text { font-size: 13px; color: var(--text); margin-bottom: 6px; }
        .question-current {
            font-size: 11px;
            color: var(--text-dim);
        }
        .question-current span { color: var(--accent); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* Round Narrative */
        .narrative { font-size: 13px; line-height: 1.7; }
        .narrative-placeholder { color: var(--text-dim); font-style: italic; }
        .narrative-highlight { color: var(--accent); font-weight: 600; }
        .narrative-success { color: var(--success); }
        .narrative-danger { color: var(--danger); }
        .narrative p { margin-bottom: 8px; }
        .narrative p:last-child { margin-bottom: 0; }

        /* Agent Inspector */
        .agent-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .agent-tab {
            background: transparent;
            border: 1px solid var(--border);
            padding: 6px 12px;
            font-size: 11px;
        }
        .agent-tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        .agent-content { min-height: 120px; }
        .agent-placeholder { color: var(--text-dim); font-style: italic; font-size: 12px; }
        .agent-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        .agent-table th {
            text-align: left;
            padding: 8px;
            background: var(--bg-panel);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
        }
        .agent-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .agent-table tr:hover { background: var(--bg-hover); }
        .agent-table tr.churned { opacity: 0.5; }
        .agent-id { font-family: monospace; color: var(--accent); font-weight: 600; }
        .tier-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .tier-flexible { background: rgba(83,100,113,0.3); color: #536471; }
        .tier-3_month { background: rgba(74,158,255,0.2); color: #4a9eff; }
        .tier-6_month { background: rgba(120,86,255,0.2); color: #7856ff; }
        .tier-12_month { background: rgba(201,162,39,0.2); color: var(--accent); }
        .arch-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .arch-badge.believer { background: rgba(80,200,120,0.2); color: var(--success); }
        .arch-badge.yield_seeker { background: rgba(201,162,39,0.2); color: var(--accent); }
        .arch-badge.governance { background: rgba(120,86,255,0.2); color: var(--purple); }
        .arch-badge.speculator { background: rgba(224,85,85,0.2); color: var(--danger); }
        .sat-bar {
            width: 40px; height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }
        .sat-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Education Section */
        .education-content { display: block; padding-top: 16px; }
        .education-content.collapsed { display: none; }
        .edu-flow {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .flow-step {
            flex: 1;
            min-width: 160px;
            max-width: 200px;
            background: var(--bg-panel);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .flow-icon { font-size: 28px; margin-bottom: 8px; }
        .flow-title { font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 6px; }
        .flow-desc { font-size: 11px; color: var(--text-muted); line-height: 1.5; }
        .flow-arrow {
            color: var(--text-dim);
            font-size: 24px;
            padding-top: 30px;
        }
        @media (max-width: 800px) {
            .flow-arrow { display: none; }
            .edu-flow { flex-direction: column; align-items: center; }
        }
        .edu-section {
            background: var(--bg-panel);
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            border-left: 3px solid var(--accent);
        }
        .edu-section:last-child { margin-bottom: 0; }
        .edu-section h3 {
            font-size: 13px;
            color: var(--accent);
            margin-bottom: 10px;
        }
        .edu-section p, .edu-section li {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        .edu-section ul, .edu-section ol {
            margin-left: 20px;
            margin-top: 8px;
        }
        .edu-section li { margin-bottom: 4px; }
        .edu-section strong { color: var(--text); }

        /* Sim Canvas */
        .sim-canvas-wrap {
            position: relative;
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
            background: #080808;
        }
        .sim-canvas-wrap canvas {
            display: block;
            width: 100%;
        }

        /* Tooltips */
        .metric[data-tooltip] {
            position: relative;
            cursor: help;
        }
        .metric[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            border: 1px solid var(--border-light);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RSC DECENTRALIZED ENDOWMENT</h1>
            <div class="subtitle">Stake RSC &rarr; Earn Credits (APY) &rarr; Deploy to Proposals &rarr; 2% Burn</div>
        </header>

        <div class="controls">
            <button class="primary" onclick="step()">Step</button>
            <button onclick="run(10)">Run 10</button>
            <button onclick="run(52)">Run 1 Year</button>
            <button onclick="resetWithParams()">Reset</button>
            <div class="step-badge">Week <span id="step-count">0</span></div>
            <div class="step-badge">Active <span id="active-count">0</span> / <span id="total-count">0</span></div>
            <div class="step-badge">Satisfaction <span id="avg-sat">1.00</span></div>
        </div>

        <div class="grid">
            <!-- Key Metrics -->
            <div class="card span-12">
                <div class="card-header">Key Metrics</div>
                <div class="metrics-row">
                    <div class="metric" data-tooltip="Total RSC locked by active stakers">
                        <div class="metric-value" id="total-staked">0</div>
                        <div class="metric-label">RSC Staked</div>
                    </div>
                    <div class="metric" data-tooltip="Accumulated funding power (not tradeable)">
                        <div class="metric-value" id="total-credits">0</div>
                        <div class="metric-label">Credits</div>
                    </div>
                    <div class="metric" data-tooltip="RSC permanently removed via 2% burn">
                        <div class="metric-value" id="total-burned">0</div>
                        <div class="metric-label">Burned</div>
                    </div>
                    <div class="metric" data-tooltip="New credits generated this week (stake x APY)">
                        <div class="metric-value" id="credit-rate">0</div>
                        <div class="metric-label">Credits/Wk</div>
                    </div>
                    <div class="metric" data-tooltip="Credits spent on proposals this week">
                        <div class="metric-value" id="deployment-rate">0</div>
                        <div class="metric-label">Deployed/Wk</div>
                    </div>
                    <div class="metric" data-tooltip="Stakers who left the system (low satisfaction)">
                        <div class="metric-value" id="churned-count" style="color:var(--danger)">0</div>
                        <div class="metric-label">Churned</div>
                    </div>
                    <div class="metric" data-tooltip="% of funded proposals that completed">
                        <div class="metric-value" id="success-rate">&mdash;</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                </div>
            </div>

            <!-- Agent Visualization Canvas -->
            <div class="card span-12">
                <div class="card-header">Agent Field (archetype behavior at a glance)</div>
                <div class="sim-canvas-wrap">
                    <canvas id="sim-canvas"></canvas>
                </div>
            </div>

            <!-- Parameter Controls -->
            <div class="card span-6">
                <div class="card-header">Parameters (adjust & reset)</div>
                <div class="param-sliders">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Base APY</span>
                            <span class="slider-value" id="val-apy">10%</span>
                        </div>
                        <input type="range" id="slider-apy" min="1" max="30" value="10" step="1"
                            oninput="document.getElementById('val-apy').textContent=this.value+'%'">
                        <div class="slider-hint">Higher APY = more credits = faster funding</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Burn Rate</span>
                            <span class="slider-value" id="val-burn">2%</span>
                        </div>
                        <input type="range" id="slider-burn" min="0" max="10" value="2" step="0.5"
                            oninput="document.getElementById('val-burn').textContent=this.value+'%'">
                        <div class="slider-hint">Higher burn = more deflation, higher cost</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Stakers</span>
                            <span class="slider-value" id="val-stakers">100</span>
                        </div>
                        <input type="range" id="slider-stakers" min="10" max="500" value="100" step="10"
                            oninput="document.getElementById('val-stakers').textContent=this.value">
                        <div class="slider-hint">Population size</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Success Rate</span>
                            <span class="slider-value" id="val-success">80%</span>
                        </div>
                        <input type="range" id="slider-success" min="10" max="100" value="80" step="5"
                            oninput="document.getElementById('val-success').textContent=this.value+'%'">
                        <div class="slider-hint">Proposal completion probability</div>
                    </div>
                </div>
                <button class="primary apply-params" onclick="resetWithParams()">Apply & Reset</button>
            </div>

            <!-- Archetype Mix -->
            <div class="card span-6">
                <div class="card-header">Archetype Mix (adjust population composition)</div>
                <div class="archetype-bar" id="arch-bar"></div>
                <div class="arch-legend">
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--success)"></div> Believer</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--accent)"></div> Yield Seeker</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--purple)"></div> Governance</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--danger)"></div> Speculator</div>
                </div>
                <div class="param-sliders">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--success)">Believers</span>
                            <span class="slider-value" id="val-believer">25%</span>
                        </div>
                        <input type="range" id="slider-believer" min="0" max="100" value="25" step="5"
                            oninput="updateArchMixPreview()">
                        <div class="slider-hint">Mission-aligned, long locks, active deployers</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--accent)">Yield Seekers</span>
                            <span class="slider-value" id="val-yield_seeker">30%</span>
                        </div>
                        <input type="range" id="slider-yield_seeker" min="0" max="100" value="30" step="5"
                            oninput="updateArchMixPreview()">
                        <div class="slider-hint">APY-motivated, moderate engagement</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--purple)">Governance</span>
                            <span class="slider-value" id="val-governance">20%</span>
                        </div>
                        <input type="range" id="slider-governance" min="0" max="100" value="20" step="5"
                            oninput="updateArchMixPreview()">
                        <div class="slider-hint">Influence-focused, flexible tier, selective</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--danger)">Speculators</span>
                            <span class="slider-value" id="val-speculator">25%</span>
                        </div>
                        <input type="range" id="slider-speculator" min="0" max="100" value="25" step="5"
                            oninput="updateArchMixPreview()">
                        <div class="slider-hint">Price-driven, hoards credits, churn-prone</div>
                    </div>
                </div>
                <div id="arch-mix-warn" style="font-size:10px;color:var(--danger);margin-top:8px;display:none"></div>
            </div>

            <!-- Tier Distribution -->
            <div class="card span-6">
                <div class="card-header">Staking Tiers (driven by risk tolerance)</div>
                <div class="tier-bar" id="tier-bar"></div>
                <div class="tier-legend">
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#536471"></div> Flexible 1x</div>
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#4a9eff"></div> 3mo 1.5x</div>
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#7856ff"></div> 6mo 2x</div>
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#c9a227"></div> 12mo 3x</div>
                </div>
            </div>

            <!-- Archetype Behavioral Metrics -->
            <div class="card span-6">
                <div class="card-header">Archetype Behavior (per-group metrics)</div>
                <div class="arch-metrics-grid" id="arch-metrics"></div>
            </div>

            <!-- Chart -->
            <div class="card span-8">
                <div class="card-header">Time Series</div>
                <div class="chart-container">
                    <canvas id="history-chart"></canvas>
                </div>
            </div>

            <!-- Proposals -->
            <div class="card span-4">
                <div class="card-header">Proposals</div>
                <div class="list" id="proposals-list"></div>
            </div>

            <!-- Events -->
            <div class="card span-12">
                <div class="card-header">Event Log</div>
                <div class="list" id="events-list" style="max-height: 150px;"></div>
            </div>
        </div>

        <!-- Round Narrative -->
        <div class="card span-12" style="margin-top: 16px;">
            <div class="card-header">This Week's Activity</div>
            <div id="round-narrative" class="narrative">
                <p class="narrative-placeholder">Run the simulation to see what happens each week...</p>
            </div>
        </div>

        <!-- Agent Inspector -->
        <div class="card span-12" style="margin-top: 16px;">
            <div class="card-header">Agent Inspector</div>
            <div class="agent-tabs">
                <button class="agent-tab active" onclick="showAgentTab('top-stakers')">Top Stakers</button>
                <button class="agent-tab" onclick="showAgentTab('recent-deployers')">Recent Deployers</button>
                <button class="agent-tab" onclick="showAgentTab('by-archetype')">By Archetype</button>
                <button class="agent-tab" onclick="showAgentTab('churned')">Churned</button>
            </div>
            <div id="agent-content" class="agent-content">
                <div class="agent-placeholder">Loading agents...</div>
            </div>
        </div>

        <!-- How It Works (Educational) -->
        <div class="education-section" style="margin-top: 24px;">
            <div class="card">
                <div class="card-header" onclick="toggleEducation()" style="cursor: pointer;">
                    How This Model Works <span id="edu-toggle" style="float:right;">&#9660;</span>
                </div>
                <div id="education-content" class="education-content">
                    <div class="edu-flow">
                        <div class="flow-step">
                            <div class="flow-icon">&#128176;</div>
                            <div class="flow-title">1. Stake RSC</div>
                            <div class="flow-desc">Stakers lock RSC and choose a tier based on their <strong>risk tolerance</strong>. Longer locks = higher APY multiplier.</div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flow-step">
                            <div class="flow-icon">&#10024;</div>
                            <div class="flow-title">2. Earn Credits</div>
                            <div class="flow-desc">Each week, stakers earn funding credits (stake x APY x tier). Credits are deployment power, not tradeable tokens.</div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flow-step">
                            <div class="flow-icon">&#127919;</div>
                            <div class="flow-title">3. Deploy to Proposals</div>
                            <div class="flow-desc"><strong>Engagement</strong> drives deployment probability. Mission-aligned stakers prefer near-funded proposals.</div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flow-step">
                            <div class="flow-icon">&#128293;</div>
                            <div class="flow-title">4. 2% Burn</div>
                            <div class="flow-desc">When credits deploy, 2% of backer's RSC is burned. This creates deflationary pressure on the token.</div>
                        </div>
                    </div>

                    <div class="edu-section">
                        <h3>Behavioral Model: B = f(P, E)</h3>
                        <p>Each staker has <strong>Person attributes</strong> that interact with <strong>Environment conditions</strong> to produce behavior:</p>
                        <ul>
                            <li><strong>Mission Alignment</strong> (0-1): Cares about funding good research vs. just earning yield. Affects proposal selection.</li>
                            <li><strong>Risk Tolerance</strong> (0-1): Willingness to lock longer for higher APY. Drives tier selection.</li>
                            <li><strong>Engagement</strong> (0-1): How actively they deploy credits. Base probability of deploying each week.</li>
                            <li><strong>Price Sensitivity</strong> (0-1): How much external conditions matter (future expansion).</li>
                        </ul>
                        <p style="margin-top:8px">These combine into <strong>4 archetypes</strong>: Believers (mission-driven), Yield Seekers (APY-driven), Governance (influence-driven), and Speculators (price-driven).</p>
                    </div>

                    <div class="edu-section">
                        <h3>What Happens Each Step (Week)?</h3>
                        <ol>
                            <li><strong>Credit Generation:</strong> All active stakers earn credits based on tier APY</li>
                            <li><strong>Deployment Decision:</strong> Each staker decides whether to deploy based on engagement + credit accumulation pressure + satisfaction</li>
                            <li><strong>Proposal Selection:</strong> Mission-aligned stakers pick near-funded proposals; others pick randomly</li>
                            <li><strong>Burn Event:</strong> 2% of deploying stakers' RSC is burned</li>
                            <li><strong>Satisfaction Update:</strong> Based on proposal outcomes (did my backed proposals succeed?)</li>
                            <li><strong>Churn Check:</strong> Unsatisfied, unlocked stakers may leave the system</li>
                        </ol>
                    </div>

                    <div class="edu-section">
                        <h3>Key Dynamics to Watch</h3>
                        <ul>
                            <li><strong>Archetype behavior:</strong> Believers deploy actively; Speculators hoard. Which behavior dominates?</li>
                            <li><strong>Satisfaction & churn:</strong> Failed proposals reduce satisfaction. Low satisfaction + no lock = exit risk.</li>
                            <li><strong>Tier distribution:</strong> Risk-tolerant agents lock longer. Does this create enough funding capacity?</li>
                            <li><strong>Credit accumulation pressure:</strong> Agents with excess credits feel pressure to deploy (sigmoid function).</li>
                            <li><strong>Proposal throughput:</strong> Are proposals getting funded at a healthy rate?</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Design Questions -->
        <div class="questions-section">
            <div class="card">
                <div class="card-header">Open Design Questions (for ResearchHub)</div>
                <div id="design-questions"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SimCanvas — NetLogo-style agent field
        // ============================================
        class SimCanvas {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.dpr = window.devicePixelRatio || 1;
                this.W = 0;
                this.H = 0;
                this.agents = [];       // positioned agent objects
                this.proposals = [];    // positioned proposal objects
                this.arcs = [];         // active deployment arcs
                this.churns = [];       // active churn animations
                this.animating = false;
                this.lastStakers = null;

                // Archetype config
                this.archColors = {
                    believer:     '#50c878',
                    yield_seeker: '#c9a227',
                    governance:   '#7856ff',
                    speculator:   '#e05555',
                };
                this.archLabels = {
                    believer:     'BELIEVERS',
                    yield_seeker: 'YIELD SEEKERS',
                    governance:   'GOVERNANCE',
                    speculator:   'SPECULATORS',
                };
                // Quadrant layout: [xCenter fraction, yCenter fraction]
                this.quadrants = {
                    believer:     { cx: 0.25, cy: 0.30 },
                    yield_seeker: { cx: 0.75, cy: 0.30 },
                    governance:   { cx: 0.25, cy: 0.75 },
                    speculator:   { cx: 0.75, cy: 0.75 },
                };

                this._resize();
                window.addEventListener('resize', () => this._resize());
            }

            _resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.W = rect.width;
                this.H = Math.max(400, Math.min(500, this.W * 0.45));
                this.canvas.width = this.W * this.dpr;
                this.canvas.height = this.H * this.dpr;
                this.canvas.style.height = this.H + 'px';
                this.ctx.setTransform(this.dpr, 0, 0, this.dpr, 0, 0);
                // Reposition agents if we have data
                if (this.lastStakers) {
                    this._positionAgents(this.lastStakers);
                }
                this._drawStatic();
            }

            // Phyllotaxis spiral positioning within a quadrant
            _phyllotaxis(agents, cx, cy, maxRadius) {
                const goldenAngle = Math.PI * (3 - Math.sqrt(5));
                const n = agents.length;
                // Sort by stake descending — big stakers center
                agents.sort((a, b) => b._stake - a._stake);
                const spacing = Math.max(maxRadius / Math.sqrt(n + 1), 8);
                for (let i = 0; i < n; i++) {
                    const r = spacing * Math.sqrt(i + 0.5);
                    const theta = i * goldenAngle;
                    agents[i].x = cx + r * Math.cos(theta);
                    agents[i].y = cy + r * Math.sin(theta);
                }
            }

            _positionAgents(stakers) {
                this.lastStakers = stakers;
                const groups = { believer: [], yield_seeker: [], governance: [], speculator: [] };

                stakers.forEach(s => {
                    if (!groups[s.archetype]) return;
                    groups[s.archetype].push({
                        id: s.id,
                        archetype: s.archetype,
                        active: s.active,
                        _stake: s.stake,
                        satisfaction: s.satisfaction,
                        credits_pressure: s.credits_pressure || 0,
                        // Radius: 4-18px based on stake
                        radius: 4 + Math.min(14, (s.stake / 20000) * 14),
                        x: 0, y: 0,
                    });
                });

                const allAgents = [];
                for (const [arch, agents] of Object.entries(groups)) {
                    const q = this.quadrants[arch];
                    const cx = q.cx * this.W;
                    const cy = q.cy * this.H;
                    const maxR = Math.min(this.W * 0.22, this.H * 0.30);
                    this._phyllotaxis(agents, cx, cy, maxR);
                    allAgents.push(...agents);
                }
                this.agents = allAgents;
            }

            _positionProposals(proposals) {
                // Center horizontal band
                const bandY = this.H * 0.52;
                const openOrFunded = proposals.filter(p => p.status === 'open' || p.status === 'funded');
                const n = openOrFunded.length;
                if (n === 0) { this.proposals = []; return; }

                const margin = this.W * 0.1;
                const span = this.W - margin * 2;
                this.proposals = openOrFunded.map((p, i) => {
                    const x = margin + (n === 1 ? span / 2 : (i / (n - 1)) * span);
                    return {
                        id: p.id,
                        status: p.status,
                        funding_target: p.funding_target,
                        funding_progress: p.funding_progress,
                        x: x,
                        y: bandY,
                        radius: 5 + Math.min(10, (p.funding_target / 10000) * 10),
                    };
                });
            }

            // Main update called from updateUI
            update(stakers, proposals, stepDeployments) {
                this._positionAgents(stakers);
                this._positionProposals(proposals);

                // Create deployment arcs
                if (stepDeployments && stepDeployments.length > 0) {
                    for (const d of stepDeployments) {
                        const agent = this.agents.find(a => a.id === d.staker_id);
                        const proposal = this.proposals.find(p => p.id === d.proposal_id);
                        if (agent && proposal) {
                            this.arcs.push({
                                x0: agent.x, y0: agent.y,
                                x1: proposal.x, y1: proposal.y,
                                color: this.archColors[d.archetype] || '#888',
                                width: Math.max(1, Math.min(3, d.credits / 100)),
                                progress: 0,  // 0-1 for traveling dot
                                alpha: 1.0,
                                startTime: performance.now(),
                                duration: 1500,
                            });
                        }
                    }
                }

                // Detect churn (agents that became inactive)
                for (const a of this.agents) {
                    if (!a.active && !a._churning && !a._churned) {
                        a._churning = true;
                        this.churns.push({
                            agent: a,
                            startTime: performance.now(),
                            duration: 2000,
                        });
                    }
                }

                if (this.arcs.length > 0 || this.churns.length > 0) {
                    this._startAnimation();
                } else {
                    this._drawFrame();
                }
            }

            reset() {
                this.agents = [];
                this.proposals = [];
                this.arcs = [];
                this.churns = [];
                this.lastStakers = null;
                this.animating = false;
                this._drawStatic();
            }

            // Animation loop — only runs when there are active animations
            _startAnimation() {
                if (this.animating) return;
                this.animating = true;
                const loop = () => {
                    if (!this.animating) return;
                    const now = performance.now();

                    // Update arcs
                    this.arcs = this.arcs.filter(arc => {
                        const elapsed = now - arc.startTime;
                        if (elapsed >= arc.duration) return false;
                        arc.progress = elapsed / arc.duration;
                        arc.alpha = 1.0 - (elapsed / arc.duration) * 0.7;
                        return true;
                    });

                    // Update churns
                    this.churns = this.churns.filter(c => {
                        const elapsed = now - c.startTime;
                        if (elapsed >= c.duration) {
                            c.agent._churned = true;
                            c.agent._churning = false;
                            return false;
                        }
                        c.agent._churnProgress = elapsed / c.duration;
                        return true;
                    });

                    this._drawFrame();

                    if (this.arcs.length === 0 && this.churns.length === 0) {
                        this.animating = false;
                        return;
                    }
                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
            }

            _drawStatic() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.W, this.H);

                // Background
                ctx.fillStyle = '#080808';
                ctx.fillRect(0, 0, this.W, this.H);

                // Center proposal band highlight
                const bandY = this.H * 0.52;
                ctx.fillStyle = 'rgba(255,255,255,0.02)';
                ctx.fillRect(0, bandY - 15, this.W, 30);

                // Quadrant dividers (subtle)
                ctx.strokeStyle = 'rgba(255,255,255,0.04)';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 8]);
                // Vertical center
                ctx.beginPath();
                ctx.moveTo(this.W / 2, 0);
                ctx.lineTo(this.W / 2, this.H);
                ctx.stroke();
                // Horizontal center
                ctx.beginPath();
                ctx.moveTo(0, this.H / 2);
                ctx.lineTo(this.W, this.H / 2);
                ctx.stroke();
                ctx.setLineDash([]);

                // Quadrant labels
                ctx.font = '10px SF Mono, Menlo, monospace';
                ctx.textAlign = 'center';
                for (const [arch, q] of Object.entries(this.quadrants)) {
                    const x = q.cx * this.W;
                    const yBase = q.cy * this.H;
                    // Label above or below the quadrant center
                    const labelY = yBase < this.H / 2 ? 16 : this.H - 8;
                    ctx.fillStyle = this.archColors[arch];
                    ctx.globalAlpha = 0.4;
                    ctx.fillText(this.archLabels[arch], x, labelY);
                }
                ctx.globalAlpha = 1.0;
                ctx.textAlign = 'start';
            }

            _drawFrame() {
                const ctx = this.ctx;
                this._drawStatic();

                // 1. Deployment arcs (behind everything)
                for (const arc of this.arcs) {
                    const midX = (arc.x0 + arc.x1) / 2;
                    const midY = Math.min(arc.y0, arc.y1) - 30;
                    ctx.beginPath();
                    ctx.moveTo(arc.x0, arc.y0);
                    ctx.quadraticCurveTo(midX, midY, arc.x1, arc.y1);
                    ctx.strokeStyle = arc.color;
                    ctx.lineWidth = arc.width;
                    ctx.globalAlpha = arc.alpha * 0.6;
                    ctx.stroke();

                    // Traveling dot
                    const t = arc.progress;
                    const dotX = (1-t)*(1-t)*arc.x0 + 2*(1-t)*t*midX + t*t*arc.x1;
                    const dotY = (1-t)*(1-t)*arc.y0 + 2*(1-t)*t*midY + t*t*arc.y1;
                    ctx.beginPath();
                    ctx.arc(dotX, dotY, 3, 0, Math.PI * 2);
                    ctx.fillStyle = arc.color;
                    ctx.globalAlpha = arc.alpha;
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;

                // 2. Proposals (center band)
                for (const p of this.proposals) {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    if (p.status === 'funded') {
                        ctx.fillStyle = 'rgba(80,200,120,0.3)';
                        ctx.strokeStyle = '#50c878';
                    } else {
                        ctx.fillStyle = 'rgba(74,158,255,0.2)';
                        ctx.strokeStyle = '#4a9eff';
                    }
                    ctx.lineWidth = 1.5;
                    ctx.fill();
                    ctx.stroke();

                    // Progress arc
                    if (p.funding_progress > 0) {
                        const endAngle = -Math.PI / 2 + (Math.min(p.funding_progress, 100) / 100) * Math.PI * 2;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius + 3, -Math.PI / 2, endAngle);
                        ctx.strokeStyle = p.status === 'funded' ? '#50c878' : '#4a9eff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }

                // 3. Agents
                for (const a of this.agents) {
                    if (a._churned) continue; // fully gone

                    let scale = 1;
                    let alpha = 0.3 + a.satisfaction * 0.7; // opacity = satisfaction

                    if (a._churning) {
                        const p = a._churnProgress || 0;
                        scale = 1 - p;
                        alpha *= (1 - p);
                    }

                    if (!a.active && !a._churning) {
                        // Already churned in a previous step — dim ghost
                        alpha = 0.1;
                        scale = 0.4;
                    }

                    const r = a.radius * scale;
                    if (r < 0.5) continue;

                    const color = this.archColors[a.archetype] || '#888';

                    // Credit ring (outer ring showing accumulation pressure)
                    if (a.credits_pressure > 0.1 && a.active) {
                        ctx.beginPath();
                        ctx.arc(a.x, a.y, r + 2 + a.credits_pressure * 2, 0, Math.PI * 2);
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 1;
                        ctx.globalAlpha = alpha * 0.35 * Math.min(a.credits_pressure, 1);
                        ctx.stroke();
                    }

                    // Agent circle
                    ctx.beginPath();
                    ctx.arc(a.x, a.y, r, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.globalAlpha = alpha;
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
            }
        }

        // Create the canvas instance
        const simCanvas = new SimCanvas('sim-canvas');

        const API = '';
        let chart = null;
        let historyData = { steps: [], staked: [], credits: [], burned: [], satisfaction: [], active: [] };

        async function fetchJson(url, options = {}) {
            const resp = await fetch(API + url, options);
            return resp.json();
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return Math.round(n).toLocaleString();
        }

        function satColor(sat) {
            if (sat >= 0.7) return 'var(--success)';
            if (sat >= 0.4) return 'var(--accent)';
            return 'var(--danger)';
        }

        // Archetype mix preview
        function updateArchMixPreview() {
            const archs = ['believer', 'yield_seeker', 'governance', 'speculator'];
            let total = 0;
            archs.forEach(a => { total += parseInt(document.getElementById('slider-' + a).value); });
            const warn = document.getElementById('arch-mix-warn');
            if (total === 0) {
                warn.style.display = 'block';
                warn.textContent = 'Total is 0% — at least one archetype must be non-zero.';
            } else if (total !== 100) {
                warn.style.display = 'block';
                warn.textContent = 'Total is ' + total + '% — will be normalized to 100% on reset.';
            } else {
                warn.style.display = 'none';
            }
            archs.forEach(a => {
                const val = parseInt(document.getElementById('slider-' + a).value);
                const pct = total > 0 ? Math.round(val / total * 100) : 0;
                document.getElementById('val-' + a).textContent = pct + '%';
            });
        }

        function getSliderParams() {
            const archs = ['believer', 'yield_seeker', 'governance', 'speculator'];
            let total = 0;
            const raw = {};
            archs.forEach(a => {
                raw[a] = parseInt(document.getElementById('slider-' + a).value);
                total += raw[a];
            });
            const mix = {};
            if (total > 0) {
                archs.forEach(a => { mix[a] = parseFloat((raw[a] / total).toFixed(4)); });
            }
            return {
                num_stakers: parseInt(document.getElementById('slider-stakers').value),
                base_apy: parseInt(document.getElementById('slider-apy').value) / 100,
                burn_rate: parseFloat(document.getElementById('slider-burn').value) / 100,
                success_rate: parseInt(document.getElementById('slider-success').value) / 100,
                archetype_mix: mix,
            };
        }

        // Main UI update
        async function updateUI() {
            const state = await fetchJson('/api/state');
            const model = state.model;

            document.getElementById('step-count').textContent = model.step;
            document.getElementById('active-count').textContent = model.active_stakers;
            document.getElementById('total-count').textContent = model.num_stakers;
            document.getElementById('avg-sat').textContent = model.avg_satisfaction.toFixed(2);

            document.getElementById('total-staked').textContent = formatNumber(model.total_staked);
            document.getElementById('total-credits').textContent = formatNumber(model.total_credits);
            document.getElementById('total-burned').textContent = formatNumber(model.total_burned);
            document.getElementById('credit-rate').textContent = formatNumber(model.credit_generation_rate);
            document.getElementById('deployment-rate').textContent = formatNumber(model.deployment_rate);
            document.getElementById('churned-count').textContent = model.churned_stakers;
            document.getElementById('success-rate').textContent =
                model.completed_proposals + model.failed_proposals > 0
                    ? (model.success_rate_actual * 100).toFixed(0) + '%'
                    : '\u2014';

            // Tier distribution
            const dist = model.tier_distribution;
            const tierTotal = Object.values(dist).reduce((a, b) => a + b, 0) || 1;
            document.getElementById('tier-bar').innerHTML =
                '<div class="tier-segment tier-flexible" style="width:' + (dist.flexible / tierTotal * 100) + '%">' + dist.flexible + '</div>' +
                '<div class="tier-segment tier-3month" style="width:' + (dist['3_month'] / tierTotal * 100) + '%">' + dist['3_month'] + '</div>' +
                '<div class="tier-segment tier-6month" style="width:' + (dist['6_month'] / tierTotal * 100) + '%">' + dist['6_month'] + '</div>' +
                '<div class="tier-segment tier-12month" style="width:' + (dist['12_month'] / tierTotal * 100) + '%">' + dist['12_month'] + '</div>';

            // Archetype distribution bar
            const archDist = model.archetype_distribution || {};
            const archTotal = Object.values(archDist).reduce((a, b) => a + b, 0) || 1;
            document.getElementById('arch-bar').innerHTML =
                ['believer', 'yield_seeker', 'governance', 'speculator'].map(a => {
                    const n = archDist[a] || 0;
                    return '<div class="arch-segment arch-' + a + '" style="width:' + (n / archTotal * 100) + '%">' + n + '</div>';
                }).join('');

            // Archetype metrics
            const archMetrics = model.archetype_metrics || {};
            const archNames = { believer: 'Believer', yield_seeker: 'Yield Seeker', governance: 'Governance', speculator: 'Speculator' };
            document.getElementById('arch-metrics').innerHTML =
                ['believer', 'yield_seeker', 'governance', 'speculator'].map(a => {
                    const m = archMetrics[a];
                    if (!m) return '<div class="arch-metric-card ' + a + '"><div class="arch-card-name ' + a + '">' + archNames[a] + '</div><div class="arch-stat" style="color:var(--text-dim)">No agents</div></div>';
                    return '<div class="arch-metric-card ' + a + '">' +
                        '<div class="arch-card-name ' + a + '">' + archNames[a] + '</div>' +
                        '<div class="arch-stat"><span>Active</span><span class="arch-stat-val">' + m.active + '/' + m.total + '</span></div>' +
                        '<div class="arch-stat"><span>Avg Stake</span><span class="arch-stat-val">' + formatNumber(m.avg_stake) + '</span></div>' +
                        '<div class="arch-stat"><span>Satisfaction</span><span class="arch-stat-val" style="color:' + satColor(m.avg_satisfaction) + '">' + m.avg_satisfaction.toFixed(2) + '</span></div>' +
                        '<div class="arch-stat"><span>Deployed</span><span class="arch-stat-val">' + formatNumber(m.total_deployed) + '</span></div>' +
                        '<div class="arch-stat"><span>Burned</span><span class="arch-stat-val" style="color:var(--danger)">' + formatNumber(m.total_burned) + '</span></div>' +
                        '</div>';
                }).join('');

            // Events (with churn support)
            const eventsHtml = state.events.slice(0, 15).map(e =>
                '<div class="event">' +
                '<span class="event-step">[' + String(e.step).padStart(3, '0') + ']</span>' +
                '<span class="event-type ' + e.type + '">' + e.type + '</span>' +
                '<span>' + e.message + '</span>' +
                '</div>'
            ).join('');
            document.getElementById('events-list').innerHTML = eventsHtml || '<div class="event" style="color:var(--text-dim)">No events yet</div>';

            // Proposals
            const proposals = await fetchJson('/api/proposals');
            const proposalsHtml = proposals.slice(-8).reverse().map(p =>
                '<div class="list-item">' +
                '<span class="proposal-id">' + p.id + '</span>' +
                '<div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(p.funding_progress, 100) + '%"></div></div>' +
                '<span class="status status-' + p.status + '">' + p.status + '</span>' +
                '</div>'
            ).join('');
            document.getElementById('proposals-list').innerHTML = proposalsHtml || '<div class="list-item" style="color:var(--text-dim)">No proposals</div>';

            // Update chart history
            if (model.step > 0 && !historyData.steps.includes(model.step)) {
                historyData.steps.push(model.step);
                historyData.staked.push(model.total_staked);
                historyData.credits.push(model.total_credits);
                historyData.burned.push(model.total_burned);
                historyData.satisfaction.push(model.avg_satisfaction);
                historyData.active.push(model.active_stakers);
                updateChart();
            }

            // Update narrative and agents
            updateNarrative(model, state.events);
            await loadStakers();

            // Update canvas with staker data, proposals, and deployment arcs
            simCanvas.update(lastStakers, proposals, model.step_deployments || []);
        }

        function updateChart() {
            const ctx = document.getElementById('history-chart').getContext('2d');
            if (!chart) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Staked', data: historyData.staked, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                            { label: 'Credits', data: historyData.credits, borderColor: '#50c878', backgroundColor: 'rgba(80,200,120,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                            { label: 'Burned', data: historyData.burned, borderColor: '#e05555', backgroundColor: 'rgba(224,85,85,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#888', font: { size: 10, family: 'monospace' }, boxWidth: 12 }
                            }
                        },
                        scales: {
                            x: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: '#1a1a1a' } },
                            y: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: '#1a1a1a' } }
                        }
                    }
                });
            } else {
                chart.data.labels = historyData.steps;
                chart.data.datasets[0].data = historyData.staked;
                chart.data.datasets[1].data = historyData.credits;
                chart.data.datasets[2].data = historyData.burned;
                chart.update('none');
            }
        }

        async function step() {
            await fetchJson('/api/step', { method: 'POST' });
            await updateUI();
        }

        async function run(n) {
            await fetchJson('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: n })
            });
            const history = await fetchJson('/api/history');
            historyData.steps = history.Step || [];
            historyData.staked = history.Total_Staked || [];
            historyData.credits = history.Total_Credits || [];
            historyData.burned = history.Total_Burned || [];
            historyData.satisfaction = history.Avg_Satisfaction || [];
            historyData.active = history.Active_Stakers || [];
            updateChart();
            await updateUI();
        }

        async function resetWithParams() {
            const params = getSliderParams();
            await fetchJson('/api/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            historyData = { steps: [], staked: [], credits: [], burned: [], satisfaction: [], active: [] };
            if (chart) { chart.destroy(); chart = null; }
            simCanvas.reset();
            await updateUI();
        }

        async function loadDesignQuestions() {
            const questions = await fetchJson('/api/design-questions');
            const html = questions.map(q =>
                '<div class="question">' +
                '<div class="question-text">' + q.question + '</div>' +
                '<div class="question-current">Current: <span>' + q.current + '</span></div>' +
                '</div>'
            ).join('');
            document.getElementById('design-questions').innerHTML = html;
        }

        // Agent Inspector
        let currentAgentTab = 'top-stakers';
        let lastStakers = [];

        function showAgentTab(tab) {
            currentAgentTab = tab;
            document.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderAgentTab();
        }

        async function loadStakers() {
            lastStakers = await fetchJson('/api/stakers');
            renderAgentTab();
        }

        function renderAgentTab() {
            const container = document.getElementById('agent-content');
            if (!lastStakers.length) {
                container.innerHTML = '<div class="agent-placeholder">No stakers yet. Run the simulation.</div>';
                return;
            }

            if (currentAgentTab === 'top-stakers') {
                const sorted = [...lastStakers].filter(s => s.active).sort((a, b) => b.stake - a.stake).slice(0, 12);
                container.innerHTML =
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Stake</th><th>Tier</th><th>Credits</th><th>Deployed</th><th>Satisfaction</th>' +
                    '</tr></thead><tbody>' +
                    sorted.map(s =>
                        '<tr>' +
                        '<td class="agent-id">' + s.id + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td>' + formatNumber(s.stake) + '</td>' +
                        '<td><span class="tier-badge tier-' + s.tier_id + '">' + s.tier + '</span></td>' +
                        '<td>' + formatNumber(s.credits) + '</td>' +
                        '<td>' + formatNumber(s.total_deployed) + '</td>' +
                        '<td><div class="sat-bar"><div class="sat-fill" style="width:' + (s.satisfaction * 100) + '%;background:' + satColor(s.satisfaction) + '"></div></div>' + s.satisfaction.toFixed(2) + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>';

            } else if (currentAgentTab === 'recent-deployers') {
                const deployers = [...lastStakers].filter(s => s.total_deployed > 0).sort((a, b) => b.total_deployed - a.total_deployed).slice(0, 12);
                container.innerHTML = deployers.length ?
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Deployed</th><th>Burned</th><th>Net Position</th><th>Satisfaction</th>' +
                    '</tr></thead><tbody>' +
                    deployers.map(s =>
                        '<tr class="' + (s.active ? '' : 'churned') + '">' +
                        '<td class="agent-id">' + s.id + (s.active ? '' : ' [left]') + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td style="color:var(--success)">' + formatNumber(s.total_deployed) + '</td>' +
                        '<td style="color:var(--danger)">' + formatNumber(s.total_burned) + '</td>' +
                        '<td style="color:' + (s.stake > s.initial_stake ? 'var(--success)' : 'var(--danger)') + '">' +
                        (s.stake > s.initial_stake ? '+' : '') + formatNumber(s.stake - s.initial_stake) + '</td>' +
                        '<td>' + s.satisfaction.toFixed(2) + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>'
                    : '<div class="agent-placeholder">No deployments yet. Run more steps.</div>';

            } else if (currentAgentTab === 'by-archetype') {
                const archetypes = ['believer', 'yield_seeker', 'governance', 'speculator'];
                const archNames = { believer: 'Believer', yield_seeker: 'Yield Seeker', governance: 'Governance', speculator: 'Speculator' };
                const rows = archetypes.map(a => {
                    const group = lastStakers.filter(s => s.archetype === a);
                    const active = group.filter(s => s.active);
                    const totalStake = active.reduce((acc, s) => acc + s.stake, 0);
                    const totalDeployed = group.reduce((acc, s) => acc + s.total_deployed, 0);
                    const avgSat = active.length > 0 ? active.reduce((acc, s) => acc + s.satisfaction, 0) / active.length : 0;
                    const avgEng = active.length > 0 ? active.reduce((acc, s) => acc + s.engagement, 0) / active.length : 0;
                    return '<tr>' +
                        '<td><span class="arch-badge ' + a + '">' + archNames[a] + '</span></td>' +
                        '<td>' + active.length + '/' + group.length + '</td>' +
                        '<td>' + formatNumber(totalStake) + '</td>' +
                        '<td>' + formatNumber(totalDeployed) + '</td>' +
                        '<td style="color:' + satColor(avgSat) + '">' + avgSat.toFixed(2) + '</td>' +
                        '<td>' + avgEng.toFixed(2) + '</td>' +
                        '</tr>';
                });
                container.innerHTML =
                    '<table class="agent-table"><thead><tr>' +
                    '<th>Archetype</th><th>Active/Total</th><th>Total Stake</th><th>Total Deployed</th><th>Avg Satisfaction</th><th>Avg Engagement</th>' +
                    '</tr></thead><tbody>' + rows.join('') + '</tbody></table>';

            } else if (currentAgentTab === 'churned') {
                const churned = lastStakers.filter(s => !s.active);
                container.innerHTML = churned.length ?
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Final Stake</th><th>Tier</th><th>Total Deployed</th><th>Final Satisfaction</th><th>Idle Steps</th>' +
                    '</tr></thead><tbody>' +
                    churned.map(s =>
                        '<tr class="churned">' +
                        '<td class="agent-id">' + s.id + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td>' + formatNumber(s.stake) + '</td>' +
                        '<td><span class="tier-badge tier-' + s.tier_id + '">' + s.tier + '</span></td>' +
                        '<td>' + formatNumber(s.total_deployed) + '</td>' +
                        '<td style="color:var(--danger)">' + s.satisfaction.toFixed(2) + '</td>' +
                        '<td>' + s.idle_steps + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>'
                    : '<div class="agent-placeholder">No stakers have churned yet. Low satisfaction + expired locks = churn risk.</div>';
            }
        }

        // Round Narrative
        function generateNarrative(model, events) {
            const parts = [];
            const step = model.step;

            const stepEvents = events.filter(e => e.step === step);
            const funded = stepEvents.filter(e => e.type === 'funded').length;
            const completed = stepEvents.filter(e => e.type === 'completed').length;
            const failed = stepEvents.filter(e => e.type === 'failed').length;
            const newProposals = stepEvents.filter(e => e.type === 'new_proposal').length;
            const churned = stepEvents.filter(e => e.type === 'churn').length;

            const creditsGen = model.credit_generation_rate;
            const deployed = model.deployment_rate;
            const burned = model.burn_rate_per_step;

            parts.push('<p><strong>Week ' + step + ':</strong> <span class="narrative-highlight">' + model.active_stakers + ' active stakers</span> (' + model.churned_stakers + ' churned) earned credits. ' +
                'Generation: <span class="narrative-highlight">' + formatNumber(creditsGen) + ' credits</span>. ' +
                'Avg satisfaction: ' + model.avg_satisfaction.toFixed(2) + '.</p>');

            if (deployed > 0) {
                parts.push('<p><span class="narrative-success">' + formatNumber(deployed) + ' credits</span> deployed to proposals, ' +
                    'triggering <span class="narrative-danger">' + formatNumber(burned) + ' RSC burn</span>.</p>');
            }

            if (funded > 0) {
                parts.push('<p><span class="narrative-success">' + funded + ' proposal' + (funded > 1 ? 's' : '') + ' reached funding target!</span></p>');
            }

            if (completed > 0 || failed > 0) {
                const resolutions = [];
                if (completed > 0) resolutions.push('<span class="narrative-success">' + completed + ' completed</span>');
                if (failed > 0) resolutions.push('<span class="narrative-danger">' + failed + ' failed</span>');
                parts.push('<p>Proposals resolved: ' + resolutions.join(', ') + '.</p>');
            }

            if (churned > 0) {
                parts.push('<p><span class="narrative-danger">' + churned + ' staker' + (churned > 1 ? 's' : '') + ' left the system</span> (low satisfaction).</p>');
            }

            if (newProposals > 0) {
                parts.push('<p><span class="narrative-highlight">' + newProposals + ' new proposal' + (newProposals > 1 ? 's' : '') + '</span> entered the queue.</p>');
            }

            return parts.join('') || '<p class="narrative-placeholder">No significant activity this week.</p>';
        }

        function updateNarrative(model, events) {
            document.getElementById('round-narrative').innerHTML = generateNarrative(model, events);
        }

        // Toggle Education
        function toggleEducation() {
            const content = document.getElementById('education-content');
            const toggle = document.getElementById('edu-toggle');
            content.classList.toggle('collapsed');
            toggle.innerHTML = content.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
        }

        // Init
        updateUI();
        loadDesignQuestions();
        updateArchMixPreview();
    </script>
</body>
</html>
