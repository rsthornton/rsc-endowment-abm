<!--
  RSC Decentralized Endowment ABM — Single-page dashboard
  All CSS, HTML, and JS in one file for deployment simplicity.

  TABLE OF CONTENTS
  =================
  CSS
    Line ~10    Styles — sidebar, main area, grid, charts, modals
    Line ~40    Sidebar styles
    Line ~260   Main area styles

  HTML
    Line ~800   Sidebar — controls, parameters, archetype mix, tiers, advanced, scenarios
    Line ~1060  Main area — KPIs, tabs (Agent Field, Time Series, Proposals, Inspector)

  JAVASCRIPT
    Line ~1170  DotGrid class — agent field canvas rendering
    Line ~1310  State & API constants
    Line ~1340  Tab system
    Line ~1370  Archetype linked sliders (sum-to-100%)
    Line ~1460  getSliderParams / resetSliders
    Line ~1520  Main UI update loop
    Line ~1700  Chart system (Chart.js)
    Line ~1785  Actions — step(), run(), resetWithParams()
    Line ~1845  Scenarios — save, compare, modal
    Line ~1985  Design questions loader
    Line ~2000  Agent Inspector — tabs, detail panel
    Line ~2110  Narrative generation (weekly activity log)
    Line ~2160  Post-run summary with archetype cards
    Line ~2325  Init
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSC Endowment ABM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-alt: #0d0d0d;
            --bg-panel: #0f0f0f;
            --bg-card: #111;
            --bg-hover: #151515;
            --border: #1a1a1a;
            --border-light: #2a2a2a;
            --text: #d0d0d0;
            --text-muted: #888;
            --text-dim: #555;
            --accent: #c9a227;
            --success: #50c878;
            --danger: #e05555;
            --info: #4a9eff;
            --purple: #7856ff;
        }

        [data-theme="light"] {
            --bg: #f5f5f5;
            --bg-alt: #efefef;
            --bg-panel: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #e8e8e8;
            --border: #ddd;
            --border-light: #ccc;
            --text: #1a1a1a;
            --text-muted: #666;
            --text-dim: #999;
            --accent: #b8911e;
            --success: #2d8f50;
            --danger: #c43c3c;
            --info: #2a7de0;
            --purple: #5e3fd4;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-width: 1200px;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: 320px;
            min-width: 320px;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg-alt);
            border-right: 1px solid var(--border);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .sidebar-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }
        .sidebar-header h1 {
            color: var(--accent);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .sidebar-header .subtitle {
            color: var(--text-muted);
            font-size: 10px;
            line-height: 1.4;
        }

        /* Controls */
        .controls {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        button {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            transition: all 0.15s;
        }
        button:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
            color: var(--accent);
        }
        button.primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }
        button.primary:hover { background: #d4ad32; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-badges {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        .step-badge {
            background: var(--bg-panel);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-size: 10px;
            color: var(--text-muted);
        }
        .step-badge span { color: var(--accent); font-weight: 600; }

        /* Sidebar Sections */
        .sidebar-section {
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
        }
        .sidebar-section-header {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .sidebar-section-header:hover { color: var(--text); }
        .sidebar-section-header .toggle { font-size: 8px; color: var(--text-dim); }
        .sidebar-section-body { padding: 12px; }
        .sidebar-section-body.collapsed { display: none; }

        /* Param Sliders (sidebar = single column) */
        .param-sliders {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        .slider-label { color: var(--text-muted); }
        .slider-value { color: var(--accent); font-weight: 600; font-family: monospace; }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .slider-hint {
            font-size: 9px;
            color: var(--text-dim);
        }

        /* Archetype bar */
        .archetype-bar {
            display: flex; height: 20px; border-radius: 4px; overflow: hidden;
            margin-bottom: 8px; border: 1px solid var(--border);
        }
        .arch-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 600; color: #000;
            transition: width 0.3s;
        }
        .arch-believer { background: var(--success); }
        .arch-yield_seeker { background: var(--accent); }
        .arch-governance, .arch-institution { background: var(--purple); }
        .arch-speculator { background: var(--danger); }

        .arch-legend { display: flex; gap: 8px; flex-wrap: wrap; font-size: 10px; margin-bottom: 8px; }
        .arch-legend-item { display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
        .arch-dot { width: 6px; height: 6px; border-radius: 2px; }

        .apply-params {
            margin-top: 8px;
            width: 100%;
        }
        .btn-row { display: flex; gap: 6px; margin-top: 8px; }
        .btn-row button { flex: 1; }

        /* Design Lab */
        .design-toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; font-size: 11px;
        }
        .design-toggle-row label { color: var(--text-muted); cursor: pointer; }
        .design-hint { font-size: 9px; color: var(--text-dim); margin-bottom: 8px; }
        select {
            background: var(--bg-panel);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            width: 100%;
        }
        input[type="checkbox"] {
            accent-color: var(--accent);
        }

        /* Education (sidebar collapsible) */
        .edu-section {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
        }
        .edu-section:last-child { border-bottom: none; }
        .edu-section h3 {
            font-size: 11px;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .edu-section p, .edu-section li {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .edu-section ul, .edu-section ol {
            margin-left: 16px;
            margin-top: 4px;
        }
        .edu-section li { margin-bottom: 2px; }
        .edu-section strong { color: var(--text); }

        /* Design Questions in sidebar */
        .question {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .question:last-child { border-bottom: none; }
        .question-text { font-size: 11px; color: var(--text); margin-bottom: 4px; }
        .question-current {
            font-size: 10px;
            color: var(--text-dim);
        }
        .question-current span { color: var(--accent); }

        /* ==================== MAIN AREA ==================== */
        .main {
            flex: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Pinned Metrics Bar */
        .metrics-bar {
            display: flex;
            gap: 2px;
            padding: 8px 16px;
            background: var(--bg-alt);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .metric {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            background: var(--bg-panel);
            border-radius: 4px;
            position: relative;
            cursor: help;
            transition: transform 0.15s;
        }
        .metric.pulse {
            animation: metric-pulse 0.3s ease-out;
        }
        @keyframes metric-pulse {
            0% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'SF Mono', monospace;
            transition: color 0.4s ease;
        }
        .metric-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .metric[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            color: var(--text);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 100;
            border: 1px solid var(--border-light);
            margin-bottom: 4px;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            gap: 0;
            background: var(--bg-alt);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            flex-shrink: 0;
        }
        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            padding: 10px 16px;
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .tab-btn:hover {
            color: var(--text);
            background: transparent;
            border-color: transparent;
        }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: transparent;
        }

        /* Tab Content Area */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .tab-pane { display: none; height: 100%; }
        .tab-pane.active { display: flex; flex-direction: column; gap: 16px; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .card-header {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Sim Canvas */
        .sim-canvas-wrap {
            position: relative;
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
            background: #080808;
            flex: 1;
            min-height: 400px;
        }
        .agent-grid {
            display: grid;
            gap: 3px;
            padding: 24px;
            width: 100%;
            height: 100%;
            align-content: center;
            justify-content: center;
        }
        .agent-cell {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.4s, box-shadow 0.4s;
        }
        .agent-cell:hover {
            outline: 1.5px solid rgba(255,255,255,0.8);
            outline-offset: 1px;
            z-index: 1;
        }
        .agent-cell.churned {
            opacity: 0.06 !important;
            cursor: default;
        }
        .agent-cell.deploy-flash {
            animation: cell-flash 0.5s ease-out;
        }
        @keyframes cell-flash {
            0% { box-shadow: inset 0 0 14px rgba(255,255,255,0.8), 0 0 6px rgba(255,255,255,0.4); }
            100% { box-shadow: none; }
        }
        /* Canvas tooltip */
        .canvas-tooltip {
            display: none;
            position: absolute;
            background: rgba(20,20,20,0.95);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 10px;
            pointer-events: none;
            z-index: 50;
            max-width: 200px;
            line-height: 1.5;
        }
        .canvas-tooltip .tt-id { color: var(--accent); font-weight: 600; }
        .canvas-tooltip .tt-label { color: var(--text-muted); }
        .canvas-tooltip .tt-val { color: var(--text); }
        /* Canvas legend */
        .canvas-legend {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10,10,10,0.85);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 14px;
            font-size: 10px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            z-index: 40;
            white-space: nowrap;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-divider { width: 1px; height: 14px; background: var(--border); margin: 0; }
        .legend-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .legend-encoding { color: var(--text-dim); font-size: 9px; }

        /* Chart views */
        .chart-view-switcher {
            display: flex;
            gap: 0;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .chart-view-btn {
            background: transparent;
            border: none;
            border-right: 1px solid var(--border-light);
            color: var(--text-muted);
            padding: 6px 12px;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
        }
        .chart-view-btn:last-child { border-right: none; }
        .chart-view-btn:hover { color: var(--text); }
        .chart-view-btn.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }
        .chart-container { height: 280px; }

        /* Tier bars */
        .tier-bar {
            display: flex; height: 24px; border-radius: 4px; overflow: hidden;
            margin-bottom: 12px; border: 1px solid var(--border);
        }
        .tier-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 600; color: #000;
        }
        .tier-flexible { background: #536471; }
        .tier-3month { background: #4a9eff; }
        .tier-6month { background: #7856ff; }
        .tier-12month { background: var(--accent); }
        .tier-legend { display: flex; gap: 12px; flex-wrap: wrap; font-size: 11px; }
        .tier-legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .tier-dot { width: 8px; height: 8px; border-radius: 2px; }

        /* Proposals list */
        .list { max-height: 400px; overflow-y: auto; }
        .list-item {
            background: var(--bg-panel);
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .list-item:last-child { margin-bottom: 0; }
        .proposal-id { font-weight: 600; color: var(--text); font-family: monospace; }
        .progress-bar {
            width: 80px; height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            margin: 0 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .progress-fill { height: 100%; background: var(--success); border-radius: 2px; }
        .progress-pct { font-size: 10px; color: var(--text-dim); min-width: 32px; text-align: right; }
        .status { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-open { color: var(--info); }
        .status-funded { color: var(--success); }
        .status-completed { color: var(--success); }
        .status-failed { color: var(--danger); }

        /* Events */
        .event {
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }
        .event:last-child { border-bottom: none; }
        .event-step {
            color: var(--text-dim);
            font-family: monospace;
            margin-right: 8px;
        }
        .event-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }
        .event-type.funded { background: rgba(80,200,120,0.2); color: var(--success); }
        .event-type.completed { background: rgba(80,200,120,0.2); color: var(--success); }
        .event-type.failed { background: rgba(224,85,85,0.2); color: var(--danger); }
        .event-type.new_proposal { background: rgba(74,158,255,0.2); color: var(--info); }
        .event-type.init { background: rgba(201,162,39,0.2); color: var(--accent); }
        .event-type.churn { background: rgba(224,85,85,0.15); color: #c07070; }

        /* Archetype metrics grid */
        .arch-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            font-size: 11px;
        }
        @media (max-width: 1600px) {
            .arch-metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .arch-metric-card {
            background: var(--bg-panel);
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid var(--border-light);
        }
        .arch-metric-card.believer { border-left-color: var(--success); }
        .arch-metric-card.yield_seeker { border-left-color: var(--accent); }
        .arch-metric-card.governance, .arch-metric-card.institution { border-left-color: var(--purple); }
        .arch-metric-card.speculator { border-left-color: var(--danger); }
        .arch-card-name {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .arch-card-name.believer { color: var(--success); }
        .arch-card-name.yield_seeker { color: var(--accent); }
        .arch-card-name.governance, .arch-card-name.institution { color: var(--purple); }
        .arch-card-name.speculator { color: var(--danger); }
        .arch-stat { display: flex; justify-content: space-between; color: var(--text-muted); padding: 2px 0; }
        .arch-stat-val { color: var(--text); font-family: monospace; }

        /* Narrative */
        .narrative { font-size: 13px; line-height: 1.7; }
        .narrative-placeholder { color: var(--text-dim); font-style: italic; }
        .narrative-highlight { color: var(--accent); font-weight: 600; }
        .narrative-success { color: var(--success); }
        .narrative-danger { color: var(--danger); }
        .narrative p { margin-bottom: 8px; }
        .narrative p:last-child { margin-bottom: 0; }

        /* Agent Inspector */
        .agent-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .agent-tab {
            background: transparent;
            border: 1px solid var(--border);
            padding: 5px 10px;
            font-size: 10px;
        }
        .agent-tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        .agent-content { min-height: 120px; }
        .agent-placeholder { color: var(--text-dim); font-style: italic; font-size: 12px; }
        .agent-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        .agent-table th {
            text-align: left;
            padding: 8px;
            background: var(--bg-panel);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
        }
        .agent-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .agent-table tr:hover { background: var(--bg-hover); }
        .agent-table tr.churned { opacity: 0.5; }
        .agent-table tr.highlighted { background: rgba(201,162,39,0.1); outline: 1px solid var(--accent); }
        .agent-id { font-family: monospace; color: var(--accent); font-weight: 600; cursor: pointer; }
        .tier-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .tier-flexible { background: rgba(83,100,113,0.3); color: #536471; }
        .tier-3_month { background: rgba(74,158,255,0.2); color: #4a9eff; }
        .tier-6_month { background: rgba(120,86,255,0.2); color: #7856ff; }
        .tier-12_month { background: rgba(201,162,39,0.2); color: var(--accent); }
        .arch-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .arch-badge.believer { background: rgba(80,200,120,0.2); color: var(--success); }
        .arch-badge.yield_seeker { background: rgba(201,162,39,0.2); color: var(--accent); }
        .arch-badge.governance, .arch-badge.institution { background: rgba(120,86,255,0.2); color: var(--purple); }
        .arch-badge.speculator { background: rgba(224,85,85,0.2); color: var(--danger); }
        .sat-bar {
            width: 40px; height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }
        .sat-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Scenario Compare */
        .scenario-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        .scenario-table th, .scenario-table td {
            padding: 6px 10px;
            border: 1px solid var(--border);
            text-align: right;
        }
        .scenario-table th {
            background: var(--bg-panel);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .scenario-table th:first-child, .scenario-table td:first-child { text-align: left; }
        .scenario-name-input {
            background: var(--bg-panel);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            width: 100%;
        }

        /* Summary panel */
        .summary-panel {
            background: var(--bg-panel);
            border-radius: 6px;
            padding: 16px;
            border-left: 3px solid var(--accent);
        }
        .summary-delta {
            display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px;
        }
        .delta-label { color: var(--text-muted); }
        .delta-pos { color: var(--success); }
        .delta-neg { color: var(--danger); }
        .tension-warning {
            margin-top: 8px; padding: 8px;
            background: rgba(224,85,85,0.1);
            border-radius: 4px;
            border: 1px solid rgba(224,85,85,0.3);
            font-size: 11px;
            color: var(--danger);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* Two-column layout inside tabs */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .three-col { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; }
        @media (max-width: 1400px) {
            .two-col, .three-col { grid-template-columns: 1fr; }
        }

        /* Scenario comparison modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-body {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0 4px;
        }
        .modal-close:hover { color: var(--text); }

        /* Metrics detail toggle */
        .detail-toggle {
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        .detail-toggle:hover { color: var(--text); }

        /* Light mode overrides for hardcoded values */
        [data-theme="light"] [data-tooltip]:hover::after { background: #fff; border-color: #ccc; }
        [data-theme="light"] .sim-canvas-wrap { background: #e8e8e8; }
        [data-theme="light"] .modal-overlay { background: rgba(0,0,0,0.3); }
        [data-theme="light"] button.primary { color: #fff; }
        [data-theme="light"] button.primary:hover { background: #a67d14; }
        [data-theme="light"] .agent-cell:hover { outline-color: rgba(0,0,0,0.6); }
        [data-theme="light"] .deploy-flash {
            box-shadow: inset 0 0 14px rgba(0,0,0,0.4), 0 0 6px rgba(0,0,0,0.2);
        }
        [data-theme="light"] .status-badges .step-badge { color: var(--text); }
        [data-theme="light"] .tab-btn.active { border-bottom-color: var(--accent); color: var(--text); }
        [data-theme="light"] .sidebar-section-header { color: var(--text); }
        [data-theme="light"] .event-type.churn { background: rgba(196,60,60,0.1); color: #a03030; }
        [data-theme="light"] .slider-hint { color: var(--text-dim); }
        [data-theme="light"] input[type="range"] { accent-color: var(--accent); }
        [data-theme="light"] .canvas-legend { background: rgba(255,255,255,0.9); }
        [data-theme="light"] .legend-encoding { color: var(--text-dim); }

        /* Theme toggle */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            line-height: 1;
        }
        .theme-toggle:hover { color: var(--text); border-color: var(--accent); }
    </style>
</head>
<body>
    <!-- ==================== SIDEBAR ==================== -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>RSC ENDOWMENT SIMULATOR</h1>
            <div class="subtitle">Model how $1M RSC earns yield and funds science — before you commit.</div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="primary" onclick="runToEquilibrium()" style="flex:1 1 100%" title="Run 4 years — self-balancing stabilizes around week 100-150">&#9654; Run to Equilibrium</button>
            <div class="slider-label" style="width:100%;font-size:10px;color:var(--text-dim);margin-top:2px">Manual controls:</div>
            <button onclick="run(52)">1 Year</button>
            <button onclick="run(10)">10 Wk</button>
            <button onclick="step()">Step</button>
            <button onclick="resetWithParams()">Reset</button>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" style="margin-top:4px;width:100%">Light</button>
        </div>

        <!-- Status Badges -->
        <div class="status-badges">
            <div class="step-badge">Week <span id="step-count">0</span></div>
            <div class="step-badge">Yr <span id="year-display">0.0</span></div>
            <div class="step-badge">Active <span id="active-count">0</span> / <span id="total-count">0</span></div>
            <div class="step-badge" style="color:var(--success);border-color:var(--success)" title="Agent RSC calibrated to RH yield CSV: 30% participation = 40.2M RSC held">&#10003; CSV Grounded</div>
        </div>

        <!-- Parameters -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Parameters <span class="toggle">&#9660;</span>
            </div>
            <div class="sidebar-section-body">
                <div class="param-sliders">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Initial Participation</span>
                            <span class="slider-value" id="val-participation">30%</span>
                        </div>
                        <input type="range" id="slider-participation" min="5" max="80" value="30" step="5"
                            oninput="document.getElementById('val-participation').textContent=this.value+'%'">
                        <div class="slider-hint">% of circulating RSC (134.2M) held in RH at start. 15% → high yield; 70% → diluted yield. Market self-corrects from here.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Yield Threshold</span>
                            <span class="slider-value" id="val-threshold">8%</span>
                        </div>
                        <input type="range" id="slider-threshold" min="2" max="30" value="8" step="1"
                            oninput="document.getElementById('val-threshold').textContent=this.value+'%'">
                        <div class="slider-hint">Average APY below which agents consider exiting. Higher = agents require better yield; lower participation equilibrium.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Deploy Rate</span>
                            <span class="slider-value" id="val-deploy">30%</span>
                        </div>
                        <input type="range" id="slider-deploy" min="0" max="100" value="30" step="5"
                            oninput="document.getElementById('val-deploy').textContent=this.value+'%'">
                        <div class="slider-hint">How actively holders fund proposals with their credits. Low = credits pile up. High = credits flow to research.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Proposal Success</span>
                            <span class="slider-value" id="val-success">80%</span>
                        </div>
                        <input type="range" id="slider-success" min="20" max="100" value="80" step="5"
                            oninput="document.getElementById('val-success').textContent=this.value+'%'">
                        <div class="slider-hint">How often funded research delivers results. Affects credit deployment behavior.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Holders</span>
                            <span class="slider-value" id="val-holders">100</span>
                        </div>
                        <input type="range" id="slider-holders" min="20" max="500" value="100" step="10"
                            oninput="document.getElementById('val-holders').textContent=this.value">
                        <div class="slider-hint">Initial number of RSC holders in the simulation.</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="primary" onclick="resetWithParams()">Apply & Reset</button>
                    <button onclick="resetSliders()">Defaults</button>
                </div>
            </div>
        </div>

        <!-- Archetype Mix -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Archetype Mix <span class="toggle">&#9660;</span>
            </div>
            <div class="sidebar-section-body">
                <div class="archetype-bar" id="arch-bar"></div>
                <div class="arch-legend">
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--success)"></div> Believer</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--accent)"></div> Yield</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--purple)"></div> Inst</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--danger)"></div> Spec</div>
                </div>
                <div class="param-sliders">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--success)">Believers</span>
                            <span class="slider-value" id="val-believer">25%</span>
                        </div>
                        <input type="range" id="slider-believer" min="5" max="85" value="25" step="5"
                            oninput="handleArchSliderChange('believer')">
                        <div class="slider-hint">Mission-driven. Hold long-term (1.2x), deploy reliably, stay through low yields.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--accent)">Return-Sensitive Holders</span>
                            <span class="slider-value" id="val-yield_seeker">35%</span>
                        </div>
                        <input type="range" id="slider-yield_seeker" min="5" max="85" value="35" step="5"
                            oninput="handleArchSliderChange('yield_seeker')">
                        <div class="slider-hint">Return-focused. Join when APY is high, exit when it falls. The self-balancing force.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--purple)">Institutions</span>
                            <span class="slider-value" id="val-institution">15%</span>
                        </div>
                        <input type="range" id="slider-institution" min="5" max="85" value="15" step="5"
                            oninput="handleArchSliderChange('institution')">
                        <div class="slider-hint">Universities/foundations. Large RSC, very long-term, near-zero sensitivity. Anchors participation. &rarr; This models universities and foundations — RH's primary pitch target.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--danger)">Speculators</span>
                            <span class="slider-value" id="val-speculator">25%</span>
                        </div>
                        <input type="range" id="slider-speculator" min="5" max="85" value="25" step="5"
                            oninput="handleArchSliderChange('speculator')">
                        <div class="slider-hint">Short-term. Enter on high yield, exit quickly. Amplifies participation swings.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Advanced <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed">
                <div class="slider-group" style="margin-bottom:12px">
                    <div class="slider-header">
                        <span class="slider-label">Burn Rate</span>
                        <span class="slider-value" id="val-burn">2%</span>
                    </div>
                    <input type="range" id="slider-burn" min="0.5" max="10" value="2" step="0.5"
                        oninput="document.getElementById('val-burn').textContent=this.value+'%'">
                    <div class="slider-hint">Fee burned when credits are deployed to proposals. Higher burn = more RSC removed from supply.</div>
                </div>
                <div class="design-toggle-row">
                    <label><input type="checkbox" id="chk-credit-expiry" onchange="updateDesignLabState()"> Credit Expiry</label>
                </div>
                <div id="credit-expiry-controls" style="display:none">
                    <div class="slider-group" style="margin-bottom:8px">
                        <div class="slider-header">
                            <span class="slider-label">Expiry Period</span>
                            <span class="slider-value" id="val-expiry-weeks">8 wk</span>
                        </div>
                        <input type="range" id="slider-expiry-weeks" min="4" max="16" value="8" step="1"
                            oninput="document.getElementById('val-expiry-weeks').textContent=this.value+' wk'">
                    </div>
                    <div class="design-hint">Unused credits expire, creating deployment urgency. Oldest credits consumed first (FIFO).</div>
                </div>

                <div class="design-toggle-row">
                    <label>Failure Mode</label>
                </div>
                <select id="select-failure-mode" onchange="updateFailureModeHint()">
                    <option value="nothing">Nothing (credits consumed)</option>
                    <option value="partial_refund">Partial Refund (50% credits back)</option>
                </select>
                <div class="design-hint" id="failure-mode-hint">Backers lose their deployed credits but RSC held is unaffected. Simple but may frustrate mission-aligned holders.</div>

                <div class="design-hint" style="margin-top:8px">No minimum holding requirement — RSC in RH account auto-earns regardless of amount.</div>
            </div>
        </div>

        <!-- Quick Scenarios -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Quick Scenarios <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed">
                <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px">
                    <button onclick="loadScenario(0.15, 0.04)" style="text-align:left;font-size:11px">Conservative (15%) &rarr; ~47% APY</button>
                    <button onclick="loadScenario(0.30, 0.08)" style="text-align:left;font-size:11px">Expected (30%) &rarr; ~24% APY</button>
                    <button onclick="loadScenario(0.70, 0.15)" style="text-align:left;font-size:11px">High (70%) &rarr; ~10% APY</button>
                </div>
                <div style="font-size:10px;color:var(--text-dim)">Sets sliders to matching CSV scenario and resets. <a href="#" style="color:var(--text-muted)" onclick="openScenarioModal();return false">Advanced &rarr;</a></div>
                <div id="saved-scenarios-list" style="display:none">No saved scenarios</div>
            </div>
        </div>

        <!-- Methodology -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Methodology <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed">
                <ul style="font-size:10px;line-height:1.8;color:var(--text-muted);padding-left:14px">
                    <li>Yield = your RSC &divide; total RSC held in RH &times; annual emission</li>
                    <li>Emission starts at 9.5M RSC/year at launch, halves every 64 years</li>
                    <li>High yield attracts holders &rarr; dilutes yield &rarr; market finds equilibrium</li>
                    <li>Holding 1+ year earns 1.2&times; more credits than new holders (no lockup required)</li>
                    <li>Calibrated to 134.2M circulating RSC at Year 0 (RH yield model CSV)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ==================== MAIN AREA ==================== -->
    <div class="main">
        <!-- Pinned Metrics Bar (4 KPIs) -->
        <div class="metrics-bar">
            <div class="metric" data-tooltip="% of circulating RSC currently held in RH. The key equilibrium metric.">
                <div class="metric-value" id="participation-rate" style="font-size:22px;color:var(--accent)">0%</div>
                <div class="metric-label">Participation Rate</div>
            </div>
            <div class="metric" data-tooltip="Current annualized yield rate (base 1.0x). Higher multipliers earn more.">
                <div class="metric-value" id="current-apy" style="font-size:22px;color:var(--success)">0%</div>
                <div class="metric-label">Current APY</div>
            </div>
            <div class="metric" data-tooltip="Holders who exited when APY fell below their yield threshold. Zero exits is a good signal.">
                <div class="metric-value" id="exited-count" style="font-size:22px;color:var(--text-muted)">0</div>
                <div class="metric-label">Holders Exited</div>
            </div>
            <div class="metric" data-tooltip="Which of RH's three CSV reference scenarios current participation is closest to.">
                <div class="metric-value" id="csv-scenario" style="font-size:14px;color:var(--success)">—</div>
                <div class="metric-label">CSV Scenario</div>
            </div>
        </div>

        <!-- Live Interpretation (shown after sim runs) -->
        <div id="rh-design-reading" style="display:none;padding:8px 16px;font-size:11.5px;line-height:1.6;border-bottom:1px solid var(--border);border-left:3px solid var(--accent);background:var(--bg-alt)"></div>

        <!-- Post-Run Summary (elevated above tabs) -->
        <div id="post-run-summary" style="display:none"></div>

        <!-- Tab Bar (3 tabs) -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="yield-dynamics">Yield Dynamics</button>
            <button class="tab-btn" data-tab="holder-activity">Holder Activity</button>
            <button class="tab-btn" data-tab="details">Details</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- TAB: Yield Dynamics (default) -->
            <div class="tab-pane active" id="tab-yield-dynamics">

                <!-- CSV Calibration context -->
                <div class="card" style="margin-bottom:12px;border-left:3px solid var(--accent)">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                        <span>Grounded in RH's Yield Model CSV</span>
                        <span style="font-size:10px;color:var(--success);font-weight:600">&#10003; Calibrated</span>
                    </div>
                    <div style="font-size:12px;line-height:1.7;color:var(--text-muted);padding:4px 0 2px">
                        &#10003; Calibrated to ResearchHub's published yield model (February 2026). Participation rates and APY match RH's own projections. Dashed lines = three CSV reference scenarios.
                    </div>
                </div>

                <div class="two-col">
                    <div class="card">
                        <div class="card-header">APY Over Time (vs. Reference Scenarios)</div>
                        <div class="chart-container">
                            <canvas id="apy-chart"></canvas>
                        </div>
                        <div class="slider-hint" style="padding:8px 0 0 0">
                            Dashed lines: RH CSV at 15% / 30% / 70% of 134.2M RSC.
                            <strong>Convergence toward a dashed line = equilibrium participation rate.</strong>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Participation Rate Over Time</div>
                        <div class="chart-container">
                            <canvas id="participation-chart"></canvas>
                        </div>
                        <div class="slider-hint" style="padding:8px 0 0 0">
                            The market self-corrects. Too many holders &rarr; yield falls &rarr; some exit. Too few &rarr; yield rises &rarr; new holders enter. Convergence into the green zone = healthy equilibrium.
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top:12px">
                    <div class="card-header">Time-Weight Distribution &amp; RSC by Holder Type</div>
                    <div class="two-col" style="gap:12px">
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Multiplier tier distribution (by holder count)</div>
                            <div id="multiplier-detail-bar" style="display:flex;gap:4px;margin-bottom:6px"></div>
                            <div id="multiplier-detail-legend" style="font-size:10px;color:var(--text-muted)"></div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">RSC held by archetype</div>
                            <div id="rsc-by-archetype" style="font-size:11px;line-height:1.8"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Holder Activity -->
            <div class="tab-pane" id="tab-holder-activity">
                <div style="padding:6px 0 8px;font-size:11px;color:var(--text-muted);line-height:1.6">
                    Each square = one holder. Color = type. Bright = holding 1+ year (1.2&times; yield). Glow = credits building up. Click any square to inspect.
                </div>
                <div class="sim-canvas-wrap">
                    <div id="agent-grid" class="agent-grid"></div>
                    <div class="canvas-tooltip" id="canvas-tooltip"></div>
                    <div class="canvas-legend">
                        <div class="legend-item"><div class="legend-dot" style="background:var(--success)"></div> Believer</div>
                        <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> Return-Sensitive</div>
                        <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div> Institution</div>
                        <div class="legend-item"><div class="legend-dot" style="background:var(--danger)"></div> Speculator</div>
                        <div class="legend-divider"></div>
                        <span class="legend-encoding">Opacity=Hold Duration</span>
                        <span class="legend-encoding">Glow=Credit Pressure</span>
                    </div>
                </div>
                <div class="card" style="margin-top:12px">
                    <div class="card-header">Archetype Behavior</div>
                    <div class="arch-metrics-grid" id="arch-metrics"></div>
                </div>
                <div class="card" style="margin-top:12px">
                    <div class="agent-tabs">
                        <button class="agent-tab active" onclick="showAgentTab('top-stakers', this)">Top Holders</button>
                        <button class="agent-tab" onclick="showAgentTab('recent-deployers', this)">Deployers</button>
                        <button class="agent-tab" onclick="showAgentTab('by-archetype', this)">By Archetype</button>
                        <button class="agent-tab" onclick="showAgentTab('churned', this)">Exited</button>
                    </div>
                    <div id="agent-content" class="agent-content" style="max-height:400px;overflow-y:auto;">
                        <div class="agent-placeholder">Run the simulation to inspect holders.</div>
                    </div>
                </div>
            </div>

            <!-- TAB: Details -->
            <div class="tab-pane" id="tab-details">
                <div class="card">
                    <div class="card-header">Time Series</div>
                    <div class="chart-view-switcher">
                        <button class="chart-view-btn active" data-view="token-economics" onclick="switchChartView('token-economics')">Token Economics</button>
                        <button class="chart-view-btn" data-view="agent-health" onclick="switchChartView('agent-health')">Agent Health</button>
                        <button class="chart-view-btn" data-view="funding-flow" onclick="switchChartView('funding-flow')">Funding Flow</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="history-chart"></canvas>
                    </div>
                </div>
                <div class="two-col" style="margin-top:12px">
                    <div class="card">
                        <div class="card-header">Proposals</div>
                        <div class="list" id="proposals-list"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Event Log</div>
                        <div class="list" id="events-list" style="max-height: 400px;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Scenario Comparison Modal -->
    <div class="modal-overlay" id="scenario-modal">
        <div class="modal-body">
            <div class="modal-header">
                <div class="card-header" style="margin:0;padding:0;border:0">Scenario Comparison</div>
                <button class="modal-close" onclick="closeScenarioModal()">&times;</button>
            </div>
            <div id="scenario-compare-content">
                <p style="color:var(--text-dim);font-size:12px;">Save scenarios from the sidebar to compare them here. Run a simulation, then click "Save Current Scenario".</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DotGrid -- GitHub-heatmap-style agent field
        // ============================================
        class DotGrid {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.cells = [];
                this.archColors = {
                    believer:     '#50c878',
                    yield_seeker: '#c9a227',
                    institution:  '#7856ff',
                    speculator:   '#e05555',
                };
            }

            update(stakers, stepDeployments) {
                // Sort: group by archetype, then by RSC within group
                const archOrder = ['believer', 'yield_seeker', 'institution', 'speculator'];
                const sorted = [...stakers].sort((a, b) => {
                    const ai = archOrder.indexOf(a.archetype);
                    const bi = archOrder.indexOf(b.archetype);
                    if (ai !== bi) return ai - bi;
                    return b.stake - a.stake;
                });

                // Deployer set for flash
                const deployerIds = new Set();
                if (stepDeployments) {
                    stepDeployments.forEach(d => deployerIds.add(d.staker_id));
                }

                // Compute grid columns
                const cols = Math.ceil(Math.sqrt(sorted.length));
                this.container.style.gridTemplateColumns = 'repeat(' + cols + ', 28px)';

                // Rebuild cells if count changed
                if (this.cells.length !== sorted.length) {
                    this.container.innerHTML = '';
                    this.cells = [];
                    sorted.forEach(() => {
                        const cell = document.createElement('div');
                        cell.className = 'agent-cell';
                        this._attachEvents(cell);
                        this.container.appendChild(cell);
                        this.cells.push(cell);
                    });
                }

                // Update each cell
                sorted.forEach((s, i) => {
                    const cell = this.cells[i];
                    cell._staker = s;
                    this._updateCell(cell, s, deployerIds.has(s.id));
                });
            }

            _updateCell(cell, s, hasDeployment) {
                const color = this.archColors[s.archetype] || '#888';

                if (!s.active) {
                    cell.style.backgroundColor = color;
                    cell.style.opacity = '0.06';
                    cell.style.boxShadow = 'none';
                    cell.className = 'agent-cell churned';
                    return;
                }

                cell.className = 'agent-cell';
                cell.style.backgroundColor = color;
                // Opacity encodes holding duration: New(dim) -> LongTerm(bright)
                const holdAlpha = s.multiplier_label === 'LongTerm' ? 0.95 : s.multiplier_label === 'Holder' ? 0.65 : 0.35;
                cell.style.opacity = holdAlpha.toFixed(2);

                // Credit pressure = inner white glow
                const pressure = s.credits_pressure || 0;
                if (pressure > 0.2) {
                    const glowSize = 3 + pressure * 4;
                    const glowAlpha = Math.min(pressure * 0.35, 0.7);
                    const glowColor = isLightMode() ? '0,0,0' : '255,255,255';
                    cell.style.boxShadow = 'inset 0 0 ' + glowSize.toFixed(0) + 'px rgba(' + glowColor + ',' + glowAlpha.toFixed(2) + ')';
                } else {
                    cell.style.boxShadow = 'none';
                }

                // Deployment flash via CSS animation
                if (hasDeployment) {
                    cell.classList.remove('deploy-flash');
                    void cell.offsetWidth;
                    cell.classList.add('deploy-flash');
                }
            }

            _attachEvents(cell) {
                cell.addEventListener('mouseenter', () => {
                    const s = cell._staker;
                    if (!s) return;
                    const tooltip = document.getElementById('canvas-tooltip');
                    tooltip.innerHTML =
                        '<div><span class="tt-id">' + s.id + '</span> <span class="tt-label">(' + s.archetype + ')</span></div>' +
                        '<div><span class="tt-label">RSC:</span> <span class="tt-val">' + formatNumber(s.rsc_held || s.stake || 0) + '</span></div>' +
                        '<div><span class="tt-label">Hold:</span> <span class="tt-val">' + (s.weeks_held || 0) + 'wk (' + (s.multiplier_label || 'New') + ' ' + (s.multiplier || 1).toFixed(2) + 'x)</span></div>' +
                        '<div><span class="tt-label">Credits:</span> <span class="tt-val">' + formatNumber(s.credits) + '</span></div>' +
                        '<div><span class="tt-label">Threshold:</span> <span class="tt-val">' + ((s.yield_threshold || 0) * 100).toFixed(1) + '%</span></div>' +
                        '<div><span class="tt-label">Deployed:</span> <span class="tt-val">' + formatNumber(s.total_deployed) + '</span></div>';
                    tooltip.style.display = 'block';
                    const rect = cell.getBoundingClientRect();
                    const wrapRect = cell.closest('.sim-canvas-wrap').getBoundingClientRect();
                    tooltip.style.left = Math.min(rect.right - wrapRect.left + 8, wrapRect.width - 220) + 'px';
                    tooltip.style.top = (rect.top - wrapRect.top) + 'px';
                });

                cell.addEventListener('mouseleave', () => {
                    document.getElementById('canvas-tooltip').style.display = 'none';
                });

                cell.addEventListener('click', () => {
                    const s = cell._staker;
                    if (s) {
                        switchTab('holder-activity');
                        highlightedAgentId = s.id;
                        showAgentTab('top-stakers', document.querySelector('.agent-tab'));
                    }
                });
            }

            reset() {
                this.container.innerHTML = '';
                this.cells = [];
            }

            forceRedraw() {
                // CSS grid handles layout automatically
            }
        }

        const simCanvas = new DotGrid('agent-grid');

        // ============================================
        // State
        // ============================================
        const API = '';
        let chart = null;
        let currentChartView = 'token-economics';
        let historyData = {
            steps: [], years: [], participation: [], apy: [], rsc_held: [], active: [],
            rsc_believer: [], rsc_yield_seeker: [], rsc_institution: [], rsc_speculator: [],
            credits_generated_step: [], credits_deployed_step: [], exits_step: [], entries_step: [],
            // Reference scenario APYs from CSV (updated each step)
            apy_15pct: [], apy_30pct: [], apy_70pct: [],
        };
        let apyChart = null;
        let participationChart = null;
        let highlightedAgentId = null;
        let savedScenarios = [];
        let initialSnapshot = null;

        async function fetchJson(url, options = {}) {
            const resp = await fetch(API + url, options);
            return resp.json();
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return Math.round(n).toLocaleString();
        }

        function satColor(sat) {
            if (sat >= 0.7) return 'var(--success)';
            if (sat >= 0.4) return 'var(--accent)';
            return 'var(--danger)';
        }

        // ============================================
        // Tab System
        // ============================================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');

            if (tabId === 'holder-activity') {
                setTimeout(() => simCanvas.forceRedraw(), 50);
            }
            if (tabId === 'details') {
                setTimeout(() => { if (chart) chart.resize(); }, 50);
            }
            if (tabId === 'yield-dynamics') {
                setTimeout(() => {
                    if (apyChart) apyChart.resize();
                    if (participationChart) participationChart.resize();
                    updateYieldCharts();
                }, 50);
            }
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Sidebar section toggle
        function toggleSection(header) {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.toggle');
            body.classList.toggle('collapsed');
            if (toggle) toggle.innerHTML = body.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
        }

        // ============================================
        // Archetype mix preview
        // ============================================
        function handleArchSliderChange(changedArch) {
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const slider = document.getElementById('slider-' + changedArch);
            let newVal = Math.max(5, Math.min(85, Math.round(parseInt(slider.value) / 5) * 5));
            slider.value = newVal;

            const others = archs.filter(a => a !== changedArch);
            const remaining = 100 - newVal;

            // Get old values for proportional redistribution
            let otherOldTotal = 0;
            const oldVals = {};
            others.forEach(a => {
                oldVals[a] = parseInt(document.getElementById('slider-' + a).value);
                otherOldTotal += oldVals[a];
            });

            // Distribute remaining proportionally
            const newVals = {};
            if (otherOldTotal > 0) {
                others.forEach(a => {
                    const proportion = oldVals[a] / otherOldTotal;
                    newVals[a] = Math.max(5, Math.round(remaining * proportion / 5) * 5);
                });
            } else {
                others.forEach(a => {
                    newVals[a] = Math.max(5, Math.floor(remaining / 3 / 5) * 5);
                });
            }

            // Fix rounding: adjust largest "other" to make sum exactly 100
            let otherSum = 0;
            others.forEach(a => { otherSum += newVals[a]; });
            const diff = remaining - otherSum;
            if (diff !== 0) {
                // Find the largest other to absorb the rounding error
                let largest = others[0];
                others.forEach(a => { if (newVals[a] > newVals[largest]) largest = a; });
                newVals[largest] = Math.max(5, newVals[largest] + diff);
            }

            // Apply values
            others.forEach(a => {
                document.getElementById('slider-' + a).value = newVals[a];
                document.getElementById('val-' + a).textContent = newVals[a] + '%';
            });
            document.getElementById('val-' + changedArch).textContent = newVal + '%';

            // Update archetype bar
            updateArchBar();
        }

        function updateArchBar() {
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const colors = {
                believer: 'var(--success)',
                yield_seeker: 'var(--accent)',
                institution: 'var(--purple)',
                speculator: 'var(--danger)'
            };
            const bar = document.getElementById('arch-bar');
            if (!bar) return;
            bar.innerHTML = '';
            archs.forEach(a => {
                const val = parseInt(document.getElementById('slider-' + a).value);
                const seg = document.createElement('div');
                seg.className = 'archetype-bar-segment';
                seg.style.width = val + '%';
                seg.style.background = colors[a];
                bar.appendChild(seg);
            });
        }

        function getSliderParams() {
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const mix = {};
            archs.forEach(a => {
                mix[a] = parseInt(document.getElementById('slider-' + a).value) / 100;
            });

            const params = {
                num_holders: parseInt(document.getElementById('slider-holders').value),
                initial_participation_rate: parseInt(document.getElementById('slider-participation').value) / 100,
                yield_threshold_mean: parseInt(document.getElementById('slider-threshold').value) / 100,
                deploy_probability: parseInt(document.getElementById('slider-deploy').value) / 100,
                success_rate: parseInt(document.getElementById('slider-success').value) / 100,
                burn_rate: parseFloat(document.getElementById('slider-burn').value) / 100,
                archetype_mix: mix,
            };

            // Design Lab params
            if (document.getElementById('chk-credit-expiry').checked) {
                params.credit_expiry_enabled = true;
                params.credit_expiry_weeks = parseInt(document.getElementById('slider-expiry-weeks').value);
            }
            params.failure_mode = document.getElementById('select-failure-mode').value;

            return params;
        }

        function resetSliders() {
            document.getElementById('slider-participation').value = 30;
            document.getElementById('val-participation').textContent = '30%';
            document.getElementById('slider-threshold').value = 8;
            document.getElementById('val-threshold').textContent = '8%';
            document.getElementById('slider-deploy').value = 30;
            document.getElementById('val-deploy').textContent = '30%';
            document.getElementById('slider-success').value = 80;
            document.getElementById('val-success').textContent = '80%';
            document.getElementById('slider-holders').value = 100;
            document.getElementById('val-holders').textContent = '100';
            document.getElementById('slider-burn').value = 2;
            document.getElementById('val-burn').textContent = '2%';
            document.getElementById('slider-believer').value = 25;
            document.getElementById('val-believer').textContent = '25%';
            document.getElementById('slider-yield_seeker').value = 35;
            document.getElementById('val-yield_seeker').textContent = '35%';
            document.getElementById('slider-institution').value = 15;
            document.getElementById('val-institution').textContent = '15%';
            document.getElementById('slider-speculator').value = 25;
            document.getElementById('val-speculator').textContent = '25%';
            updateArchBar();
        }

        // Design Lab state
        function updateFailureModeHint() {
            const hints = {
                'nothing': 'Backers lose their deployed credits but RSC held is unaffected. Simple but may frustrate mission-aligned holders.',
                'partial_refund': '50% of deployed credits returned to backers on failure. Reduces risk for deployers but weakens the commitment signal.',
            };
            const val = document.getElementById('select-failure-mode').value;
            document.getElementById('failure-mode-hint').textContent = hints[val] || '';
        }

        function updateDesignLabState() {
            document.getElementById('credit-expiry-controls').style.display =
                document.getElementById('chk-credit-expiry').checked ? 'block' : 'none';
        }

        // ============================================
        // Main UI update
        // ============================================
        async function updateUI() {
            const state = await fetchJson('/api/state');
            const model = state.model;
            const pd = model.participation_data || {};

            // Status badges
            document.getElementById('step-count').textContent = model.step;
            document.getElementById('year-display').textContent = (model.year || 0).toFixed(1);
            document.getElementById('active-count').textContent = model.active_holders || model.active_stakers || 0;
            document.getElementById('total-count').textContent = model.num_holders || model.num_stakers || 0;

            // KPI metrics bar
            const partRate = ((model.participation_rate || 0) * 100).toFixed(1) + '%';
            const apyVal = ((model.current_apy || 0) * 100).toFixed(1) + '%';
            const partEl = document.getElementById('participation-rate');
            if (partEl.textContent !== partRate) {
                partEl.textContent = partRate;
                const m = partEl.closest('.metric');
                if (m) { m.classList.remove('pulse'); void m.offsetWidth; m.classList.add('pulse'); }
            }
            const apyEl = document.getElementById('current-apy');
            if (apyEl.textContent !== apyVal) {
                apyEl.textContent = apyVal;
                const m = apyEl.closest('.metric');
                if (m) { m.classList.remove('pulse'); void m.offsetWidth; m.classList.add('pulse'); }
            }
            const exitedVal = model.exited_holders || model.churned_stakers || 0;
            updateMetric('exited-count', exitedVal);
            const exitedEl = document.getElementById('exited-count');
            if (exitedEl) exitedEl.style.color = exitedVal > 0 ? 'var(--danger)' : 'var(--text-muted)';

            // 4th KPI: CSV Scenario verdict
            const partNum = model.participation_rate || 0;
            const csvEl = document.getElementById('csv-scenario');
            if (csvEl) {
                if (partNum < 0.225) {
                    csvEl.textContent = '~15% scenario (47% APY)';
                    csvEl.style.color = 'var(--accent)';
                } else if (partNum < 0.50) {
                    csvEl.textContent = '~30% scenario (24% APY)';
                    csvEl.style.color = 'var(--success)';
                } else {
                    csvEl.textContent = '~70% scenario (10% APY)';
                    csvEl.style.color = 'var(--text-muted)';
                }
            }

            // Multiplier distribution bar (sidebar)
            const mulDist = model.multiplier_distribution || {};
            const mulTotal = Object.values(mulDist).reduce((a, b) => a + (b.count || 0), 0) || 1;
            const mulColors = { New: '#536471', Holder: '#4a9eff', LongTerm: '#c9a227' };
            document.getElementById('multiplier-bar').innerHTML =
                ['New', 'Holder', 'LongTerm'].map(label => {
                    const d = mulDist[label] || { count: 0 };
                    return '<div class="tier-segment" style="width:' + (d.count / mulTotal * 100) + '%;background:' + mulColors[label] + '">' + d.count + '</div>';
                }).join('');

            // Archetype bar (sidebar)
            const archDist = model.archetype_distribution || {};
            const archTotal = Object.values(archDist).reduce((a, b) => a + b, 0) || 1;
            document.getElementById('arch-bar').innerHTML =
                ['believer', 'yield_seeker', 'institution', 'speculator'].map(a => {
                    const n = archDist[a] || 0;
                    return '<div class="arch-segment arch-' + a + '" style="width:' + (n / archTotal * 100) + '%">' + n + '</div>';
                }).join('');

            // Archetype metrics cards
            const archMetrics = model.archetype_metrics || {};
            const archNames = { believer: 'Believer', yield_seeker: 'Return-Sensitive', institution: 'Institution', speculator: 'Speculator' };
            const archColors = { believer: '#50c878', yield_seeker: '#c9a227', institution: '#7856ff', speculator: '#e05555' };
            document.getElementById('arch-metrics').innerHTML =
                ['believer', 'yield_seeker', 'institution', 'speculator'].map(a => {
                    const m = archMetrics[a];
                    if (!m) return '<div class="arch-metric-card ' + a + '"><div class="arch-card-name ' + a + '">' + archNames[a] + '</div><div class="arch-stat" style="color:var(--text-dim)">No agents</div></div>';
                    // Sparkline from participation history
                    const rscHistory = historyData['rsc_' + a] || [];
                    let sparklineSvg = '';
                    if (rscHistory.length >= 2) {
                        const w = 56, h = 18;
                        const vals = rscHistory.filter(v => v !== null && v > 0);
                        if (vals.length >= 2) {
                            const minV = Math.min(...vals), maxV = Math.max(...vals);
                            const range = maxV - minV || 1;
                            const points = vals.map((v, i) => {
                                const x = (i / (vals.length - 1)) * w;
                                const y = h - ((v - minV) / range) * h;
                                return x.toFixed(1) + ',' + y.toFixed(1);
                            }).join(' ');
                            sparklineSvg = '<svg width="' + w + '" height="' + h + '" style="vertical-align:middle;margin-left:6px">' +
                                '<polyline points="' + points + '" fill="none" stroke="' + archColors[a] + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        }
                    }
                    return '<div class="arch-metric-card ' + a + '">' +
                        '<div class="arch-card-name ' + a + '">' + archNames[a] + '</div>' +
                        '<div class="arch-stat"><span>Active</span><span class="arch-stat-val">' + m.active + '/' + m.total + '</span></div>' +
                        '<div class="arch-stat"><span>Avg RSC</span><span class="arch-stat-val">' + formatNumber(m.avg_rsc || 0) + sparklineSvg + '</span></div>' +
                        '<div class="arch-stat"><span>Avg Hold</span><span class="arch-stat-val">' + (m.avg_weeks_held || 0).toFixed(0) + 'wk ' + (m.avg_multiplier || 1).toFixed(2) + 'x</span></div>' +
                        '<div class="arch-stat"><span>Deployed</span><span class="arch-stat-val">' + formatNumber(m.total_deployed || 0) + '</span></div>' +
                        '<div class="arch-stat"><span>Exited</span><span class="arch-stat-val" style="color:var(--danger)">' + (m.exited || m.churned || 0) + '</span></div>' +
                        '</div>';
                }).join('');

            // Events (plain-English humanized messages)
            function humanizeEvent(e) {
                const w = 'Week ' + e.step + ': ';
                if (e.type === 'funded')       return w + 'Research proposal reached its funding goal';
                if (e.type === 'completed')    return w + 'Funded research delivered results';
                if (e.type === 'failed')       return w + 'Research proposal was unsuccessful';
                if (e.type === 'entry')        return w + 'New holders joined — APY was attractive';
                if (e.type === 'exit' || e.type === 'churn') return w + 'Holders exited — APY fell below their threshold';
                if (e.type === 'new_proposal') return w + 'New research proposal opened';
                return w + e.message;
            }
            const eventsHtml = state.events.slice(0, 20).map(e =>
                '<div class="event">' +
                '<span class="event-type ' + e.type + '">' + e.type + '</span>' +
                '<span>' + humanizeEvent(e) + '</span>' +
                '</div>'
            ).join('');
            document.getElementById('events-list').innerHTML = eventsHtml || '<div class="event" style="color:var(--text-dim)">No events yet</div>';

            // Proposals
            const proposals = await fetchJson('/api/proposals');
            const proposalsHtml = proposals.slice(-12).reverse().map(p =>
                '<div class="list-item">' +
                '<span class="proposal-id">' + p.id + '</span>' +
                '<div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(p.funding_progress, 100) + '%"></div></div>' +
                '<span class="progress-pct">' + Math.round(p.funding_progress) + '%</span>' +
                '<span class="status status-' + p.status + '">' + p.status + '</span>' +
                '</div>'
            ).join('');
            document.getElementById('proposals-list').innerHTML = proposalsHtml || '<div class="list-item" style="color:var(--text-dim)">No proposals</div>';

            // Yield Dynamics tab detail panels
            const detailBar = document.getElementById('multiplier-detail-bar');
            if (detailBar) {
                detailBar.innerHTML = ['New', 'Holder', 'LongTerm'].map(label => {
                    const d = mulDist[label] || { count: 0 };
                    return '<div style="flex:' + d.count + ';background:' + mulColors[label] + ';height:20px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:9px;min-width:2px" title="' + label + ': ' + d.count + '">' + (d.count > 2 ? d.count : '') + '</div>';
                }).join('');
            }
            const detailLegend = document.getElementById('multiplier-detail-legend');
            if (detailLegend) {
                detailLegend.innerHTML = ['New', 'Holder', 'LongTerm'].map(label => {
                    const d = mulDist[label] || { count: 0, rsc: 0 };
                    return label + ': ' + d.count + ' holders, ' + formatNumber(d.rsc || 0) + ' RSC';
                }).join(' | ');
            }
            const rscByArch = document.getElementById('rsc-by-archetype');
            if (rscByArch) {
                rscByArch.innerHTML = ['believer', 'yield_seeker', 'institution', 'speculator'].map(a => {
                    const am = archMetrics[a];
                    const total = am ? (am.avg_rsc || 0) * (am.active || 0) : 0;
                    return '<div style="display:flex;justify-content:space-between"><span style="color:' + archColors[a] + '">' + archNames[a] + '</span><span>' + formatNumber(total) + ' RSC</span></div>';
                }).join('');
            }

            // History data accumulation (for step-by-step)
            if (model.step > 0 && !historyData.steps.includes(model.step)) {
                const scenarios = pd.scenarios || {};
                historyData.steps.push(model.step);
                historyData.years.push(model.year || 0);
                historyData.participation.push((model.participation_rate || 0) * 100);
                historyData.apy.push((model.current_apy || 0) * 100);
                historyData.rsc_held.push(model.total_rsc_held || model.total_staked || 0);
                historyData.active.push(model.active_holders || model.active_stakers || 0);
                historyData.rsc_believer.push(archMetrics.believer ? (archMetrics.believer.avg_rsc || 0) * (archMetrics.believer.active || 0) : 0);
                historyData.rsc_yield_seeker.push(archMetrics.yield_seeker ? (archMetrics.yield_seeker.avg_rsc || 0) * (archMetrics.yield_seeker.active || 0) : 0);
                historyData.rsc_institution.push(archMetrics.institution ? (archMetrics.institution.avg_rsc || 0) * (archMetrics.institution.active || 0) : 0);
                historyData.rsc_speculator.push(archMetrics.speculator ? (archMetrics.speculator.avg_rsc || 0) * (archMetrics.speculator.active || 0) : 0);
                historyData.credits_generated_step.push(model.credits_generated_step || 0);
                historyData.credits_deployed_step.push(model.credits_deployed_step || 0);
                historyData.exits_step.push(model.exits_step || 0);
                historyData.entries_step.push(model.entries_step || 0);
                historyData.apy_15pct.push((scenarios['15pct'] || 0) * 100);
                historyData.apy_30pct.push((scenarios['30pct'] || 0) * 100);
                historyData.apy_70pct.push((scenarios['70pct'] || 0) * 100);
                updateChart();
                updateYieldCharts();
            }

            updateRHReading(model);
            await loadStakers();

            // Canvas
            simCanvas.update(lastStakers, model.step_deployments || []);

            // Post-run summary
            if (model.step >= 10 && initialSnapshot) {
                updatePostRunSummary(model);
            }
        }

        // Metric animation state
        const metricAnimations = {};

        function updateMetric(id, value) {
            const el = document.getElementById(id);
            const formatted = formatNumber(value);
            if (el.textContent === formatted) return;

            // Get previous numeric value from animation state
            const prev = metricAnimations[id];
            if (prev !== undefined && typeof value === 'number' && typeof prev === 'number') {
                // Animate from prev to value over 400ms
                const startVal = prev;
                const endVal = value;
                const startTime = performance.now();
                const duration = 400;

                function animateMetric(now) {
                    const elapsed = now - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    // Ease-out cubic
                    const eased = 1 - Math.pow(1 - progress, 3);
                    const current = startVal + (endVal - startVal) * eased;
                    el.textContent = formatNumber(current);
                    if (progress < 1) {
                        requestAnimationFrame(animateMetric);
                    } else {
                        el.textContent = formatNumber(endVal);
                    }
                }
                requestAnimationFrame(animateMetric);
            } else {
                el.textContent = formatted;
            }

            metricAnimations[id] = value;

            // Pulse animation
            const metric = el.closest('.metric');
            if (metric) {
                metric.classList.remove('pulse');
                void metric.offsetWidth;
                metric.classList.add('pulse');
            }
        }

        // ============================================
        // Chart System
        // ============================================
        function chartCommon(light) {
            const tickColor = light ? '#666' : '#555';
            const gridColor = light ? '#ddd' : '#1a1a1a';
            const legendColor = light ? '#666' : '#888';
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: legendColor, font: { size: 10, family: 'monospace' }, boxWidth: 12 }
                    }
                },
                scales: {
                    x: { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                },
                _tickColor: tickColor,
                _gridColor: gridColor,
            };
        }

        function getChartConfig(view) {
            const light = isLightMode();
            const common = chartCommon(light);
            const tickColor = common._tickColor, gridColor = common._gridColor;
            const yAxis = { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } };

            if (view === 'token-economics') {
                return {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'RSC Held', data: historyData.rsc_held, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                            { label: 'Active Holders', data: historyData.active, borderColor: '#50c878', tension: 0.3, yAxisID: 'y1', pointRadius: 1 },
                        ]
                    },
                    options: { ...common, scales: { ...common.scales, y: yAxis, y1: { position: 'right', ticks: { color: tickColor, font: { size: 10 } }, grid: { drawOnChartArea: false } } } }
                };
            }

            if (view === 'agent-health') {
                return {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Believer RSC', data: historyData.rsc_believer, borderColor: '#50c878', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'YieldSeeker RSC', data: historyData.rsc_yield_seeker, borderColor: '#c9a227', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Institution RSC', data: historyData.rsc_institution, borderColor: '#7856ff', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Speculator RSC', data: historyData.rsc_speculator, borderColor: '#e05555', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Exits', data: historyData.exits_step, borderColor: 'rgba(224,85,85,0.5)', backgroundColor: 'rgba(224,85,85,0.2)', type: 'bar', yAxisID: 'y1' },
                        ]
                    },
                    options: {
                        ...common,
                        scales: {
                            ...common.scales,
                            y: { position: 'left', title: { display: true, text: 'RSC', color: tickColor }, ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                            y1: { position: 'right', min: 0, title: { display: true, text: 'Exits/Step', color: tickColor }, ticks: { color: tickColor, font: { size: 10 } }, grid: { drawOnChartArea: false } },
                        }
                    }
                };
            }

            if (view === 'funding-flow') {
                return {
                    type: 'bar',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Credits Generated', data: historyData.credits_generated_step, backgroundColor: 'rgba(80,200,120,0.5)', borderColor: '#50c878', borderWidth: 1 },
                            { label: 'Credits Deployed', data: historyData.credits_deployed_step, backgroundColor: 'rgba(74,158,255,0.5)', borderColor: '#4a9eff', borderWidth: 1 },
                        ]
                    },
                    options: { ...common, scales: { ...common.scales, y: yAxis } }
                };
            }
        }

        function updateChart() {
            const ctx = document.getElementById('history-chart').getContext('2d');
            if (chart) { chart.destroy(); chart = null; }
            const config = getChartConfig(currentChartView);
            chart = new Chart(ctx, config);
        }

        function switchChartView(view) {
            currentChartView = view;
            document.querySelectorAll('.chart-view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-view="' + view + '"]').classList.add('active');
            updateChart();
        }

        function updateRHReading(model) {
            // Generates a live leadership-oriented interpretation after the sim runs.
            const el = document.getElementById('rh-design-reading');
            if (!el || !model || !model.step || model.step < 5) return;

            const part = ((model.participation_rate || 0) * 100).toFixed(1);
            const apy = ((model.current_apy || 0) * 100).toFixed(1);
            const yr = (model.step / 52).toFixed(1);
            const exited = model.exited_holders || 0;
            const active = model.active_holders || model.active_stakers || 0;
            const circ = model.circulating_supply || 134157343;
            const rscHeld = model.total_rsc_held || 0;

            // Which CSV scenario are we closest to?
            const partNum = model.participation_rate || 0;
            let scenario, scenarioColor;
            if (partNum < 0.225) { scenario = '15%'; scenarioColor = '#50c878'; }
            else if (partNum < 0.50) { scenario = '30%'; scenarioColor = '#4a9eff'; }
            else { scenario = '70%'; scenarioColor = '#e05555'; }

            // Interpretation
            const rscHeldM = (rscHeld / 1e6).toFixed(1);
            const circM = (circ / 1e6).toFixed(1);

            let interpretation = [];
            interpretation.push(
                'At <strong>Year ' + yr + '</strong>: <strong style="color:var(--accent)">' + part + '%</strong> participation ' +
                '(' + rscHeldM + 'M of ' + circM + 'M circulating RSC held in RH). ' +
                'Closest to the <strong style="color:' + scenarioColor + '">' + scenario + ' CSV scenario</strong> — APY ' + apy + '%.'
            );

            if (partNum < 0.10) {
                interpretation.push('&#9888; <strong>Very low participation.</strong> At this APY (' + apy + '%), strong market incentive for yield seekers to enter. Run longer to see convergence.');
            } else if (partNum > 0.60) {
                interpretation.push('&#9888; <strong>High participation.</strong> Yield is diluted — only deeply mission-aligned holders and institutions stay. Speculator exits expected.');
            } else {
                interpretation.push('&#10003; <strong>Moderate equilibrium range.</strong> Believers and Institutions anchor the base; Yield Seekers self-regulate around the threshold.');
            }

            if (exited > 0) {
                const churnPct = ((exited / (active + exited)) * 100).toFixed(0);
                interpretation.push(exited + ' holders exited (' + churnPct + '% churn) — primarily Speculators and Yield Seekers. Believers/Institutions are sticky.');
            }

            el.innerHTML = interpretation.map(s => '<p style="margin:0 0 4px">' + s + '</p>').join('');
            el.style.display = 'block';
        }

        function updateYieldCharts() {
            const light = isLightMode();
            const common = chartCommon(light);
            const tickColor = common._tickColor, gridColor = common._gridColor;

            // APY chart
            const apyCtx = document.getElementById('apy-chart');
            if (apyCtx) {
                if (apyChart) { apyChart.destroy(); apyChart = null; }
                apyChart = new Chart(apyCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Sim APY', data: historyData.apy, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.1)', tension: 0.3, fill: true, borderWidth: 2 },
                            { label: '15% Part.', data: historyData.apy_15pct, borderColor: '#50c878', borderDash: [4,3], tension: 0.1, borderWidth: 1.5, pointRadius: 0 },
                            { label: '30% Part.', data: historyData.apy_30pct, borderColor: '#4a9eff', borderDash: [4,3], tension: 0.1, borderWidth: 1.5, pointRadius: 0 },
                            { label: '70% Part.', data: historyData.apy_70pct, borderColor: '#e05555', borderDash: [4,3], tension: 0.1, borderWidth: 1.5, pointRadius: 0 },
                        ]
                    },
                    options: {
                        ...common,
                        scales: {
                            x: { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                            y: { ticks: { color: tickColor, font: { size: 10 }, callback: v => v.toFixed(0) + '%' }, grid: { color: gridColor }, title: { display: true, text: 'APY %', color: tickColor } }
                        }
                    }
                });
            }

            // Participation rate chart
            const partCtx = document.getElementById('participation-chart');
            if (partCtx) {
                if (participationChart) { participationChart.destroy(); participationChart = null; }
                const labels = historyData.steps;
                participationChart = new Chart(partCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Participation %', data: historyData.participation, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.15)', tension: 0.3, fill: true, borderWidth: 2, pointRadius: 0 },
                            { label: 'Healthy Zone', data: labels.map(() => 35), borderColor: 'rgba(80,200,120,0.25)', backgroundColor: 'rgba(80,200,120,0.07)', fill: '+1', pointRadius: 0, borderWidth: 1, borderDash: [3,5] },
                            { label: '_zone_floor',  data: labels.map(() => 20), borderColor: 'rgba(80,200,120,0.25)', fill: false, pointRadius: 0, borderWidth: 1, borderDash: [3,5] },
                        ]
                    },
                    options: {
                        ...common,
                        scales: {
                            x: { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                            y: { ticks: { color: tickColor, font: { size: 10 }, callback: v => v.toFixed(1) + '%' }, grid: { color: gridColor }, title: { display: true, text: 'Participation %', color: tickColor } },
                        }
                    }
                });
            }
        }

        // ============================================
        // Actions
        // ============================================
        async function step() {
            await fetchJson('/api/step', { method: 'POST' });
            await updateUI();
        }

        async function run(n) {
            await fetchJson('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: n })
            });
            const history = await fetchJson('/api/history');
            historyData.steps = history.Step || [];
            historyData.years = history.Year || [];
            historyData.participation = (history.Participation_Rate || []).map(v => (v || 0) * 100);
            historyData.apy = (history.Current_APY || []).map(v => (v || 0) * 100);
            historyData.rsc_held = history.Total_RSC_Held || [];
            historyData.active = history.Active_Holders || history.Active_Stakers || [];
            historyData.rsc_believer = history.RSC_Believer || [];
            historyData.rsc_yield_seeker = history.RSC_YieldSeeker || [];
            historyData.rsc_institution = history.RSC_Institution || [];
            historyData.rsc_speculator = history.RSC_Speculator || [];
            historyData.credits_generated_step = history.Credits_Generated_Step || [];
            historyData.credits_deployed_step = history.Credits_Deployed_Step || [];
            historyData.exits_step = history.Exits_Step || [];
            historyData.entries_step = history.Entries_Step || [];
            // Compute reference APYs client-side from the emission formula + known circulating supply
            const circ0 = 134157343;
            historyData.apy_15pct = historyData.years.map(y => (9500000 / Math.pow(2, y / 64)) / (circ0 * 0.15) * 100);
            historyData.apy_30pct = historyData.years.map(y => (9500000 / Math.pow(2, y / 64)) / (circ0 * 0.30) * 100);
            historyData.apy_70pct = historyData.years.map(y => (9500000 / Math.pow(2, y / 64)) / (circ0 * 0.70) * 100);
            updateChart();
            updateYieldCharts();
            await updateUI();
            // Force canvas redraw after bulk run
            setTimeout(() => simCanvas.forceRedraw(), 100);
        }

        async function runToEquilibrium() {
            // 208 steps = 4 years — enough for self-balancing to stabilize.
            // Yield Seekers cycle through several entry/exit waves, Institutions
            // accumulate their 1.2x multiplier, and APY converges toward the
            // equilibrium implied by yield_threshold_mean.
            await run(208);
        }

        async function resetWithParams() {
            const params = getSliderParams();
            await fetchJson('/api/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            historyData = {
                steps: [], years: [], participation: [], apy: [], rsc_held: [], active: [],
                rsc_believer: [], rsc_yield_seeker: [], rsc_institution: [], rsc_speculator: [],
                credits_generated_step: [], credits_deployed_step: [], exits_step: [], entries_step: [],
                apy_15pct: [], apy_30pct: [], apy_70pct: [],
            };
            if (chart) { chart.destroy(); chart = null; }
            if (apyChart) { apyChart.destroy(); apyChart = null; }
            if (participationChart) { participationChart.destroy(); participationChart = null; }
            simCanvas.reset();
            // Capture initial snapshot for post-run summary
            const state = await fetchJson('/api/state');
            initialSnapshot = {
                participation_rate: state.model.participation_rate,
                current_apy: state.model.current_apy,
                active_holders: state.model.active_holders || state.model.active_stakers,
                total_rsc_held: state.model.total_rsc_held || state.model.total_staked,
            };
            document.getElementById('post-run-summary').style.display = 'none';
            await updateUI();
        }

        // ============================================
        // Scenarios
        // ============================================
        async function saveScenario() {
            if (savedScenarios.length >= 6) {
                alert('Maximum 6 scenarios. Clear some first.');
                return;
            }
            const state = await fetchJson('/api/state');
            const model = state.model;
            const params = model.params || {};
            const threshDisplay = document.getElementById('slider-threshold').value;
            const deployDisplay = document.getElementById('slider-deploy').value;
            const defaultName = 'Scenario ' + (savedScenarios.length + 1) + ' \u2014 ' +
                threshDisplay + '% threshold, ' + ((model.participation_rate || 0) * 100).toFixed(1) + '% participation';
            const name = prompt('Scenario name:', defaultName);
            if (!name) return;

            savedScenarios.push({
                name: name,
                step: model.step,
                params: params,
                metrics: {
                    participation_rate: model.participation_rate,
                    current_apy: model.current_apy,
                    total_rsc_held: model.total_rsc_held || model.total_staked,
                    active_holders: model.active_holders || model.active_stakers,
                    exited_holders: model.exited_holders || model.churned_stakers,
                    annual_emission: model.annual_emission,
                    total_burned: model.total_burned,
                    deployment_rate: model.deployment_rate,
                    success_rate_actual: model.success_rate_actual,
                    completed_proposals: model.completed_proposals,
                    open_proposals: model.open_proposals,
                    num_holders: model.num_holders || model.num_stakers,
                },
            });
            updateScenariosList();
            updateScenarioCompare();
        }

        function clearScenarios() {
            savedScenarios = [];
            updateScenariosList();
            updateScenarioCompare();
        }

        function updateScenariosList() {
            const el = document.getElementById('saved-scenarios-list');
            if (savedScenarios.length === 0) {
                el.innerHTML = 'No saved scenarios';
                return;
            }
            el.innerHTML = savedScenarios.map((s, i) =>
                '<div style="padding:3px 0;border-bottom:1px solid var(--border)">' +
                '<span style="color:var(--accent)">' + (i + 1) + '.</span> ' + s.name +
                ' <span style="color:var(--text-dim)">(wk ' + s.step + ')</span></div>'
            ).join('');
        }

        function updateScenarioCompare() {
            const el = document.getElementById('scenario-compare-content');
            if (savedScenarios.length === 0) {
                el.innerHTML = '<p style="color:var(--text-dim);font-size:12px;">Save scenarios from the sidebar to compare them here.</p>';
                return;
            }

            const metricLabels = {
                participation_rate: 'Participation Rate',
                current_apy: 'Current APY',
                total_rsc_held: 'RSC Held',
                active_holders: 'Active Holders',
                exited_holders: 'Exited',
                annual_emission: 'Annual Emission',
                total_burned: 'Burned',
                deployment_rate: 'Deployed/Wk',
                success_rate_actual: 'Success Rate',
                completed_proposals: 'Completed',
                open_proposals: 'Open',
                num_holders: 'Total Holders',
            };

            let html = '<table class="scenario-table"><thead><tr><th>Metric</th>';
            savedScenarios.forEach(s => { html += '<th>' + s.name + '</th>'; });
            html += '</tr></thead><tbody>';

            for (const [key, label] of Object.entries(metricLabels)) {
                html += '<tr><td>' + label + '</td>';
                savedScenarios.forEach(s => {
                    const val = s.metrics[key];
                    const formatted = key === 'participation_rate' || key === 'current_apy' ? ((val || 0) * 100).toFixed(1) + '%'
                        : key === 'success_rate_actual' ? ((val || 0) * 100).toFixed(0) + '%'
                        : typeof val === 'number' ? formatNumber(val) : (val ?? '—');
                    html += '<td>' + formatted + '</td>';
                });
                html += '</tr>';
            }
            html += '</tbody></table>';
            el.innerHTML = html;
        }

        // ============================================
        // Scenario Modal
        // ============================================
        function openScenarioModal() {
            document.getElementById('scenario-modal').classList.add('open');
            updateScenarioCompare();
        }

        function closeScenarioModal() {
            document.getElementById('scenario-modal').classList.remove('open');
        }

        // Close modal on backdrop click
        document.getElementById('scenario-modal').addEventListener('click', function(e) {
            if (e.target === this) closeScenarioModal();
        });

        // Metrics detail toggle
        function toggleMetricDetails(e) {
            e.preventDefault();
            const details = document.getElementById('metric-details');
            const link = e.target;
            if (details.style.display === 'none') {
                details.style.display = 'block';
                link.innerHTML = 'Hide detailed metrics &#9662;';
            } else {
                details.style.display = 'none';
                link.innerHTML = 'Show detailed metrics &#9656;';
            }
        }

        // ============================================
        // ============================================
        // Agent Inspector
        // ============================================
        let currentAgentTab = 'top-stakers';
        let lastStakers = [];

        function showAgentTab(tab, btnEl) {
            currentAgentTab = tab;
            document.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
            else document.querySelector('.agent-tab').classList.add('active');
            renderAgentTab();
        }

        async function loadStakers() {
            lastStakers = await fetchJson('/api/holders');
            renderAgentTab();
        }

        function renderAgentTab() {
            const container = document.getElementById('agent-content');
            if (!lastStakers.length) {
                container.innerHTML = '<div class="agent-placeholder">No holders yet. Run the simulation.</div>';
                return;
            }
            const archNames = { believer: 'Believer', yield_seeker: 'Return-Sensitive', institution: 'Institution', speculator: 'Speculator' };

            if (currentAgentTab === 'top-stakers') {
                const sorted = [...lastStakers].filter(s => s.active).sort((a, b) => (b.rsc_held || 0) - (a.rsc_held || 0)).slice(0, 20);
                container.innerHTML =
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>RSC Held</th><th>Hold Duration</th><th>Multiplier</th><th>Credits</th><th>Deployed</th>' +
                    '</tr></thead><tbody>' +
                    sorted.map(s =>
                        '<tr class="' + (highlightedAgentId === s.id ? 'highlighted' : '') + '">' +
                        '<td class="agent-id">' + s.id + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td>' + formatNumber(s.rsc_held || s.stake || 0) + '</td>' +
                        '<td>' + (s.weeks_held || 0) + 'wk</td>' +
                        '<td><span style="color:var(--accent)">' + (s.multiplier_label || 'New') + ' ' + (s.multiplier || 1).toFixed(2) + 'x</span></td>' +
                        '<td>' + formatNumber(s.credits) + '</td>' +
                        '<td>' + formatNumber(s.total_deployed) + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>';

            } else if (currentAgentTab === 'recent-deployers') {
                const deployers = [...lastStakers].filter(s => s.total_deployed > 0).sort((a, b) => b.total_deployed - a.total_deployed).slice(0, 20);
                container.innerHTML = deployers.length ?
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Deployed</th><th>Burned</th><th>Threshold</th><th>Status</th>' +
                    '</tr></thead><tbody>' +
                    deployers.map(s =>
                        '<tr class="' + (!s.active ? 'churned' : '') + (highlightedAgentId === s.id ? ' highlighted' : '') + '">' +
                        '<td class="agent-id">' + s.id + (s.active ? '' : ' [exited]') + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td style="color:var(--success)">' + formatNumber(s.total_deployed) + '</td>' +
                        '<td style="color:var(--danger)">' + formatNumber(s.total_burned) + '</td>' +
                        '<td>' + ((s.yield_threshold || 0) * 100).toFixed(1) + '%</td>' +
                        '<td>' + (s.active ? '<span style="color:var(--success)">Holding</span>' : '<span style="color:var(--danger)">Exited</span>') + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>'
                    : '<div class="agent-placeholder">No deployments yet. Run more steps.</div>';

            } else if (currentAgentTab === 'by-archetype') {
                const archetypes = ['believer', 'yield_seeker', 'institution', 'speculator'];
                const rows = archetypes.map(a => {
                    const group = lastStakers.filter(s => s.archetype === a);
                    const active = group.filter(s => s.active);
                    const totalRsc = active.reduce((acc, s) => acc + (s.rsc_held || s.stake || 0), 0);
                    const totalDeployed = group.reduce((acc, s) => acc + s.total_deployed, 0);
                    const avgWeeks = active.length > 0 ? active.reduce((acc, s) => acc + (s.weeks_held || 0), 0) / active.length : 0;
                    const avgMult = active.length > 0 ? active.reduce((acc, s) => acc + (s.multiplier || 1), 0) / active.length : 1;
                    return '<tr>' +
                        '<td><span class="arch-badge ' + a + '">' + archNames[a] + '</span></td>' +
                        '<td>' + active.length + '/' + group.length + '</td>' +
                        '<td>' + formatNumber(totalRsc) + '</td>' +
                        '<td>' + formatNumber(totalDeployed) + '</td>' +
                        '<td>' + avgWeeks.toFixed(0) + 'wk</td>' +
                        '<td>' + avgMult.toFixed(2) + 'x</td>' +
                        '</tr>';
                });
                container.innerHTML =
                    '<table class="agent-table"><thead><tr>' +
                    '<th>Archetype</th><th>Active/Total</th><th>Total RSC</th><th>Total Deployed</th><th>Avg Hold</th><th>Avg Multiplier</th>' +
                    '</tr></thead><tbody>' + rows.join('') + '</tbody></table>';

            } else if (currentAgentTab === 'churned') {
                const exited = lastStakers.filter(s => !s.active);
                container.innerHTML = exited.length ?
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>RSC Held</th><th>Hold Duration</th><th>Threshold</th><th>Deployed</th>' +
                    '</tr></thead><tbody>' +
                    exited.map(s =>
                        '<tr class="churned">' +
                        '<td class="agent-id">' + s.id + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td>' + formatNumber(s.rsc_held || s.stake || 0) + '</td>' +
                        '<td>' + (s.weeks_held || 0) + 'wk</td>' +
                        '<td style="color:var(--danger)">' + ((s.yield_threshold || 0) * 100).toFixed(1) + '%</td>' +
                        '<td>' + formatNumber(s.total_deployed) + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>'
                    : '<div class="agent-placeholder">No holders have exited yet.</div>';
            }

            // Clear highlight after render
            setTimeout(() => { highlightedAgentId = null; }, 3000);
        }

        // ============================================
        // Narrative
        // ============================================
        function generateNarrative(model, events) {
            const parts = [];
            const step = model.step;
            const stepEvents = events.filter(e => e.step === step);
            const funded = stepEvents.filter(e => e.type === 'funded').length;
            const completed = stepEvents.filter(e => e.type === 'completed').length;
            const failed = stepEvents.filter(e => e.type === 'failed').length;
            const newProposals = stepEvents.filter(e => e.type === 'new_proposal').length;
            const churned = stepEvents.filter(e => e.type === 'churn').length;

            const creditsGen = model.credit_generation_rate;
            const deployed = model.deployment_rate;
            const burned = model.burn_rate_per_step;

            parts.push('<p><strong>Week ' + step + ':</strong> <span class="narrative-highlight">' + (model.active_holders || model.active_stakers || 0) + ' active holders</span> (' + (model.exited_holders || model.churned_stakers || 0) + ' exited) earned yield credits. ' +
                'Generation: <span class="narrative-highlight">' + formatNumber(creditsGen) + ' credits</span>. ' +
                'Participation: ' + ((model.participation_rate || 0) * 100).toFixed(1) + '% APY: ' + ((model.current_apy || 0) * 100).toFixed(1) + '%.</p>');

            if (deployed > 0) {
                parts.push('<p><span class="narrative-success">' + formatNumber(deployed) + ' credits</span> deployed to proposals, ' +
                    'triggering <span class="narrative-danger">' + formatNumber(burned) + ' RSC burn</span>.</p>');
            }

            if (funded > 0) {
                parts.push('<p><span class="narrative-success">' + funded + ' proposal' + (funded > 1 ? 's' : '') + ' reached funding target!</span></p>');
            }

            if (completed > 0 || failed > 0) {
                const resolutions = [];
                if (completed > 0) resolutions.push('<span class="narrative-success">' + completed + ' completed</span>');
                if (failed > 0) resolutions.push('<span class="narrative-danger">' + failed + ' failed</span>');
                parts.push('<p>Proposals resolved: ' + resolutions.join(', ') + '.</p>');
            }

            if (churned > 0) {
                parts.push('<p><span class="narrative-danger">' + churned + ' holder' + (churned > 1 ? 's' : '') + ' exited</span> (yield below threshold).</p>');
            }

            if (newProposals > 0) {
                parts.push('<p><span class="narrative-highlight">' + newProposals + ' new proposal' + (newProposals > 1 ? 's' : '') + '</span> entered the queue.</p>');
            }

            return parts.join('') || '<p class="narrative-placeholder">No significant activity this week.</p>';
        }

        // updateNarrative removed — "This Week's Activity" section was removed in Round 3

        // ============================================
        // Post-Run Summary
        // ============================================
        function generateNarrativeSummary(model, stakers) {
            // Aggregate per-archetype data from staker list
            const archetypes = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const archNames = { believer: 'Believers', yield_seeker: 'Return-Sensitive Holders', institution: 'Institutions', speculator: 'Speculators' };
            const archData = {};
            let totalDeployed = 0;
            let totalChurned = 0;

            for (const arch of archetypes) {
                const group = stakers.filter(s => s.archetype === arch);
                const active = group.filter(s => s.active);
                const exited = group.filter(s => !s.active);
                const deployed = group.reduce((sum, s) => sum + s.total_deployed, 0);
                const avgCredits = active.length > 0 ? active.reduce((sum, s) => sum + s.credits, 0) / active.length : 0;
                const avgWeeks = active.length > 0 ? active.reduce((sum, s) => sum + s.weeks_held, 0) / active.length : 0;
                archData[arch] = { total: group.length, active: active.length, churned: exited.length, deployed, avgCredits, avgWeeks };
                totalDeployed += deployed;
                totalChurned += exited.length;
            }

            // Find top deployer archetype
            let topDeployer = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].deployed > archData[topDeployer].deployed) topDeployer = arch;
            }
            const topDeployPct = totalDeployed > 0 ? ((archData[topDeployer].deployed / totalDeployed) * 100).toFixed(0) : 0;
            const topDeployPopPct = ((archData[topDeployer].total / stakers.length) * 100).toFixed(0);

            // Find highest credit hoarder
            let hoarder = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].avgCredits > archData[hoarder].avgCredits) hoarder = arch;
            }
            let lowestCredits = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].active > 0 && archData[arch].avgCredits < archData[lowestCredits].avgCredits) lowestCredits = arch;
            }
            const hoardRatio = archData[lowestCredits].avgCredits > 0
                ? (archData[hoarder].avgCredits / archData[lowestCredits].avgCredits).toFixed(1)
                : 'N/A';

            // Find longest-holding archetype
            let longestHolder = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].active > 0 && archData[arch].avgWeeks > archData[longestHolder].avgWeeks) longestHolder = arch;
            }

            // Burn as % of initial RSC held
            const burnPct = initialSnapshot.total_rsc_held > 0
                ? ((model.total_burned / initialSnapshot.total_rsc_held) * 100).toFixed(1)
                : '0';

            // Build narrative
            const parts = [];
            parts.push('Over <span class="narrative-highlight">' + model.step + ' weeks</span>, the endowment generated ' +
                '<span class="narrative-highlight">' + formatNumber(model.total_credits_generated) + ' funding credits</span> and burned ' +
                '<span class="narrative-danger">' + formatNumber(model.total_burned) + ' RSC</span> (' + burnPct + '% of initial stake).');

            parts.push(archNames[topDeployer] + ' were the most active deployers, contributing ' +
                '<span class="narrative-success">' + topDeployPct + '% of all credit deployments</span> despite being ' +
                topDeployPopPct + '% of the population.');

            if (hoarder !== lowestCredits && hoardRatio !== 'N/A') {
                parts.push(archNames[hoarder] + ' hoarded credits — their average credit balance was ' +
                    '<span class="narrative-highlight">' + hoardRatio + 'x higher</span> than ' + archNames[lowestCredits] + '\'s.');
            }

            if (totalChurned > 0) {
                const churnParts = archetypes.filter(a => archData[a].churned > 0)
                    .map(a => archData[a].churned + ' ' + archNames[a].toLowerCase());
                parts.push('<span class="narrative-danger">' + totalChurned + ' holder' + (totalChurned > 1 ? 's' : '') +
                    ' exited</span> (yield fell below threshold) (' + churnParts.join(', ') + ').');
            }

            if (archData[longestHolder].active > 0) {
                parts.push(archNames[longestHolder] + ' held longest on average (' +
                    archData[longestHolder].avgWeeks.toFixed(0) + ' weeks), earning higher time-weight multipliers.');
            }

            // Proposal stats
            if (model.completed_proposals + model.failed_proposals > 0) {
                const totalResolved = model.completed_proposals + model.failed_proposals;
                const successPct = ((model.completed_proposals / totalResolved) * 100).toFixed(0);
                parts.push(totalResolved + ' proposals resolved: <span class="narrative-success">' +
                    model.completed_proposals + ' completed</span>' +
                    (model.failed_proposals > 0 ? ', <span class="narrative-danger">' + model.failed_proposals + ' failed</span>' : '') +
                    ' (' + successPct + '% success rate).');
            }

            return '<p>' + parts.join(' ') + '</p>';
        }

        function updatePostRunSummary(model) {
            if (!initialSnapshot) return;
            const el = document.getElementById('post-run-summary');

            // Generate narrative prose from staker data
            let html = '<div class="summary-panel"><div class="card-header">Run Summary (Week 0 &rarr; ' + model.step + ')</div>';
            if (model.step >= 10 && lastStakers.length > 0) {
                html += '<div class="narrative" style="margin-bottom:12px">' + generateNarrativeSummary(model, lastStakers) + '</div>';
            }

            // Collapsible metrics delta table
            html += '<a href="#" class="detail-toggle" onclick="toggleMetricDetails(event)">Show detailed metrics &#9656;</a>';
            html += '<div id="metric-details" style="display:none">';

            const deltas = [
                { label: 'RSC Held in RH', initial: initialSnapshot.total_rsc_held || initialSnapshot.total_staked || 0, final: model.total_rsc_held || model.total_staked || 0 },
                { label: 'Credits', initial: initialSnapshot.total_credits || 0, final: model.total_credits || 0 },
                { label: 'Active Holders', initial: initialSnapshot.active_holders || initialSnapshot.active_stakers || 0, final: model.active_holders || model.active_stakers || 0, fmt: 'int' },
                { label: 'Participation Rate', initial: initialSnapshot.participation_rate || 0, final: model.participation_rate || 0, fmt: 'pct' },
                { label: 'Current APY', initial: initialSnapshot.current_apy || 0, final: model.current_apy || 0, fmt: 'pct' },
                { label: 'Total Burned', initial: initialSnapshot.total_burned || 0, final: model.total_burned || 0 },
                { label: 'Credits Deployed', initial: 0, final: model.total_credits_deployed || 0 },
                { label: 'Completed Proposals', initial: 0, final: model.completed_proposals || 0, fmt: 'int' },
                { label: 'Failed Proposals', initial: 0, final: model.failed_proposals || 0, fmt: 'int' },
                { label: 'Open Proposals', initial: 0, final: model.open_proposals || 0, fmt: 'int' },
                { label: 'Total Exited', initial: 0, final: model.exited_holders || model.churned_stakers || 0, fmt: 'int' },
            ];

            deltas.forEach(d => {
                const diff = d.final - d.initial;
                const sign = diff >= 0 ? '+' : '';
                const cls = diff >= 0 ? 'delta-pos' : 'delta-neg';
                let valStr, diffStr;
                if (d.fmt === 'pct') {
                    valStr = (d.final * 100).toFixed(1) + '%';
                    diffStr = sign + (diff * 100).toFixed(1) + '%';
                } else if (d.fmt === 'int') {
                    valStr = d.final.toString();
                    diffStr = d.initial > 0 ? sign + diff : '';
                } else {
                    valStr = formatNumber(d.final);
                    diffStr = sign + formatNumber(diff);
                }
                const deltaHtml = diffStr ? ' <span class="' + cls + '">(' + diffStr + ')</span>' : '';
                html += '<div class="summary-delta"><span class="delta-label">' + d.label + '</span><span>' + valStr + deltaHtml + '</span></div>';
            });

            // Tension detection
            const tensions = [];
            if (model.total_credits > model.total_credits_deployed * 2 && model.step > 10) {
                tensions.push('Credits accumulating faster than deployed - deployment pressure may build.');
            }
            if ((model.current_apy || 0) > 0.5) {
                tensions.push('APY above 50% — participation rate very low, strong incentive for new entrants.');
            }
            const exited = model.exited_holders || model.churned_stakers || 0;
            const active = model.active_holders || model.active_stakers || 1;
            if (exited > active * 0.3) {
                tensions.push('High exit rate — more than 30% of holders have left (yield below thresholds).');
            }

            if (tensions.length > 0) {
                html += '<div class="tension-warning"><strong>Tensions:</strong><ul>';
                tensions.forEach(t => { html += '<li>' + t + '</li>'; });
                html += '</ul></div>';
            }

            html += '</div>'; // close metric-details
            html += '</div>'; // close summary-panel
            el.innerHTML = html;
            el.style.display = 'block';
        }

        // ============================================
        // ============================================
        // Theme toggle
        // ============================================
        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.querySelector('.theme-toggle');
            if (html.getAttribute('data-theme') === 'light') {
                html.removeAttribute('data-theme');
                btn.textContent = 'Light';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                btn.textContent = 'Dark';
                localStorage.setItem('theme', 'light');
            }
        }

        function isLightMode() {
            return document.documentElement.getAttribute('data-theme') === 'light';
        }

        // ============================================
        // Quick Scenario Loader
        // ============================================
        async function loadScenario(participation, threshold) {
            // Set participation slider
            const partSlider = document.getElementById('slider-participation');
            const partPct = Math.round(participation * 100);
            partSlider.value = partPct;
            document.getElementById('val-participation').textContent = partPct + '%';
            // Set threshold slider
            const threshSlider = document.getElementById('slider-threshold');
            const threshPct = Math.round(threshold * 100);
            threshSlider.value = threshPct;
            document.getElementById('val-threshold').textContent = threshPct + '%';
            updateArchBar();
            await resetWithParams();
        }

        // Restore saved theme
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
            document.querySelector('.theme-toggle').textContent = 'Dark';
        }

        // ============================================
        // Init
        // ============================================
        updateUI();
        updateArchBar();
    </script>
</body>
</html>
