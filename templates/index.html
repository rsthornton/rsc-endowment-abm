<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSC Endowment Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ============================================================
           DESIGN SYSTEM — Light default, dark toggle
           ============================================================ */
        :root {
            --bg: #F8F9FA;
            --bg-card: #FFFFFF;
            --bg-section: #F0F2F5;
            --border: #E5E7EB;
            --text: #111827;
            --text-muted: #6B7280;
            --text-dim: #9CA3AF;
            --accent: #1D4ED8;
            --success: #059669;
            --danger: #DC2626;
            --apy-line: #C9A227;
            --purple: #7856ff;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="dark"] {
            --bg: #0a0a0a;
            --bg-card: #111;
            --bg-section: #0f0f0f;
            --border: #1a1a1a;
            --text: #d0d0d0;
            --text-muted: #888;
            --text-dim: #555;
            --accent: #c9a227;
            --success: #50c878;
            --danger: #e05555;
            --apy-line: #C9A227;
            --purple: #7856ff;
            --shadow: none;
            --shadow-card: none;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, 'Inter', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            min-width: 1100px;
        }

        .number, .metric-value, .result-value {
            font-family: 'SF Mono', 'Menlo', monospace;
        }

        /* ============================================================ TOPBAR */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 32px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-title {
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.3px;
            color: var(--text);
        }
        .topbar-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: 12px;
        }
        .topbar-left { display: flex; align-items: baseline; gap: 0; }
        .topbar-right { display: flex; gap: 8px; align-items: center; }

        /* ============================================================ BUTTONS */
        button {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.15s;
        }
        button:hover { border-color: var(--accent); color: var(--accent); }
        button.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            font-weight: 600;
        }
        [data-theme="dark"] button.primary { color: #000; }
        button.primary:hover { opacity: 0.9; color: #fff; }
        [data-theme="dark"] button.primary:hover { color: #000; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }

        /* ============================================================ MAIN CONTAINER */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 32px; }

        /* ============================================================ HERO */
        .hero {
            padding: 40px 0 32px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 32px;
            transition: padding 0.3s;
        }
        .hero.ran { padding: 16px 0; margin-bottom: 24px; }
        .hero.ran .hero-title { display: none; }
        .hero.ran #how-it-works { display: none !important; }

        .hero-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .hero-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
        }
        .hero-input-row label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
        }
        .dollar-sign { font-size: 18px; font-weight: 600; color: var(--text-muted); }
        .endow-input-wrap {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            gap: 4px;
            transition: border-color 0.15s;
        }
        .endow-input-wrap:focus-within { border-color: var(--accent); }
        #endow-input {
            border: none;
            background: transparent;
            color: var(--text);
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 18px;
            font-weight: 600;
            width: 140px;
            outline: none;
        }

        .scenario-cards {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .scenario-card {
            flex: 1;
            max-width: 220px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: var(--shadow-card);
        }
        .scenario-card:hover { border-color: var(--accent); transform: translateY(-1px); }
        .scenario-card.active {
            border-color: var(--accent);
            background: var(--bg-section);
        }
        .scenario-label { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
        .scenario-sub { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
        .scenario-apy { font-family: 'SF Mono', 'Menlo', monospace; font-size: 20px; font-weight: 700; color: var(--apy-line); margin-bottom: 8px; }
        .scenario-source { font-size: 10px; color: var(--text-dim); letter-spacing: 0.3px; margin-top: 2px; }

        .run-btn {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px 40px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            display: block;
            margin-bottom: 20px;
        }
        [data-theme="dark"] .run-btn { color: #000; }
        .run-btn:hover { opacity: 0.88; transform: translateY(-1px); }

        #how-it-works {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .how-step { display: flex; align-items: center; gap: 8px; }
        .how-arrow { color: var(--text-dim); font-size: 16px; }

        /* ============================================================ RESULT CARDS */
        #result-cards {
            display: none;
            gap: 16px;
            margin-bottom: 32px;
        }
        .result-card {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px 24px;
            box-shadow: var(--shadow-card);
        }
        .result-card:first-child { border-top: 3px solid var(--success); }
        .result-card:nth-child(2) { border-top: 3px solid var(--accent); }
        .result-card:nth-child(3) { border-top: 3px solid var(--text-muted); }
        .result-value { font-size: 32px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
        .result-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px; }
        .result-sub { font-size: 12px; color: var(--text-dim); }

        .principal-note {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 32px;
            display: none;
        }

        /* ============================================================ INTERPRETATION */
        #rh-design-reading {
            display: none;
            padding: 14px 20px;
            font-size: 13px;
            line-height: 1.6;
            border-radius: 8px;
            background: var(--bg-section);
            border-left: 3px solid var(--accent);
            margin-bottom: 24px;
        }

        /* ============================================================ TWO-COL */
        .two-col-main {
            display: grid;
            grid-template-columns: 60fr 40fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        /* ============================================================ CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow-card);
            margin-bottom: 20px;
        }
        .card:last-child { margin-bottom: 0; }
        .card-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .chart-container { height: 220px; }

        /* ============================================================ ENDOWMENT PROJECTION */
        .endow-projection {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: 3px solid var(--apy-line);
            border-radius: 10px;
            padding: 22px 22px 18px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.10), 0 1px 4px rgba(0,0,0,0.06);
        }
        .endow-projection-header {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--apy-line);
            margin-bottom: 14px;
        }
        .endow-mini-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .endow-mini-item { padding: 10px 0; border-bottom: 1px solid var(--border); }
        .endow-mini-item:last-child { border-bottom: none; }
        .endow-mini-value { font-family: 'SF Mono', 'Menlo', monospace; font-size: 24px; font-weight: 700; color: var(--text); }
        .endow-mini-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .endow-mini-sub { font-size: 11px; color: var(--apy-line); margin-top: 2px; font-weight: 600; }

        /* ============================================================ ARCHETYPE COMPOSITION */
        .arch-composition {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow-card);
        }
        .arch-bar-display {
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin-bottom: 12px;
        }
        .arch-bar-segment { height: 100%; transition: width 0.4s; }
        .arch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
        }
        .arch-row-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }
        .arch-row-name { color: var(--text-muted); }
        .arch-row-pct { font-family: 'SF Mono', 'Menlo', monospace; font-weight: 600; color: var(--text); font-size: 12px; }

        /* ============================================================ AGENT GRID SECTION */
        .agent-section {
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 14px;
        }
        .sim-canvas-wrap {
            position: relative;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #f4f4f4;
            min-height: 340px;
            border: 1px solid var(--border);
        }
        [data-theme="dark"] .sim-canvas-wrap { background: #080808; }
        .agent-grid {
            display: grid;
            gap: 3px;
            padding: 20px;
            width: 100%;
            min-height: 300px;
            align-content: center;
            justify-content: center;
        }
        .agent-cell {
            width: 24px; height: 24px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.4s, box-shadow 0.4s;
        }
        .agent-cell:hover { outline: 1.5px solid rgba(0,0,0,0.5); outline-offset: 1px; z-index: 1; }
        [data-theme="dark"] .agent-cell:hover { outline-color: rgba(255,255,255,0.8); }
        .agent-cell.churned { opacity: 0.08 !important; cursor: default; }
        .agent-cell.deploy-flash { animation: cell-flash 0.5s ease-out; }
        @keyframes cell-flash {
            0% { box-shadow: inset 0 0 14px rgba(255,255,255,0.8), 0 0 6px rgba(255,255,255,0.4); }
            100% { box-shadow: none; }
        }
        .canvas-tooltip {
            display: none;
            position: absolute;
            background: rgba(255,255,255,0.97);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 11px;
            pointer-events: none;
            z-index: 50;
            max-width: 200px;
            line-height: 1.6;
            box-shadow: var(--shadow);
            color: var(--text);
        }
        [data-theme="dark"] .canvas-tooltip { background: rgba(20,20,20,0.97); }
        .canvas-tooltip .tt-id { color: var(--accent); font-weight: 600; }
        .canvas-tooltip .tt-label { color: var(--text-muted); }
        .canvas-tooltip .tt-val { color: var(--text); }

        .canvas-legend {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.92);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 14px;
            z-index: 40;
            white-space: nowrap;
        }
        [data-theme="dark"] .canvas-legend { background: rgba(10,10,10,0.88); }
        .legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-divider { width: 1px; height: 14px; background: var(--border); }
        .legend-encoding { color: var(--text-dim); font-size: 10px; }

        /* ============================================================ QUICK STATS BAR */
        .quick-stats {
            display: flex;
            gap: 2px;
            margin-bottom: 32px;
        }
        .stat-pill {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            text-align: center;
            box-shadow: var(--shadow-card);
        }
        .stat-value {
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

        /* Hidden KPI els for JS compat */
        .metric-value { display: none; }
        #participation-rate, #current-apy, #exited-count, #csv-scenario,
        #step-count, #year-display, #active-count, #total-count { display: inline; }

        /* ============================================================ ACCORDION */
        .accordion {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }
        .accordion summary {
            padding: 14px 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .accordion summary::-webkit-details-marker { display: none; }
        .accordion summary::after { content: '›'; font-size: 18px; color: var(--text-dim); transform: rotate(90deg); transition: transform 0.2s; }
        .accordion[open] summary::after { transform: rotate(270deg); }
        .accordion summary:hover { background: var(--bg-section); }
        .accordion-body { padding: 20px; border-top: 1px solid var(--border); }

        /* ============================================================ SLIDERS */
        .slider-group { display: flex; flex-direction: column; gap: 4px; margin-bottom: 14px; }
        .slider-group:last-child { margin-bottom: 0; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .slider-label { color: var(--text); }
        .slider-value { color: var(--text); font-weight: 600; font-family: 'SF Mono', 'Menlo', monospace; font-size: 13px; }
        .slider-hint { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: var(--border); border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            border-radius: 50%; background: var(--accent); cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Archetype bar (in accordion) */
        .archetype-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 14px; }
        .arch-segment { height: 100%; transition: width 0.3s; }

        .arch-legend { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; margin-bottom: 14px; }
        .arch-legend-item { display: flex; align-items: center; gap: 5px; color: var(--text-muted); }
        .arch-dot { width: 6px; height: 6px; border-radius: 50%; }

        .btn-row { display: flex; gap: 8px; margin-top: 16px; }
        .btn-row button { flex: 1; }

        .scenario-chips { display: flex; gap: 8px; margin-bottom: 16px; }
        .scenario-chip {
            background: var(--bg-section);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .scenario-chip:hover, .scenario-chip.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        [data-theme="dark"] .scenario-chip:hover,
        [data-theme="dark"] .scenario-chip.active { color: #000; }

        /* ============================================================ SELECT */
        select {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            width: 100%;
        }
        input[type="checkbox"] { accent-color: var(--accent); }
        .design-toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }
        .design-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; line-height: 1.4; }

        /* ============================================================ AGENT INSPECTOR */
        .agent-tabs { display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap; }
        .agent-tab {
            background: transparent;
            border: 1px solid var(--border);
            padding: 5px 12px;
            font-size: 12px;
            border-radius: 6px;
        }
        .agent-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        [data-theme="dark"] .agent-tab.active { color: #000; }
        .agent-content { min-height: 100px; }
        .agent-placeholder { color: var(--text-dim); font-style: italic; font-size: 13px; padding: 20px 0; }

        .agent-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .agent-table th {
            text-align: left; padding: 8px 10px;
            background: var(--bg-section);
            color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            font-weight: 600; font-size: 11px;
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0;
        }
        .agent-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        .agent-table tr:hover { background: var(--bg-section); }
        .agent-table tr.churned { opacity: 0.45; }
        .agent-table tr.highlighted { background: rgba(29,78,216,0.08); outline: 1px solid var(--accent); }
        [data-theme="dark"] .agent-table tr.highlighted { background: rgba(201,162,39,0.1); }
        .agent-id { font-family: 'SF Mono', 'Menlo', monospace; color: var(--accent); font-weight: 600; }

        .arch-badge {
            display: inline-block; padding: 2px 7px;
            border-radius: 4px; font-size: 11px; font-weight: 600;
        }
        .arch-badge.believer { background: rgba(80,200,120,0.15); color: #059669; }
        .arch-badge.yield_seeker { background: rgba(201,162,39,0.15); color: #b8911e; }
        .arch-badge.institution { background: rgba(120,86,255,0.15); color: #7856ff; }
        .arch-badge.speculator { background: rgba(220,38,38,0.15); color: #DC2626; }
        [data-theme="dark"] .arch-badge.believer { background: rgba(80,200,120,0.2); color: #50c878; }
        [data-theme="dark"] .arch-badge.yield_seeker { background: rgba(201,162,39,0.2); color: #c9a227; }
        [data-theme="dark"] .arch-badge.institution { background: rgba(120,86,255,0.2); color: #7856ff; }
        [data-theme="dark"] .arch-badge.speculator { background: rgba(224,85,85,0.2); color: #e05555; }

        /* ============================================================ ARCHETYPE METRICS */
        .arch-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        .arch-metric-card {
            background: var(--bg-section);
            border-radius: 8px; padding: 12px;
            border-left: 3px solid var(--border);
        }
        .arch-metric-card.believer { border-left-color: #50c878; }
        .arch-metric-card.yield_seeker { border-left-color: #c9a227; }
        .arch-metric-card.institution { border-left-color: #7856ff; }
        .arch-metric-card.speculator { border-left-color: #e05555; }
        .arch-card-name { font-weight: 700; margin-bottom: 6px; font-size: 12px; }
        .arch-card-name.believer { color: #50c878; }
        .arch-card-name.yield_seeker { color: #c9a227; }
        .arch-card-name.institution { color: #7856ff; }
        .arch-card-name.speculator { color: #e05555; }
        .arch-stat { display: flex; justify-content: space-between; color: var(--text-muted); padding: 2px 0; font-size: 11px; }
        .arch-stat-val { color: var(--text); font-family: 'SF Mono', 'Menlo', monospace; font-size: 11px; }

        /* ============================================================ PROPOSALS / EVENTS */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .list { max-height: 360px; overflow-y: auto; }
        .list-item {
            background: var(--bg-section); padding: 8px 12px;
            border-radius: 6px; margin-bottom: 6px;
            display: flex; justify-content: space-between;
            align-items: center; font-size: 12px;
        }
        .proposal-id { font-weight: 600; color: var(--text); font-family: 'SF Mono', 'Menlo', monospace; }
        .progress-bar { width: 80px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 8px; overflow: hidden; flex-shrink: 0; }
        .progress-fill { height: 100%; background: var(--success); border-radius: 2px; }
        .progress-pct { font-size: 11px; color: var(--text-dim); min-width: 32px; text-align: right; }
        .status { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-open { color: #2563eb; }
        .status-funded { color: var(--success); }
        .status-completed { color: var(--success); }
        .status-failed { color: var(--danger); }

        .event { padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
        .event:last-child { border-bottom: none; }
        .event-type { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-right: 6px; }
        .event-type.funded { background: rgba(5,150,105,0.15); color: var(--success); }
        .event-type.completed { background: rgba(5,150,105,0.15); color: var(--success); }
        .event-type.failed { background: rgba(220,38,38,0.15); color: var(--danger); }
        .event-type.new_proposal { background: rgba(29,78,216,0.12); color: var(--accent); }
        .event-type.init { background: rgba(201,162,39,0.15); color: var(--apy-line); }
        .event-type.churn { background: rgba(220,38,38,0.10); color: #c07070; }

        /* ============================================================ CHART SWITCHER */
        .chart-view-switcher {
            display: flex; gap: 0; border: 1px solid var(--border);
            border-radius: 6px; overflow: hidden; margin-bottom: 14px;
        }
        .chart-view-btn {
            background: transparent; border: none;
            border-right: 1px solid var(--border);
            color: var(--text-muted); padding: 6px 14px;
            font-size: 12px; font-family: inherit; cursor: pointer;
        }
        .chart-view-btn:last-child { border-right: none; }
        .chart-view-btn:hover { color: var(--text); }
        .chart-view-btn.active { background: var(--accent); color: #fff; font-weight: 600; }
        [data-theme="dark"] .chart-view-btn.active { color: #000; }

        /* ============================================================ NARRATIVE / SUMMARY */
        .narrative { font-size: 13px; line-height: 1.7; }
        .narrative-placeholder { color: var(--text-dim); font-style: italic; }
        .narrative-highlight { color: var(--accent); font-weight: 600; }
        .narrative-success { color: var(--success); }
        .narrative-danger { color: var(--danger); }
        .narrative p { margin-bottom: 8px; }
        .narrative p:last-child { margin-bottom: 0; }

        .summary-panel { background: var(--bg-section); border-radius: 8px; padding: 16px; border-left: 3px solid var(--apy-line); }
        .summary-delta { display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px; }
        .delta-label { color: var(--text-muted); }
        .delta-pos { color: var(--success); }
        .delta-neg { color: var(--danger); }
        .tension-warning { margin-top: 10px; padding: 10px; background: rgba(220,38,38,0.08); border-radius: 6px; border: 1px solid rgba(220,38,38,0.25); font-size: 12px; color: var(--danger); }
        .detail-toggle { color: var(--text-muted); font-size: 12px; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 10px; }
        .detail-toggle:hover { color: var(--accent); }

        /* ============================================================ MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-body { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; max-width: 820px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 22px; cursor: pointer; padding: 0 4px; }
        .modal-close:hover { color: var(--text); }

        .scenario-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .scenario-table th, .scenario-table td { padding: 7px 12px; border: 1px solid var(--border); text-align: right; }
        .scenario-table th { background: var(--bg-section); color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .scenario-table th:first-child, .scenario-table td:first-child { text-align: left; }

        /* ============================================================ SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ============================================================ FRAMING STRIP */
        .framing-strip {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-muted);
        }
        .framing-strip strong { color: var(--text); font-weight: 600; }
        .framing-strip .framing-mechanism {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        .framing-step {
            background: var(--bg-section);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 12px;
            white-space: nowrap;
        }
        .framing-arrow { color: var(--text-dim); font-size: 16px; }
        .framing-sources {
            margin-top: 12px;
            border-top: 1px solid var(--border);
            padding-top: 10px;
        }
        .framing-sources summary {
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .framing-sources summary::-webkit-details-marker { display: none; }
        .framing-sources[open] summary { color: var(--text-muted); margin-bottom: 12px; }
        .framing-sources-body { display: flex; flex-direction: column; gap: 10px; }
        .framing-source-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        .source-tag {
            flex-shrink: 0;
            background: var(--bg-section);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--accent);
            white-space: nowrap;
            margin-top: 2px;
        }
        .source-tag:last-of-type { color: var(--text-muted); }

        /* ============================================================ WHAT HAPPENED (merged interpretation + summary) */
        #what-happened {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 3px solid var(--apy-line);
            border-radius: 10px;
            padding: 18px 22px;
            margin: 20px 0;
        }
        .what-happened-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        #what-happened .narrative { font-size: 13.5px; line-height: 1.75; }

        /* ============================================================ GRID ARCH STRIP */
        .grid-arch-strip {
            display: flex;
            gap: 20px;
            margin-top: 14px;
            flex-wrap: wrap;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }
        .grid-arch-item {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 12px;
        }
        .grid-arch-dot {
            width: 10px; height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .grid-arch-name { color: var(--text-muted); }
        .grid-arch-val { font-family: 'SF Mono', monospace; color: var(--text); font-size: 11px; }

        /* ============================================================ SIM CONTROLS */
        .sim-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin: 20px 0 24px;
            flex-wrap: wrap;
        }
        .sim-controls-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-right: 4px;
            white-space: nowrap;
        }
        .sim-btn {
            padding: 7px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.12s;
            font-family: inherit;
        }
        .sim-btn:hover { background: var(--bg-section); border-color: var(--accent); color: var(--accent); }
        .sim-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            font-weight: 600;
            padding: 7px 20px;
        }
        .sim-btn.primary:hover { opacity: 0.88; }
        .sim-btn.danger { color: var(--danger); }
        .sim-btn.danger:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .sim-controls-spacer { flex: 1; }
        .sim-divider { width: 1px; height: 18px; background: var(--border); margin: 0 4px; flex-shrink: 0; }
        .step-counter {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            font-family: 'SF Mono', 'Menlo', monospace;
            padding: 5px 12px;
            background: var(--bg-section);
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        @keyframes sim-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .sim-btn.running {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            font-weight: 600;
            padding: 7px 20px;
            animation: sim-pulse 1.4s ease-in-out infinite;
        }
        .sim-btn.running:hover { opacity: 0.88; animation: none; }
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-dim);
            font-size: 12px;
            font-style: italic;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
        }
        .chart-container { position: relative; }
        .chart-container canvas { display: block; }

        /* ============================================================ MISC */
        .footnote { font-size: 11px; color: var(--text-dim); margin-top: 8px; }

        /* Death spiral callout */
        .death-spiral-box {
            margin-top: 14px;
            padding: 10px 14px;
            background: rgba(120, 86, 255, 0.07);
            border-left: 3px solid var(--purple);
            border-radius: 0 6px 6px 0;
            font-size: 13px;
            line-height: 1.55;
        }
        [data-theme="dark"] .death-spiral-box { background: rgba(120, 86, 255, 0.13); }

        /* Endowment comparison table */
        .endow-compare {
            display: none;
            margin: 14px 0 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            font-size: 13px;
        }
        .endow-compare-header {
            display: grid;
            grid-template-columns: 1.4fr 1fr 1fr;
            background: var(--bg-section);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-muted);
        }
        .endow-compare-header span, .endow-compare-row span { padding: 8px 12px; }
        .endow-compare-row {
            display: grid;
            grid-template-columns: 1.4fr 1fr 1fr;
            border-bottom: 1px solid var(--border);
        }
        .endow-compare-row:last-child { border-bottom: none; }
        .endow-compare-row span:first-child { color: var(--text-muted); }
        .endow-compare-row .cash { color: var(--danger); font-family: 'SF Mono', 'Menlo', monospace; }
        .endow-compare-row .rsc-good { color: var(--success); font-weight: 600; font-family: 'SF Mono', 'Menlo', monospace; }

        /* Burn coverage stat */
        .burn-coverage-good { color: var(--success); }
        .burn-coverage-warn { color: var(--apy-line); }
        .burn-coverage-bad { color: var(--danger); }
        .stat-sublabel { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        hr.section-divider { border: none; border-top: 1px solid var(--border); margin: 32px 0; }

        /* Multiplier bar */
        #multiplier-detail-bar { display: flex; gap: 3px; height: 16px; margin-bottom: 6px; }
        #multiplier-detail-legend { font-size: 11px; color: var(--text-muted); line-height: 1.6; }
        #rsc-by-archetype { font-size: 12px; line-height: 2; }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-left">
            <span class="topbar-title">RSC Endowment Simulator</span>
            <span class="topbar-subtitle">Model how $1M RSC earns yield and funds science</span>
        </div>
        <div class="topbar-right">
            <button onclick="openScenarioModal()" class="btn-sm">Compare Scenarios</button>
            <button id="theme-toggle-btn" onclick="toggleTheme()" class="btn-sm">Dark mode</button>
        </div>
    </div>

    <!-- ============================================================ MAIN CONTAINER -->
    <div class="container">

        <!-- ============================================================ FRAMING -->
        <div class="framing-strip">
            <strong>What is this?</strong> &nbsp;RSC is ResearchHub's native token. When you hold RSC in your RH account, you earn yield automatically — no lockups, no active management. That yield comes as <strong>funding credits</strong> you deploy to research proposals. Your principal (RSC) is never spent.
            <div class="framing-mechanism">
                <span class="framing-step">Hold RSC in your RH account</span>
                <span class="framing-arrow">&#8594;</span>
                <span class="framing-step">Earn funding credits (yield)</span>
                <span class="framing-arrow">&#8594;</span>
                <span class="framing-step">Deploy to research proposals</span>
            </div>
            <strong>Endowment, simply:</strong> you spend the interest, never the balance. Your RSC is permanent — it stays yours. The yield (funding credits) is what flows to research, year after year, indefinitely. One deposit → perpetual funding.
            <br><br><strong>Why yields self-balance — the math:</strong> Your yield = your RSC ÷ total RSC held in RH × annual emissions. More holders deposit RSC into RH → each person's share shrinks → yield falls. Some withdraw → shares grow → yield rises. No one controls this. It's automatic. The three scenarios below show where RH expects the market to naturally settle.
            <div class="death-spiral-box">
                <strong>&#9889; The DeFi death spiral — and why this breaks it:</strong> High yield attracts capital → stakers receive liquid tokens → they sell immediately → token price crashes → yield collapses. Most DeFi protocols die this way. ResearchHub's move: yield arrives as <strong>non-transferable funding credits</strong>. Credits cannot be sold on an exchange — they can only be deployed to research proposals. Protocol inflation funds science instead of speculators. What would be sell pressure becomes research funding.
            </div>
            <details class="framing-sources">
                <summary>&#128196; Sources &amp; grounding — what in this simulator comes directly from RH docs</summary>
                <div class="framing-sources-body">
                    <div class="framing-source-row">
                        <span class="source-tag">RH Product Doc</span>
                        <span>The three scenarios (15% / 30% / 70% of circulating RSC) and their Year 1 APY values (47.2% / 23.6% / 10.1%) are quoted verbatim. "30% = Anticipated average" is RH's own label. The $1M → ~$236K Year 1 example is from the doc.</span>
                    </div>
                    <div class="framing-source-row">
                        <span class="source-tag">RH Yield Model CSV</span>
                        <span>Circulating supply figures (134.2M RSC at Year 0, growing annually) and the full emission schedule come from RH's published yield model spreadsheet. The dashed reference lines on both charts trace exact rows from that CSV.</span>
                    </div>
                    <div class="framing-source-row">
                        <span class="source-tag">RH Product Doc</span>
                        <span>Emission formula E(t) = 9,500,000 / 2^(t/64) — halves every 64 years. Time-weight multipliers: 0–30 days 1.0×, 30–365 days 1.15×, 365+ days 1.2×. The self-balancing mechanic description is quoted from the doc.</span>
                    </div>
                    <div class="framing-source-row">
                        <span class="source-tag">Modeled</span>
                        <span><strong>Institutions</strong> and <strong>Yield Seekers</strong> are directly grounded: the product doc's primary use case is a $1M institutional grant, and the self-balancing section explicitly describes yield-sensitive actors who join on high yields and withdraw on low. <strong>Believers</strong> are inferred from "these credits can only fund research — the more RSC you hold, the more science you fund." <strong>Speculators</strong> are a modeling assumption based on the CRV comparison and the "death spiral" passage. Behavioral parameters (exit thresholds, hold horizons) are calibrated judgments, not from RH docs.</span>
                    </div>
                </div>
            </details>
        </div>

        <!-- ============================================================ HERO -->
        <section class="hero" id="hero-section">
            <div class="hero-title">RSC Endowment Calculator</div>
            <div class="hero-input-row">
                <label for="endow-input">Your endowment amount:</label>
                <div class="endow-input-wrap">
                    <span class="dollar-sign">$</span>
                    <input type="number" id="endow-input" value="1000000" min="1000" step="10000" oninput="updateEndowmentCard()">
                </div>
            </div>
            <div class="scenario-cards">
                <div class="scenario-card" id="card-conservative" onclick="selectScenario('conservative')">
                    <div class="scenario-label">Conservative</div>
                    <div class="scenario-sub">15% of circulating RSC held in RH</div>
                    <div class="scenario-apy">~47% APY</div>
                    <div class="scenario-source">↗ RH Product Doc</div>
                </div>
                <div class="scenario-card active" id="card-expected" onclick="selectScenario('expected')">
                    <div class="scenario-label">Expected</div>
                    <div class="scenario-sub">30% of circulating RSC held in RH</div>
                    <div class="scenario-apy">~24% APY</div>
                    <div class="scenario-source">↗ RH Product Doc · Anticipated average</div>
                </div>
                <div class="scenario-card" id="card-high" onclick="selectScenario('high')">
                    <div class="scenario-label">High</div>
                    <div class="scenario-sub">70% of circulating RSC held in RH</div>
                    <div class="scenario-apy">~10% APY</div>
                    <div class="scenario-source">↗ RH Product Doc</div>
                </div>
            </div>
            <div id="how-it-works">
                <div class="how-step">Hold RSC in RH</div>
                <span class="how-arrow">&#8594;</span>
                <div class="how-step">Earn Credits Automatically</div>
                <span class="how-arrow">&#8594;</span>
                <div class="how-step">Fund Science</div>
            </div>
        </section>

        <!-- ============================================================ RESULT CARDS -->
        <div id="result-cards" style="display:none">
            <div class="result-card">
                <div class="result-label">Year 1 Credits</div>
                <div class="result-value" id="endow-yr1">—</div>
                <div class="result-sub" id="endow-apy-label">at —% APY</div>
            </div>
            <div class="result-card">
                <div class="result-label">10-Year Total</div>
                <div class="result-value" id="endow-yr10">—</div>
                <div class="result-sub" id="endow-yr10-apy">Year 10 APY: —%</div>
            </div>
            <div class="result-card">
                <div class="result-label">Principal Retained</div>
                <div class="result-value" id="endow-principal">$1,000,000</div>
                <div class="result-sub">RSC not spent or locked</div>
            </div>
        </div>
        <div class="principal-note" id="principal-note">
            Your $1M of RSC is never spent or locked. Funding credits fund science — non-transferable, no DeFi complexity.
        </div>

        <!-- Endowment comparison vs cash donation -->
        <div class="endow-compare" id="endow-compare">
            <div class="endow-compare-header">
                <span>Scenario</span>
                <span>Cash Donation</span>
                <span>RSC Endowment</span>
            </div>
            <div class="endow-compare-row">
                <span>Principal after gift</span>
                <span class="cash">$0 (donated)</span>
                <span class="rsc-good" id="compare-rsc-principal">—</span>
            </div>
            <div class="endow-compare-row">
                <span>Year 1 science funding</span>
                <span class="cash" id="compare-cash-yr1">—</span>
                <span class="rsc-good" id="compare-rsc-yr1">—</span>
            </div>
            <div class="endow-compare-row">
                <span>10-year science funding</span>
                <span class="cash" id="compare-cash-yr10">—</span>
                <span class="rsc-good" id="compare-rsc-yr10">—</span>
            </div>
            <div class="endow-compare-row">
                <span>Principal at year 10</span>
                <span class="cash">$0</span>
                <span class="rsc-good" id="compare-rsc-principal-10">—</span>
            </div>
        </div>

        <!-- ============================================================ WHAT HAPPENED (post-run interpretation) -->
        <div id="what-happened">
            <div class="what-happened-label">&#128202; What happened</div>
            <div class="narrative" id="what-happened-body"></div>
            <a href="#" class="detail-toggle" onclick="toggleMetricDetails(event)">Show detailed metrics &#9656;</a>
            <div id="metric-details" style="display:none; margin-top:10px"></div>
        </div>

        <!-- ============================================================ SIM CONTROLS -->
        <div class="sim-controls">
            <button class="sim-btn" id="btn-setup" onclick="setupSim()">&#8635; Setup</button>
            <div class="sim-divider"></div>
            <button class="sim-btn" id="btn-step" onclick="step()">&#9654; +1 wk</button>
            <button class="sim-btn" id="btn-10wk" onclick="run(10)">+10 wk</button>
            <button class="sim-btn" id="btn-1yr" onclick="run(52)">+1 yr</button>
            <div class="sim-divider"></div>
            <button class="sim-btn primary" id="btn-go" onclick="toggleGo()">&#9654;&#9654; Go</button>
            <div class="sim-controls-spacer"></div>
            <div class="step-counter">Wk&nbsp;<span id="step-counter-wk">0</span>&nbsp;/&nbsp;Yr&nbsp;<span id="step-counter-yr">0.0</span></div>
        </div>

        <!-- ============================================================ TWO-COL: Charts + Projection -->
        <div class="two-col-main" id="main-content">
            <!-- LEFT: Charts (participation first — it's the primary story) -->
            <div>
                <div class="card">
                    <div class="card-header">Archetype Composition — Who's Holding RSC</div>
                    <div class="chart-container">
                        <canvas id="participation-chart"></canvas>
                        <div class="chart-placeholder" id="participation-placeholder">Run simulation to populate</div>
                    </div>
                    <div class="footnote">Total RSC held, stacked by holder type. A healthy endowment has a thick <strong style="color:#10b981">Believer</strong> + <strong style="color:#7c3aed">Institution</strong> base — sticky holders who anchor the system when yield fluctuates. <strong style="color:#f59e0b">Yield Seekers</strong> self-regulate; <strong style="color:#ef4444">Speculators</strong> exit first.</div>
                </div>
                <div class="card">
                    <div class="card-header">Science Funding vs Protocol Cost — Is This Sustainable?</div>
                    <div class="chart-container">
                        <canvas id="apy-chart"></canvas>
                        <div class="chart-placeholder" id="apy-placeholder">Run simulation to populate</div>
                    </div>
                    <div class="footnote"><strong style="color:#059669">Bars</strong> = RSC credits deployed to research each week. <strong style="color:#e05555">Red line</strong> = cumulative RSC emitted (protocol cost). <strong style="color:#1D4ED8">Blue dashed</strong> = cumulative RSC burned. The gap is RH's acknowledged sustainability challenge.</div>
                </div>
            </div>

            <!-- RIGHT: Endowment Projection + Archetype Composition -->
            <div>
                <!-- Endowment projection (compact, live-updating) -->
                <div class="endow-projection">
                    <div class="endow-projection-header">Your Endowment Projection</div>
                    <div class="endow-mini-grid">
                        <div class="endow-mini-item">
                            <div class="endow-mini-value" id="endow-yr1-r">—</div>
                            <div class="endow-mini-label">Year 1 credits</div>
                            <div class="endow-mini-sub" id="endow-apy-label-r">at —% APY</div>
                        </div>
                        <div class="endow-mini-item">
                            <div class="endow-mini-value" id="endow-yr10-r">—</div>
                            <div class="endow-mini-label">10-year total</div>
                            <div class="endow-mini-sub" id="endow-yr10-apy-r">Year 10 APY: —%</div>
                        </div>
                    </div>
                    <div class="footnote" style="margin-top:10px">Principal: <strong id="endow-principal-r">$1,000,000</strong> — always retained. Credits may qualify for charitable deduction.</div>
                    <div id="endow-sparkline-wrap" style="display:none; margin-top:16px">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:5px;letter-spacing:0.3px">ANNUAL CREDITS — YEARS 1 – 10</div>
                        <div style="position:relative;height:68px"><canvas id="endow-sparkline"></canvas></div>
                        <div style="font-size:10px;color:var(--text-muted);margin-top:5px">Gentle tapering as the 9.5M RSC/yr emission halves every 64 years. Principal never touched.</div>
                    </div>
                </div>

                <!-- Hidden elements kept for JS compat -->
                <div style="display:none">
                    <div id="arch-bar"></div>
                    <div id="arch-composition-rows"></div>
                    <div id="multiplier-detail-bar"></div>
                    <div id="multiplier-detail-legend"></div>
                    <div id="rsc-by-archetype"></div>
                </div>
            </div>
        </div>

        <!-- ============================================================ AGENT GRID -->
        <div class="agent-section" id="grid-section">
            <div class="section-title">Active Holders — Each dot is one RSC holder</div>
            <div class="sim-canvas-wrap">
                <div id="agent-grid" class="agent-grid"></div>
                <div class="canvas-tooltip" id="canvas-tooltip"></div>
                <div class="canvas-legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#50c878"></div> Believer</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#c9a227"></div> Return-Sensitive</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#7856ff"></div> Institution</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#e05555"></div> Speculator</div>
                    <div class="legend-divider"></div>
                    <span class="legend-encoding">Opacity = Hold Duration &nbsp;(dim = new, bright = long-term 1.2×)</span>
                    <span class="legend-encoding">&nbsp;|&nbsp; Glow = Deploying Credits</span>
                </div>
            </div>
            <!-- Archetype breakdown strip — populated by JS -->
            <div class="grid-arch-strip" id="grid-arch-strip"></div>
        </div>

        <!-- ============================================================ QUICK STATS BAR -->
        <div class="quick-stats" id="quick-stats">
            <div class="stat-pill">
                <div class="stat-value"><span id="participation-rate">0%</span></div>
                <div class="stat-label">Participation Rate</div>
            </div>
            <div class="stat-pill">
                <div class="stat-value"><span id="current-apy" style="color:var(--success)">0%</span></div>
                <div class="stat-label">Current APY</div>
            </div>
            <div class="stat-pill">
                <div class="stat-value"><span id="active-count">0</span> / <span id="total-count">0</span></div>
                <div class="stat-label">Active / Total Holders</div>
            </div>
            <div class="stat-pill">
                <div class="stat-value"><span id="exited-count" style="color:var(--danger)">0</span></div>
                <div class="stat-label">Exited</div>
            </div>
            <div class="stat-pill">
                <div class="stat-value">Wk <span id="step-count">0</span> / Yr <span id="year-display">0.0</span></div>
                <div class="stat-label">Simulation Time</div>
            </div>
            <div class="stat-pill">
                <div class="stat-value"><span id="burn-coverage">—</span></div>
                <div class="stat-label">Burn Coverage</div>
                <div class="stat-sublabel" id="burn-coverage-sub">burns ÷ emissions</div>
            </div>
        </div>

        <!-- ============================================================ ACCORDIONS -->

        <!-- ACCORDION 1: Adjust the scenario -->
        <details class="accordion">
            <summary>Adjust the Scenario</summary>
            <div class="accordion-body">
                <div class="scenario-chips">
                    <button class="scenario-chip active" id="chip-conservative" onclick="selectScenarioAndApply('conservative', this)">Conservative (15%)</button>
                    <button class="scenario-chip" id="chip-expected" onclick="selectScenarioAndApply('expected', this)">Expected (30%)</button>
                    <button class="scenario-chip" id="chip-high" onclick="selectScenarioAndApply('high', this)">High (70%)</button>
                </div>
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Initial Participation</span>
                        <span class="slider-value" id="val-participation">30%</span>
                    </div>
                    <input type="range" id="slider-participation" min="5" max="80" value="30" step="5"
                        oninput="document.getElementById('val-participation').textContent=this.value+'%'">
                    <div class="slider-hint">% of circulating RSC (134.2M) held in RH at start. 15% = high yield; 70% = diluted yield. Market self-corrects from here.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Yield Threshold</span>
                        <span class="slider-value" id="val-threshold">8%</span>
                    </div>
                    <input type="range" id="slider-threshold" min="2" max="30" value="8" step="1"
                        oninput="document.getElementById('val-threshold').textContent=this.value+'%'">
                    <div class="slider-hint">Average APY below which agents consider exiting.</div>
                </div>

                <div style="margin-top:16px;margin-bottom:8px">
                    <div class="card-header" style="border:none;padding:0;margin-bottom:10px">Archetype Mix</div>
                    <div class="archetype-bar" id="arch-bar-accordion">
                        <!-- mirrors arch-bar, updated by updateArchBarAccordion() -->
                    </div>
                    <div class="arch-legend">
                        <div class="arch-legend-item"><div class="arch-dot" style="background:#50c878"></div> Believer</div>
                        <div class="arch-legend-item"><div class="arch-dot" style="background:#c9a227"></div> Yield Seeker</div>
                        <div class="arch-legend-item"><div class="arch-dot" style="background:#7856ff"></div> Institution</div>
                        <div class="arch-legend-item"><div class="arch-dot" style="background:#e05555"></div> Speculator</div>
                    </div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Believers</span><span class="slider-value" id="val-believer">25%</span></div>
                    <input type="range" id="slider-believer" min="5" max="85" value="25" step="5" oninput="handleArchSliderChange('believer')">
                    <div class="slider-hint">Mission-driven. Hold long-term (1.2×), deploy reliably, stay through low yields.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Return-Sensitive Holders</span><span class="slider-value" id="val-yield_seeker">35%</span></div>
                    <input type="range" id="slider-yield_seeker" min="5" max="85" value="35" step="5" oninput="handleArchSliderChange('yield_seeker')">
                    <div class="slider-hint">Return-focused. Join when APY is high, exit when it falls. The self-balancing force.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Institutions</span><span class="slider-value" id="val-institution">15%</span></div>
                    <input type="range" id="slider-institution" min="5" max="85" value="15" step="5" oninput="handleArchSliderChange('institution')">
                    <div class="slider-hint">Universities/foundations. Large RSC, very long-term, near-zero yield sensitivity. Anchors participation.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Speculators</span><span class="slider-value" id="val-speculator">25%</span></div>
                    <input type="range" id="slider-speculator" min="5" max="85" value="25" step="5" oninput="handleArchSliderChange('speculator')">
                    <div class="slider-hint">Short-term. Enter on high yield, exit quickly. Amplifies participation swings.</div>
                </div>
                <div class="btn-row">
                    <button class="primary" onclick="resetWithParams()">Apply &amp; Reset</button>
                    <button onclick="resetSliders()">Defaults</button>
                    <button onclick="saveScenario()">Save Scenario</button>
                </div>
            </div>
        </details>

        <!-- ACCORDION 2: Advanced parameters -->
        <details class="accordion">
            <summary>Advanced Parameters</summary>
            <div class="accordion-body">
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Deploy Rate</span><span class="slider-value" id="val-deploy">30%</span></div>
                    <input type="range" id="slider-deploy" min="0" max="100" value="30" step="5" oninput="document.getElementById('val-deploy').textContent=this.value+'%'">
                    <div class="slider-hint">How actively holders fund proposals with their credits.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Proposal Success</span><span class="slider-value" id="val-success">80%</span></div>
                    <input type="range" id="slider-success" min="20" max="100" value="80" step="5" oninput="document.getElementById('val-success').textContent=this.value+'%'">
                    <div class="slider-hint">How often funded research delivers results.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Holders</span><span class="slider-value" id="val-holders">100</span></div>
                    <input type="range" id="slider-holders" min="20" max="500" value="100" step="10" oninput="document.getElementById('val-holders').textContent=this.value">
                    <div class="slider-hint">Initial number of RSC holders in the simulation.</div>
                </div>
                <div class="slider-group">
                    <div class="slider-header"><span class="slider-label">Burn Rate</span><span class="slider-value" id="val-burn">2%</span></div>
                    <input type="range" id="slider-burn" min="0.5" max="10" value="2" step="0.5" oninput="document.getElementById('val-burn').textContent=this.value+'%'">
                    <div class="slider-hint">Fee burned when credits are deployed to proposals.</div>
                </div>
                <div class="design-toggle-row">
                    <label><input type="checkbox" id="chk-credit-expiry" onchange="updateDesignLabState()"> Credit Expiry</label>
                </div>
                <div id="credit-expiry-controls" style="display:none">
                    <div class="slider-group" style="margin-top:8px">
                        <div class="slider-header"><span class="slider-label">Expiry Period</span><span class="slider-value" id="val-expiry-weeks">8 wk</span></div>
                        <input type="range" id="slider-expiry-weeks" min="4" max="16" value="8" step="1" oninput="document.getElementById('val-expiry-weeks').textContent=this.value+' wk'">
                    </div>
                    <div class="design-hint">Unused credits expire, creating deployment urgency.</div>
                </div>
                <div class="design-toggle-row" style="margin-top:10px"><label>Failure Mode</label></div>
                <select id="select-failure-mode" onchange="updateFailureModeHint()">
                    <option value="nothing">Nothing (credits consumed)</option>
                    <option value="partial_refund">Partial Refund (50% credits back)</option>
                </select>
                <div class="design-hint" id="failure-mode-hint">Backers lose deployed credits; RSC held is unaffected.</div>
                <div class="btn-row"><button class="primary" onclick="resetWithParams()">Apply &amp; Reset</button></div>
            </div>
        </details>

        <!-- ACCORDION 3: Data tables -->
        <details class="accordion">
            <summary>Data Tables &amp; Inspector</summary>
            <div class="accordion-body">
                <div class="arch-metrics-grid" id="arch-metrics" style="margin-bottom:20px"></div>
                <div class="agent-tabs">
                    <button class="agent-tab active" onclick="showAgentTab('top-stakers', this)">Top Holders</button>
                    <button class="agent-tab" onclick="showAgentTab('recent-deployers', this)">Deployers</button>
                    <button class="agent-tab" onclick="showAgentTab('by-archetype', this)">By Archetype</button>
                    <button class="agent-tab" onclick="showAgentTab('churned', this)">Exited</button>
                </div>
                <div id="agent-content" class="agent-content" style="max-height:420px;overflow-y:auto;">
                    <div class="agent-placeholder">Run the simulation to inspect holders.</div>
                </div>
            </div>
        </details>

        <!-- ACCORDION 4: Details -->
        <details class="accordion" style="margin-bottom:40px">
            <summary>Detailed Time Series &amp; Events</summary>
            <div class="accordion-body">
                <div class="card-header">Time Series</div>
                <div class="chart-view-switcher">
                    <button class="chart-view-btn active" data-view="token-economics" onclick="switchChartView('token-economics')">Token Economics</button>
                    <button class="chart-view-btn" data-view="agent-health" onclick="switchChartView('agent-health')">Agent Health</button>
                    <button class="chart-view-btn" data-view="funding-flow" onclick="switchChartView('funding-flow')">Funding Flow</button>
                </div>
                <div class="chart-container" style="margin-bottom:20px"><canvas id="history-chart"></canvas></div>
                <div class="two-col">
                    <div>
                        <div class="card-header">Proposals</div>
                        <div class="list" id="proposals-list"></div>
                    </div>
                    <div>
                        <div class="card-header">Event Log</div>
                        <div class="list" id="events-list" style="max-height:360px;overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </details>

    </div><!-- /container -->

    <!-- Scenario Comparison Modal -->
    <div class="modal-overlay" id="scenario-modal">
        <div class="modal-body">
            <div class="modal-header">
                <div style="font-size:15px;font-weight:700">Scenario Comparison</div>
                <button class="modal-close" onclick="closeScenarioModal()">&times;</button>
            </div>
            <div id="scenario-compare-content">
                <p style="color:var(--text-dim);font-size:13px">Save scenarios from "Adjust the Scenario" to compare them here.</p>
            </div>
            <div style="margin-top:12px">
                <div id="saved-scenarios-list" style="font-size:12px;color:var(--text-muted)">No saved scenarios</div>
                <button onclick="clearScenarios()" class="btn-sm" style="margin-top:10px">Clear All</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // DotGrid — agent field mosaic renderer
        // ============================================================
        class DotGrid {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.cells = [];
                this.archColors = {
                    believer:     '#50c878',
                    yield_seeker: '#c9a227',
                    institution:  '#7856ff',
                    speculator:   '#e05555',
                };
            }

            update(stakers, stepDeployments) {
                const archOrder = ['believer', 'yield_seeker', 'institution', 'speculator'];
                const sorted = [...stakers].sort((a, b) => {
                    const ai = archOrder.indexOf(a.archetype);
                    const bi = archOrder.indexOf(b.archetype);
                    if (ai !== bi) return ai - bi;
                    return b.stake - a.stake;
                });
                const deployerIds = new Set();
                if (stepDeployments) stepDeployments.forEach(d => deployerIds.add(d.staker_id));

                const cols = Math.ceil(Math.sqrt(sorted.length));
                this.container.style.gridTemplateColumns = 'repeat(' + cols + ', 24px)';

                if (this.cells.length !== sorted.length) {
                    this.container.innerHTML = '';
                    this.cells = [];
                    sorted.forEach(() => {
                        const cell = document.createElement('div');
                        cell.className = 'agent-cell';
                        this._attachEvents(cell);
                        this.container.appendChild(cell);
                        this.cells.push(cell);
                    });
                }
                sorted.forEach((s, i) => {
                    const cell = this.cells[i];
                    cell._staker = s;
                    this._updateCell(cell, s, deployerIds.has(s.id));
                });
            }

            _updateCell(cell, s, hasDeployment) {
                const color = this.archColors[s.archetype] || '#888';
                if (!s.active) {
                    cell.style.backgroundColor = color;
                    cell.style.opacity = '0.08';
                    cell.style.boxShadow = 'none';
                    cell.className = 'agent-cell churned';
                    return;
                }
                cell.className = 'agent-cell';
                cell.style.backgroundColor = color;
                const holdAlpha = s.multiplier_label === 'LongTerm' ? 0.95 : s.multiplier_label === 'Holder' ? 0.65 : 0.35;
                cell.style.opacity = holdAlpha.toFixed(2);

                const pressure = s.credits_pressure || 0;
                if (pressure > 0.2) {
                    const glowSize = 3 + pressure * 4;
                    const glowAlpha = Math.min(pressure * 0.35, 0.7);
                    const glowColor = isLightMode() ? '0,0,0' : '255,255,255';
                    cell.style.boxShadow = 'inset 0 0 ' + glowSize.toFixed(0) + 'px rgba(' + glowColor + ',' + glowAlpha.toFixed(2) + ')';
                } else {
                    cell.style.boxShadow = 'none';
                }
                if (hasDeployment) {
                    cell.classList.remove('deploy-flash');
                    void cell.offsetWidth;
                    cell.classList.add('deploy-flash');
                }
            }

            _attachEvents(cell) {
                cell.addEventListener('mouseenter', () => {
                    const s = cell._staker;
                    if (!s) return;
                    const tooltip = document.getElementById('canvas-tooltip');
                    tooltip.innerHTML =
                        '<div><span class="tt-id">' + s.id + '</span> <span class="tt-label">(' + s.archetype + ')</span></div>' +
                        '<div><span class="tt-label">RSC:</span> <span class="tt-val">' + formatNumber(s.rsc_held || s.stake || 0) + '</span></div>' +
                        '<div><span class="tt-label">Hold:</span> <span class="tt-val">' + (s.weeks_held || 0) + 'wk (' + (s.multiplier_label || 'New') + ' ' + (s.multiplier || 1).toFixed(2) + 'x)</span></div>' +
                        '<div><span class="tt-label">Credits:</span> <span class="tt-val">' + formatNumber(s.credits) + '</span></div>' +
                        '<div><span class="tt-label">Threshold:</span> <span class="tt-val">' + ((s.yield_threshold || 0) * 100).toFixed(1) + '%</span></div>' +
                        '<div><span class="tt-label">Deployed:</span> <span class="tt-val">' + formatNumber(s.total_deployed) + '</span></div>';
                    tooltip.style.display = 'block';
                    const rect = cell.getBoundingClientRect();
                    const wrapRect = cell.closest('.sim-canvas-wrap').getBoundingClientRect();
                    tooltip.style.left = Math.min(rect.right - wrapRect.left + 8, wrapRect.width - 220) + 'px';
                    tooltip.style.top = (rect.top - wrapRect.top) + 'px';
                });
                cell.addEventListener('mouseleave', () => {
                    document.getElementById('canvas-tooltip').style.display = 'none';
                });
                cell.addEventListener('click', () => {
                    const s = cell._staker;
                    if (s) {
                        document.getElementById('accordion-scenario').open = false;
                        const dtAccordion = document.querySelector('details.accordion:nth-of-type(3)');
                        if (dtAccordion) dtAccordion.open = true;
                        highlightedAgentId = s.id;
                        showAgentTab('top-stakers', document.querySelector('.agent-tab'));
                    }
                });
            }

            reset() { this.container.innerHTML = ''; this.cells = []; }
            forceRedraw() {}
        }

        const simCanvas = new DotGrid('agent-grid');

        // ============================================================
        // State
        // ============================================================
        const API = '';
        let chart = null;
        let currentChartView = 'token-economics';
        let historyData = {
            steps: [], years: [], participation: [], apy: [], rsc_held: [], active: [],
            rsc_believer: [], rsc_yield_seeker: [], rsc_institution: [], rsc_speculator: [],
            credits_generated_step: [], credits_deployed_step: [], exits_step: [], entries_step: [],
            apy_15pct: [], apy_30pct: [], apy_70pct: [],
            cumulative_emissions_hist: [], total_burned_hist: [],
        };
        let apyChart = null;
        let participationChart = null;
        let endowSparkChart = null;
        let highlightedAgentId = null;
        let savedScenarios = [];
        let initialSnapshot = null;
        let selectedScenario = 'expected';

        async function fetchJson(url, options = {}) {
            const resp = await fetch(API + url, options);
            return resp.json();
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return Math.round(n).toLocaleString();
        }

        function satColor(sat) {
            if (sat >= 0.7) return 'var(--success)';
            if (sat >= 0.4) return 'var(--apy-line)';
            return 'var(--danger)';
        }

        // ============================================================
        // Hero scenario cards
        // ============================================================
        function selectScenario(scenario) {
            selectedScenario = scenario;
            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
            const card = document.getElementById('card-' + scenario);
            if (card) card.classList.add('active');
            const configs = {
                conservative: { participation: 15, threshold: 4 },
                expected:     { participation: 30, threshold: 8 },
                high:         { participation: 70, threshold: 15 },
            };
            const cfg = configs[scenario];
            document.getElementById('slider-participation').value = cfg.participation;
            document.getElementById('val-participation').textContent = cfg.participation + '%';
            document.getElementById('slider-threshold').value = cfg.threshold;
            document.getElementById('val-threshold').textContent = cfg.threshold + '%';
        }

        function selectScenarioChip(scenario) {
            selectScenario(scenario);
            document.querySelectorAll('.scenario-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
        }

        function showResultCards() {
            document.getElementById('result-cards').style.display = 'flex';
            document.getElementById('principal-note').style.display = 'block';
            document.getElementById('hero-section').classList.add('ran');
        }

        // ============================================================
        // Archetype bar
        // ============================================================
        function handleArchSliderChange(changedArch) {
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const slider = document.getElementById('slider-' + changedArch);
            let newVal = Math.max(5, Math.min(85, Math.round(parseInt(slider.value) / 5) * 5));
            slider.value = newVal;
            const others = archs.filter(a => a !== changedArch);
            const remaining = 100 - newVal;
            let otherOldTotal = 0;
            const oldVals = {};
            others.forEach(a => {
                oldVals[a] = parseInt(document.getElementById('slider-' + a).value);
                otherOldTotal += oldVals[a];
            });
            const newVals = {};
            if (otherOldTotal > 0) {
                others.forEach(a => {
                    const proportion = oldVals[a] / otherOldTotal;
                    newVals[a] = Math.max(5, Math.round(remaining * proportion / 5) * 5);
                });
            } else {
                others.forEach(a => { newVals[a] = Math.max(5, Math.floor(remaining / 3 / 5) * 5); });
            }
            let otherSum = 0;
            others.forEach(a => { otherSum += newVals[a]; });
            const diff = remaining - otherSum;
            if (diff !== 0) {
                let largest = others[0];
                others.forEach(a => { if (newVals[a] > newVals[largest]) largest = a; });
                newVals[largest] = Math.max(5, newVals[largest] + diff);
            }
            others.forEach(a => {
                document.getElementById('slider-' + a).value = newVals[a];
                document.getElementById('val-' + a).textContent = newVals[a] + '%';
            });
            document.getElementById('val-' + changedArch).textContent = newVal + '%';
            updateArchBar();
        }

        function updateArchBar() {
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const colors = { believer: '#50c878', yield_seeker: '#c9a227', institution: '#7856ff', speculator: '#e05555' };
            // update accordion arch bar
            const bar = document.getElementById('arch-bar');
            if (bar) {
                bar.innerHTML = '';
                archs.forEach(a => {
                    const val = parseInt(document.getElementById('slider-' + a).value);
                    const seg = document.createElement('div');
                    seg.className = 'arch-segment';
                    seg.style.width = val + '%';
                    seg.style.background = colors[a];
                    bar.appendChild(seg);
                });
            }
        }

        function getSliderParams() {
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const mix = {};
            archs.forEach(a => { mix[a] = parseInt(document.getElementById('slider-' + a).value) / 100; });
            const params = {
                num_holders: parseInt(document.getElementById('slider-holders').value),
                initial_participation_rate: parseInt(document.getElementById('slider-participation').value) / 100,
                yield_threshold_mean: parseInt(document.getElementById('slider-threshold').value) / 100,
                deploy_probability: parseInt(document.getElementById('slider-deploy').value) / 100,
                success_rate: parseInt(document.getElementById('slider-success').value) / 100,
                burn_rate: parseFloat(document.getElementById('slider-burn').value) / 100,
                archetype_mix: mix,
            };
            if (document.getElementById('chk-credit-expiry').checked) {
                params.credit_expiry_enabled = true;
                params.credit_expiry_weeks = parseInt(document.getElementById('slider-expiry-weeks').value);
            }
            params.failure_mode = document.getElementById('select-failure-mode').value;
            return params;
        }

        async function resetSliders() {
            document.getElementById('slider-participation').value = 30;
            document.getElementById('val-participation').textContent = '30%';
            document.getElementById('slider-threshold').value = 8;
            document.getElementById('val-threshold').textContent = '8%';
            document.getElementById('slider-deploy').value = 30;
            document.getElementById('val-deploy').textContent = '30%';
            document.getElementById('slider-success').value = 80;
            document.getElementById('val-success').textContent = '80%';
            document.getElementById('slider-holders').value = 100;
            document.getElementById('val-holders').textContent = '100';
            document.getElementById('slider-burn').value = 2;
            document.getElementById('val-burn').textContent = '2%';
            document.getElementById('slider-believer').value = 25;
            document.getElementById('val-believer').textContent = '25%';
            document.getElementById('slider-yield_seeker').value = 35;
            document.getElementById('val-yield_seeker').textContent = '35%';
            document.getElementById('slider-institution').value = 15;
            document.getElementById('val-institution').textContent = '15%';
            document.getElementById('slider-speculator').value = 25;
            document.getElementById('val-speculator').textContent = '25%';
            updateArchBar();
            await resetWithParams();
        }

        function updateFailureModeHint() {
            const hints = {
                'nothing': 'Backers lose their deployed credits but RSC held is unaffected.',
                'partial_refund': '50% of deployed credits returned to backers on failure.',
            };
            const val = document.getElementById('select-failure-mode').value;
            document.getElementById('failure-mode-hint').textContent = hints[val] || '';
        }

        function updateDesignLabState() {
            document.getElementById('credit-expiry-controls').style.display =
                document.getElementById('chk-credit-expiry').checked ? 'block' : 'none';
        }

        // ============================================================
        // Main UI update
        // ============================================================
        async function updateUI() {
            const state = await fetchJson('/api/state');
            const model = state.model;
            const pd = model.participation_data || {};

            // Status
            document.getElementById('step-count').textContent = model.step;
            document.getElementById('year-display').textContent = (model.year || 0).toFixed(1);
            document.getElementById('step-counter-wk').textContent = model.step;
            document.getElementById('step-counter-yr').textContent = (model.year || 0).toFixed(1);
            document.getElementById('active-count').textContent = model.active_holders || model.active_stakers || 0;
            document.getElementById('total-count').textContent = model.num_holders || model.num_stakers || 0;

            // KPIs
            const partRate = ((model.participation_rate || 0) * 100).toFixed(1) + '%';
            const apyVal = ((model.current_apy || 0) * 100).toFixed(1) + '%';
            document.getElementById('participation-rate').textContent = partRate;
            document.getElementById('current-apy').textContent = apyVal;

            const exitedVal = model.exited_holders || model.churned_stakers || 0;
            updateMetric('exited-count', exitedVal);

            // Burn coverage ratio
            const burnCoverageEl = document.getElementById('burn-coverage');
            const burnCoverageSubEl = document.getElementById('burn-coverage-sub');
            if (burnCoverageEl) {
                const totalEmitted = model.total_credits_generated || 0;
                const totalBurned = model.total_burned || 0;
                if (totalEmitted > 0) {
                    const coveragePct = (totalBurned / totalEmitted * 100).toFixed(1);
                    burnCoverageEl.textContent = coveragePct + '%';
                    const n = parseFloat(coveragePct);
                    burnCoverageEl.className = n >= 50 ? 'burn-coverage-good' : n >= 10 ? 'burn-coverage-warn' : 'burn-coverage-bad';
                    if (burnCoverageSubEl) burnCoverageSubEl.textContent = Math.round(totalBurned).toLocaleString() + ' / ' + Math.round(totalEmitted).toLocaleString() + ' RSC';
                } else {
                    burnCoverageEl.textContent = '—';
                    burnCoverageEl.className = '';
                }
            }

            const partNum = model.participation_rate || 0;
            const csvEl = document.getElementById('csv-scenario');
            if (csvEl) {
                if (partNum < 0.225) { csvEl.textContent = '~15% (47% APY)'; csvEl.style.color = 'var(--apy-line)'; }
                else if (partNum < 0.50) { csvEl.textContent = '~30% (24% APY)'; csvEl.style.color = 'var(--success)'; }
                else { csvEl.textContent = '~70% (10% APY)'; csvEl.style.color = 'var(--text-muted)'; }
            }

            // Archetype composition bar (right column)
            const archDist = model.archetype_distribution || {};
            const archTotal = Object.values(archDist).reduce((a, b) => a + b, 0) || 1;
            const archColors = { believer: '#50c878', yield_seeker: '#c9a227', institution: '#7856ff', speculator: '#e05555' };
            const archNames = { believer: 'Believer', yield_seeker: 'Return-Sensitive', institution: 'Institution', speculator: 'Speculator' };
            const archs = ['believer', 'yield_seeker', 'institution', 'speculator'];

            const archBarDisplay = document.getElementById('arch-bar-display');
            if (archBarDisplay) {
                archBarDisplay.innerHTML = archs.map(a => {
                    const pct = (archDist[a] || 0) / archTotal * 100;
                    return '<div class="arch-bar-segment" style="width:' + pct.toFixed(1) + '%;background:' + archColors[a] + '"></div>';
                }).join('');
            }
            const archRows = document.getElementById('arch-rows');
            if (archRows) {
                archRows.innerHTML = archs.map(a => {
                    const n = archDist[a] || 0;
                    const pct = (n / archTotal * 100).toFixed(0);
                    return '<div class="arch-row">' +
                        '<span><span class="arch-row-dot" style="background:' + archColors[a] + '"></span>' +
                        '<span class="arch-row-name">' + archNames[a] + '</span></span>' +
                        '<span class="arch-row-pct">' + pct + '%</span></div>';
                }).join('');
            }

            // Accordion arch bar
            const archBar = document.getElementById('arch-bar');
            if (archBar) {
                archBar.innerHTML = archs.map(a => {
                    const n = archDist[a] || 0;
                    return '<div class="arch-segment" style="width:' + (n / archTotal * 100).toFixed(1) + '%;background:' + archColors[a] + '"></div>';
                }).join('');
            }

            // Archetype metrics cards
            const archMetrics = model.archetype_metrics || {};
            document.getElementById('arch-metrics').innerHTML = archs.map(a => {
                const m = archMetrics[a];
                if (!m) return '<div class="arch-metric-card ' + a + '"><div class="arch-card-name ' + a + '">' + archNames[a] + '</div><div class="arch-stat" style="color:var(--text-dim)">No agents</div></div>';
                const rscHistory = historyData['rsc_' + a] || [];
                let sparklineSvg = '';
                if (rscHistory.length >= 2) {
                    const w = 56, h = 16;
                    const vals = rscHistory.filter(v => v !== null && v > 0);
                    if (vals.length >= 2) {
                        const minV = Math.min(...vals), maxV = Math.max(...vals);
                        const range = maxV - minV || 1;
                        const points = vals.map((v, i) => {
                            const x = (i / (vals.length - 1)) * w;
                            const y = h - ((v - minV) / range) * h;
                            return x.toFixed(1) + ',' + y.toFixed(1);
                        }).join(' ');
                        sparklineSvg = '<svg width="' + w + '" height="' + h + '" style="vertical-align:middle;margin-left:4px">' +
                            '<polyline points="' + points + '" fill="none" stroke="' + archColors[a] + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    }
                }
                return '<div class="arch-metric-card ' + a + '">' +
                    '<div class="arch-card-name ' + a + '">' + archNames[a] + '</div>' +
                    '<div class="arch-stat"><span>Active</span><span class="arch-stat-val">' + m.active + '/' + m.total + '</span></div>' +
                    '<div class="arch-stat"><span>Avg RSC</span><span class="arch-stat-val">' + formatNumber(m.avg_rsc || 0) + sparklineSvg + '</span></div>' +
                    '<div class="arch-stat"><span>Avg Hold</span><span class="arch-stat-val">' + (m.avg_weeks_held || 0).toFixed(0) + 'wk ' + (m.avg_multiplier || 1).toFixed(2) + 'x</span></div>' +
                    '<div class="arch-stat"><span>Deployed</span><span class="arch-stat-val">' + formatNumber(m.total_deployed || 0) + '</span></div>' +
                    '<div class="arch-stat"><span>Exited</span><span class="arch-stat-val" style="color:var(--danger)">' + (m.exited || m.churned || 0) + '</span></div>' +
                    '</div>';
            }).join('');

            // Events
            function humanizeEvent(e) {
                const w = 'Week ' + e.step + ': ';
                if (e.type === 'funded')       return w + 'Research proposal reached its funding goal';
                if (e.type === 'completed')    return w + 'Funded research delivered results';
                if (e.type === 'failed')       return w + 'Research proposal was unsuccessful';
                if (e.type === 'entry')        return w + 'New holders joined — APY was attractive';
                if (e.type === 'exit' || e.type === 'churn') return w + 'Holders exited — APY fell below their threshold';
                if (e.type === 'new_proposal') return w + 'New research proposal opened';
                return w + (e.message || e.type);
            }
            const eventsHtml = state.events.slice(0, 20).map(e =>
                '<div class="event"><span class="event-type ' + e.type + '">' + e.type + '</span>' +
                '<span>' + humanizeEvent(e) + '</span></div>'
            ).join('');
            document.getElementById('events-list').innerHTML = eventsHtml || '<div class="event" style="color:var(--text-dim)">No events yet</div>';

            // Proposals
            const proposals = await fetchJson('/api/proposals');
            document.getElementById('proposals-list').innerHTML = proposals.slice(-12).reverse().map(p =>
                '<div class="list-item">' +
                '<span class="proposal-id">' + p.id + '</span>' +
                '<div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(p.funding_progress, 100) + '%"></div></div>' +
                '<span class="progress-pct">' + Math.round(p.funding_progress) + '%</span>' +
                '<span class="status status-' + p.status + '">' + p.status + '</span>' +
                '</div>'
            ).join('') || '<div class="list-item" style="color:var(--text-dim)">No proposals</div>';

            // Multiplier detail
            const mulDist = model.multiplier_distribution || {};
            const mulTotal = Object.values(mulDist).reduce((a, b) => a + (b.count || 0), 0) || 1;
            const mulColors = { New: '#536471', Holder: '#4a9eff', LongTerm: '#c9a227' };
            const detailBar = document.getElementById('multiplier-detail-bar');
            if (detailBar) {
                detailBar.innerHTML = ['New', 'Holder', 'LongTerm'].map(label => {
                    const d = mulDist[label] || { count: 0 };
                    return '<div style="flex:' + (d.count || 0.5) + ';background:' + mulColors[label] + ';height:16px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;min-width:2px;color:#000" title="' + label + ': ' + d.count + '">' + (d.count > 2 ? d.count : '') + '</div>';
                }).join('');
            }
            const detailLegend = document.getElementById('multiplier-detail-legend');
            if (detailLegend) {
                const mulReadable = { New: 'New (<30d) 1.0×', Holder: 'Holder (30d–1yr) 1.15×', LongTerm: 'Long-Term (>1yr) 1.2×' };
                detailLegend.innerHTML = ['New', 'Holder', 'LongTerm'].map(label => {
                    const d = mulDist[label] || { count: 0, rsc: 0 };
                    return mulReadable[label] + ': ' + d.count + ' holders';
                }).join(' &nbsp;|&nbsp; ');
            }
            const rscByArch = document.getElementById('rsc-by-archetype');
            if (rscByArch) {
                rscByArch.innerHTML = archs.map(a => {
                    const am = archMetrics[a];
                    const total = am ? (am.avg_rsc || 0) * (am.active || 0) : 0;
                    return '<div style="display:flex;justify-content:space-between"><span style="color:' + archColors[a] + '">' + archNames[a] + '</span><span>' + formatNumber(total) + ' RSC</span></div>';
                }).join('');
            }

            // History accumulation (step-by-step)
            if (model.step > 0 && !historyData.steps.includes(model.step)) {
                const scenarios = pd.scenarios || {};
                historyData.steps.push(model.step);
                historyData.years.push(model.year || 0);
                historyData.participation.push((model.participation_rate || 0) * 100);
                historyData.apy.push((model.current_apy || 0) * 100);
                historyData.rsc_held.push(model.total_rsc_held || model.total_staked || 0);
                historyData.active.push(model.active_holders || model.active_stakers || 0);
                historyData.rsc_believer.push(archMetrics.believer ? (archMetrics.believer.avg_rsc || 0) * (archMetrics.believer.active || 0) : 0);
                historyData.rsc_yield_seeker.push(archMetrics.yield_seeker ? (archMetrics.yield_seeker.avg_rsc || 0) * (archMetrics.yield_seeker.active || 0) : 0);
                historyData.rsc_institution.push(archMetrics.institution ? (archMetrics.institution.avg_rsc || 0) * (archMetrics.institution.active || 0) : 0);
                historyData.rsc_speculator.push(archMetrics.speculator ? (archMetrics.speculator.avg_rsc || 0) * (archMetrics.speculator.active || 0) : 0);
                historyData.credits_generated_step.push(model.credits_generated_step || 0);
                historyData.credits_deployed_step.push(model.credits_deployed_step || 0);
                historyData.exits_step.push(model.exits_step || 0);
                historyData.entries_step.push(model.entries_step || 0);
                historyData.apy_15pct.push((scenarios['15pct'] || 0) * 100);
                historyData.apy_30pct.push((scenarios['30pct'] || 0) * 100);
                historyData.apy_70pct.push((scenarios['70pct'] || 0) * 100);
                updateChart();
                updateYieldCharts();
            }

            lastApy = model.current_apy || 0;
            lastPartRate = model.participation_rate || 0.30;
            updateEndowmentCard();
            await loadStakers();
            simCanvas.update(lastStakers, model.step_deployments || []);
            updateGridArchetypeStrip(lastStakers);
            if (model.step >= 1 && initialSnapshot) updateWhatHappened(model);
        }

        const metricAnimations = {};
        function updateMetric(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            const formatted = formatNumber(value);
            if (el.textContent === formatted) return;
            const prev = metricAnimations[id];
            if (prev !== undefined && typeof value === 'number' && typeof prev === 'number') {
                const startVal = prev, endVal = value;
                const startTime = performance.now(), duration = 400;
                function animateMetric(now) {
                    const elapsed = now - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = 1 - Math.pow(1 - progress, 3);
                    el.textContent = formatNumber(startVal + (endVal - startVal) * eased);
                    if (progress < 1) requestAnimationFrame(animateMetric);
                    else el.textContent = formatNumber(endVal);
                }
                requestAnimationFrame(animateMetric);
            } else { el.textContent = formatted; }
            metricAnimations[id] = value;
        }

        // ============================================================
        // Chart system
        // ============================================================
        function chartCommon(light) {
            const tickColor = light ? '#6B7280' : '#555';
            const gridColor = light ? '#E5E7EB' : '#1a1a1a';
            const legendColor = light ? '#6B7280' : '#888';
            return {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { position: 'top', labels: { color: legendColor, font: { size: 10 }, boxWidth: 12 } }
                },
                scales: { x: { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } } },
                _tickColor: tickColor, _gridColor: gridColor,
            };
        }

        function getChartConfig(view) {
            const light = isLightMode();
            const common = chartCommon(light);
            const tickColor = common._tickColor, gridColor = common._gridColor;
            const yAxis = { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } };

            if (view === 'token-economics') {
                return {
                    type: 'line',
                    data: { labels: historyData.steps, datasets: [
                        { label: 'RSC Held', data: historyData.rsc_held, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                        { label: 'Active Holders', data: historyData.active, borderColor: '#50c878', tension: 0.3, yAxisID: 'y1', pointRadius: 1 },
                    ]},
                    options: { ...common, scales: { ...common.scales, y: yAxis, y1: { position: 'right', ticks: { color: tickColor, font: { size: 10 } }, grid: { drawOnChartArea: false } } } }
                };
            }
            if (view === 'agent-health') {
                return {
                    type: 'line',
                    data: { labels: historyData.steps, datasets: [
                        { label: 'Believer RSC', data: historyData.rsc_believer, borderColor: '#50c878', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                        { label: 'YieldSeeker RSC', data: historyData.rsc_yield_seeker, borderColor: '#c9a227', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                        { label: 'Institution RSC', data: historyData.rsc_institution, borderColor: '#7856ff', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                        { label: 'Speculator RSC', data: historyData.rsc_speculator, borderColor: '#e05555', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                        { label: 'Exits', data: historyData.exits_step, borderColor: 'rgba(220,38,38,0.5)', backgroundColor: 'rgba(220,38,38,0.2)', type: 'bar', yAxisID: 'y1' },
                    ]},
                    options: { ...common, scales: { ...common.scales, y: { position: 'left', title: { display: true, text: 'RSC', color: tickColor }, ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } }, y1: { position: 'right', min: 0, title: { display: true, text: 'Exits', color: tickColor }, ticks: { color: tickColor, font: { size: 10 } }, grid: { drawOnChartArea: false } } } }
                };
            }
            if (view === 'funding-flow') {
                return {
                    type: 'bar',
                    data: { labels: historyData.steps, datasets: [
                        { label: 'Credits Generated', data: historyData.credits_generated_step, backgroundColor: 'rgba(5,150,105,0.5)', borderColor: '#059669', borderWidth: 1 },
                        { label: 'Credits Deployed', data: historyData.credits_deployed_step, backgroundColor: 'rgba(29,78,216,0.4)', borderColor: '#1D4ED8', borderWidth: 1 },
                    ]},
                    options: { ...common, scales: { ...common.scales, y: yAxis } }
                };
            }
        }

        function updateChart() {
            const el = document.getElementById('history-chart');
            if (!el) return;
            const ctx = el.getContext('2d');
            if (chart) { chart.destroy(); chart = null; }
            const config = getChartConfig(currentChartView);
            if (config) chart = new Chart(ctx, config);
        }

        function switchChartView(view) {
            currentChartView = view;
            document.querySelectorAll('.chart-view-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector('[data-view="' + view + '"]');
            if (btn) btn.classList.add('active');
            updateChart();
        }

        function updateRHReading(model) {
            const el = document.getElementById('rh-design-reading');
            if (!el || !model || !model.step || model.step < 5) return;
            const part = ((model.participation_rate || 0) * 100).toFixed(1);
            const apy = ((model.current_apy || 0) * 100).toFixed(1);
            const yr = (model.step / 52).toFixed(1);
            const exited = model.exited_holders || 0;
            const active = model.active_holders || model.active_stakers || 0;
            const circ = model.circulating_supply || 134157343;
            const rscHeld = model.total_rsc_held || 0;
            const partNum = model.participation_rate || 0;
            let scenario, scenarioColor;
            if (partNum < 0.225) { scenario = '15%'; scenarioColor = '#50c878'; }
            else if (partNum < 0.50) { scenario = '30%'; scenarioColor = '#1D4ED8'; }
            else { scenario = '70%'; scenarioColor = '#e05555'; }
            const rscHeldM = (rscHeld / 1e6).toFixed(1);
            const circM = (circ / 1e6).toFixed(1);
            let interpretation = [];
            interpretation.push('At <strong>Year ' + yr + '</strong>: <strong style="color:var(--apy-line)">' + part + '%</strong> participation (' + rscHeldM + 'M of ' + circM + 'M circulating RSC held in RH). Closest to the <strong style="color:' + scenarioColor + '">' + scenario + ' CSV scenario</strong> — APY ' + apy + '%.');
            if (partNum < 0.10) interpretation.push('&#9888; Very low participation. Strong market incentive for yield seekers to enter. Run longer to see convergence.');
            else if (partNum > 0.60) interpretation.push('&#9888; High participation. Yield is diluted — only deeply mission-aligned holders and institutions remain. Speculator exits expected.');
            else interpretation.push('&#10003; Moderate equilibrium range. Believers and Institutions anchor the base; Yield Seekers self-regulate around the threshold.');
            if (exited > 0) {
                const churnPct = ((exited / (active + exited)) * 100).toFixed(0);
                interpretation.push(exited + ' holders exited (' + churnPct + '% churn) — primarily Speculators and Yield Seekers. Believers/Institutions are sticky.');
            }
            el.innerHTML = interpretation.map(s => '<p style="margin:0 0 4px">' + s + '</p>').join('');
            el.style.display = 'block';
        }

        function updateYieldCharts() {
            // Hide placeholders once we have data
            const ap = document.getElementById('apy-placeholder');
            const pp = document.getElementById('participation-placeholder');
            if (ap) ap.style.display = 'none';
            if (pp) pp.style.display = 'none';

            const light = isLightMode();
            const common = chartCommon(light);
            const tickColor = common._tickColor, gridColor = common._gridColor;
            const fmtRsc = v => v >= 1e6 ? (v / 1e6).toFixed(1) + 'M' : v >= 1e3 ? (v / 1e3).toFixed(0) + 'K' : (v || 0).toFixed(0);

            // ── Chart 1: Archetype Composition — stacked area ──────────────────
            const partCtx = document.getElementById('participation-chart');
            if (partCtx) {
                if (participationChart) { participationChart.destroy(); participationChart = null; }
                participationChart = new Chart(partCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Believers',     data: historyData.rsc_believer,     backgroundColor: 'rgba(16,185,129,0.6)',  borderColor: '#10b981', borderWidth: 1.5, fill: true, tension: 0.35, pointRadius: 0 },
                            { label: 'Institutions',  data: historyData.rsc_institution,  backgroundColor: 'rgba(124,58,237,0.6)', borderColor: '#7c3aed', borderWidth: 1.5, fill: true, tension: 0.35, pointRadius: 0 },
                            { label: 'Yield Seekers', data: historyData.rsc_yield_seeker, backgroundColor: 'rgba(245,158,11,0.55)', borderColor: '#f59e0b', borderWidth: 1.5, fill: true, tension: 0.35, pointRadius: 0 },
                            { label: 'Speculators',   data: historyData.rsc_speculator,   backgroundColor: 'rgba(239,68,68,0.5)',  borderColor: '#ef4444', borderWidth: 1.5, fill: true, tension: 0.35, pointRadius: 0 },
                        ],
                    },
                    options: {
                        ...common,
                        plugins: {
                            ...common.plugins,
                            legend: { ...common.plugins.legend, labels: { ...common.plugins.legend.labels, usePointStyle: true, pointStyleWidth: 10 } },
                            tooltip: { callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + fmtRsc(ctx.parsed.y) + ' RSC' } },
                        },
                        scales: {
                            x: { stacked: true, ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                            y: { stacked: true, ticks: { color: tickColor, font: { size: 10 }, callback: fmtRsc }, grid: { color: gridColor }, title: { display: true, text: 'RSC Held', color: tickColor, font: { size: 10 } } },
                        },
                    },
                });
            }

            // ── Chart 2: Science Funding vs Protocol Cost — mixed bar + lines ──
            const apyCtx = document.getElementById('apy-chart');
            if (apyCtx) {
                if (apyChart) { apyChart.destroy(); apyChart = null; }
                apyChart = new Chart(apyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Credits Deployed (weekly)', data: historyData.credits_deployed_step, backgroundColor: 'rgba(5,150,105,0.55)', borderColor: '#059669', borderWidth: 1, yAxisID: 'y', order: 2 },
                            { label: 'Cumulative Emissions',      data: historyData.cumulative_emissions_hist, type: 'line', borderColor: '#e05555', backgroundColor: 'transparent', borderWidth: 2, fill: false, tension: 0.2, pointRadius: 0, yAxisID: 'y1', order: 1 },
                            { label: 'Cumulative Burns',          data: historyData.total_burned_hist,         type: 'line', borderColor: '#1D4ED8', backgroundColor: 'transparent', borderWidth: 2, borderDash: [5, 3], fill: false, tension: 0.2, pointRadius: 0, yAxisID: 'y1', order: 1 },
                        ],
                    },
                    options: {
                        ...common,
                        plugins: {
                            ...common.plugins,
                            legend: { ...common.plugins.legend, labels: { ...common.plugins.legend.labels, usePointStyle: true, pointStyleWidth: 10 } },
                            tooltip: { callbacks: { label: ctx => ' ' + ctx.dataset.label + ': ' + fmtRsc(ctx.parsed.y) + ' RSC' } },
                        },
                        scales: {
                            x: { ticks: { color: tickColor, font: { size: 10 } }, grid: { color: gridColor } },
                            y:  { position: 'left',  ticks: { color: tickColor, font: { size: 10 }, callback: fmtRsc }, grid: { color: gridColor }, title: { display: true, text: 'Weekly Credits', color: tickColor, font: { size: 10 } } },
                            y1: { position: 'right', ticks: { color: tickColor, font: { size: 10 }, callback: fmtRsc }, grid: { drawOnChartArea: false }, title: { display: true, text: 'Cumulative RSC', color: tickColor, font: { size: 10 } } },
                        },
                    },
                });
            }
        }

        // ============================================================
        // Actions
        // ============================================================
        async function step() {
            await fetchJson('/api/step', { method: 'POST' });
            await updateUI();
        }

        async function run(n, opts = {}) {
            const { updateCharts = true } = opts;
            await fetchJson('/api/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ steps: n }) });
            const history = await fetchJson('/api/history');
            historyData.steps = history.Step || [];
            historyData.years = history.Year || [];
            historyData.participation = (history.Participation_Rate || []).map(v => (v || 0) * 100);
            historyData.apy = (history.Current_APY || []).map(v => (v || 0) * 100);
            historyData.rsc_held = history.Total_RSC_Held || [];
            historyData.active = history.Active_Holders || history.Active_Stakers || [];
            historyData.rsc_believer = history.RSC_Believer || [];
            historyData.rsc_yield_seeker = history.RSC_YieldSeeker || [];
            historyData.rsc_institution = history.RSC_Institution || [];
            historyData.rsc_speculator = history.RSC_Speculator || [];
            historyData.credits_generated_step = history.Credits_Generated_Step || [];
            historyData.credits_deployed_step = history.Credits_Deployed_Step || [];
            historyData.exits_step = history.Exits_Step || [];
            historyData.entries_step = history.Entries_Step || [];
            historyData.cumulative_emissions_hist = history.Cumulative_Emissions || [];
            historyData.total_burned_hist = history.Total_Burned || [];
            const circ0 = 134157343;
            historyData.apy_15pct = historyData.years.map(y => (9500000 / Math.pow(2, y / 64)) / (circ0 * 0.15) * 100);
            historyData.apy_30pct = historyData.years.map(y => (9500000 / Math.pow(2, y / 64)) / (circ0 * 0.30) * 100);
            historyData.apy_70pct = historyData.years.map(y => (9500000 / Math.pow(2, y / 64)) / (circ0 * 0.70) * 100);
            if (updateCharts) { updateChart(); updateYieldCharts(); }
            await updateUI();
        }

        async function runToEquilibrium() {
            await resetWithParams();
            await run(208);
        }

        async function runSimulation() {
            showResultCards();
            await runToEquilibrium();
        }

        // ── Go / Stop ────────────────────────────────────────────────────────
        let isRunning = false;
        let goIter = 0;

        function setManualBtnsDisabled(disabled) {
            ['btn-step', 'btn-10wk', 'btn-1yr', 'btn-setup'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = disabled;
            });
        }

        function updateGoBtn() {
            const btn = document.getElementById('btn-go');
            if (!btn) return;
            if (isRunning) {
                btn.innerHTML = '&#9632; Stop';
                btn.classList.add('running');
                btn.classList.remove('primary');
            } else {
                btn.innerHTML = '&#9654;&#9654; Go';
                btn.classList.remove('running');
                btn.classList.add('primary');
            }
            setManualBtnsDisabled(isRunning);
        }

        async function goLoop() {
            goIter = 0;
            while (isRunning) {
                await run(4, { updateCharts: false });
                goIter++;
                // Rebuild charts every 5 iterations (every 20 weeks) to avoid flicker
                if (goIter % 5 === 0) { updateChart(); updateYieldCharts(); }
                if (!isRunning) break;
                await new Promise(r => setTimeout(r, 30));
            }
            // Final full chart update on stop
            updateChart();
            updateYieldCharts();
            isRunning = false;
            updateGoBtn();
        }

        function toggleGo() {
            if (isRunning) {
                isRunning = false;
                // goLoop detects flag and exits; updateGoBtn called there
            } else {
                isRunning = true;
                updateGoBtn();
                goLoop();
            }
        }

        function setupSim() {
            isRunning = false;
            updateGoBtn();
            resetWithParams();
        }
        // ─────────────────────────────────────────────────────────────────────

        async function resetWithParams() {
            isRunning = false;
            updateGoBtn();
            const params = getSliderParams();
            await fetchJson('/api/init', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
            historyData = { steps: [], years: [], participation: [], apy: [], rsc_held: [], active: [], rsc_believer: [], rsc_yield_seeker: [], rsc_institution: [], rsc_speculator: [], credits_generated_step: [], credits_deployed_step: [], exits_step: [], entries_step: [], apy_15pct: [], apy_30pct: [], apy_70pct: [], cumulative_emissions_hist: [], total_burned_hist: [] };
            if (chart) { chart.destroy(); chart = null; }
            if (apyChart) { apyChart.destroy(); apyChart = null; }
            if (participationChart) { participationChart.destroy(); participationChart = null; }
            simCanvas.reset();
            // Restore placeholders
            const ap = document.getElementById('apy-placeholder');
            const pp = document.getElementById('participation-placeholder');
            if (ap) ap.style.display = '';
            if (pp) pp.style.display = '';
            const state = await fetchJson('/api/state');
            initialSnapshot = {
                participation_rate: state.model.participation_rate,
                current_apy: state.model.current_apy,
                active_holders: state.model.active_holders || state.model.active_stakers,
                total_rsc_held: state.model.total_rsc_held || state.model.total_staked,
            };
            const whEl = document.getElementById('what-happened');
            if (whEl) { whEl.style.display = 'none'; const b = document.getElementById('what-happened-body'); if (b) b.innerHTML = ''; }
            await updateUI();
        }

        // ============================================================
        // Scenarios
        // ============================================================
        async function saveScenario() {
            if (savedScenarios.length >= 6) { alert('Maximum 6 scenarios.'); return; }
            const state = await fetchJson('/api/state');
            const model = state.model;
            const threshDisplay = document.getElementById('slider-threshold').value;
            const defaultName = 'Scenario ' + (savedScenarios.length + 1) + ' — ' + threshDisplay + '% threshold, ' + ((model.participation_rate || 0) * 100).toFixed(1) + '% participation';
            const name = prompt('Scenario name:', defaultName);
            if (!name) return;
            savedScenarios.push({ name, step: model.step, params: model.params || {}, metrics: { participation_rate: model.participation_rate, current_apy: model.current_apy, total_rsc_held: model.total_rsc_held || model.total_staked, active_holders: model.active_holders || model.active_stakers, exited_holders: model.exited_holders || model.churned_stakers, annual_emission: model.annual_emission, total_burned: model.total_burned, deployment_rate: model.deployment_rate, success_rate_actual: model.success_rate_actual, completed_proposals: model.completed_proposals, open_proposals: model.open_proposals, num_holders: model.num_holders || model.num_stakers } });
            updateScenariosList();
            updateScenarioCompare();
        }

        function clearScenarios() { savedScenarios = []; updateScenariosList(); updateScenarioCompare(); }

        function updateScenariosList() {
            const el = document.getElementById('saved-scenarios-list');
            if (!el) return;
            el.innerHTML = savedScenarios.length === 0 ? 'No saved scenarios' :
                savedScenarios.map((s, i) => '<div style="padding:3px 0;border-bottom:1px solid var(--border)"><span style="color:var(--accent)">' + (i + 1) + '.</span> ' + s.name + ' <span style="color:var(--text-dim)">(wk ' + s.step + ')</span></div>').join('');
        }

        function updateScenarioCompare() {
            const el = document.getElementById('scenario-compare-content');
            if (!el) return;
            if (savedScenarios.length === 0) { el.innerHTML = '<p style="color:var(--text-dim);font-size:13px;">Save scenarios from the Data Tables section to compare them here.</p>'; return; }
            const metricLabels = { participation_rate: 'Participation Rate', current_apy: 'Current APY', total_rsc_held: 'RSC Held', active_holders: 'Active Holders', exited_holders: 'Exited', annual_emission: 'Annual Emission', total_burned: 'Burned', deployment_rate: 'Deployed/Wk', success_rate_actual: 'Success Rate', completed_proposals: 'Completed', open_proposals: 'Open', num_holders: 'Total Holders' };
            let html = '<table class="scenario-table"><thead><tr><th>Metric</th>';
            savedScenarios.forEach(s => { html += '<th>' + s.name + '</th>'; });
            html += '</tr></thead><tbody>';
            for (const [key, label] of Object.entries(metricLabels)) {
                html += '<tr><td>' + label + '</td>';
                savedScenarios.forEach(s => {
                    const val = s.metrics[key];
                    const formatted = key === 'participation_rate' || key === 'current_apy' ? ((val || 0) * 100).toFixed(1) + '%' : key === 'success_rate_actual' ? ((val || 0) * 100).toFixed(0) + '%' : typeof val === 'number' ? formatNumber(val) : (val ?? '—');
                    html += '<td>' + formatted + '</td>';
                });
                html += '</tr>';
            }
            html += '</tbody></table>';
            el.innerHTML = html;
        }

        function openScenarioModal() { document.getElementById('scenario-modal').classList.add('open'); updateScenarioCompare(); }
        function closeScenarioModal() { document.getElementById('scenario-modal').classList.remove('open'); }
        document.getElementById('scenario-modal').addEventListener('click', function(e) { if (e.target === this) closeScenarioModal(); });

        function toggleMetricDetails(e) {
            e.preventDefault();
            const details = document.getElementById('metric-details');
            const link = e.target;
            if (details.style.display === 'none') { details.style.display = 'block'; link.innerHTML = 'Hide detailed metrics &#9662;'; }
            else { details.style.display = 'none'; link.innerHTML = 'Show detailed metrics &#9656;'; }
        }

        // ============================================================
        // Agent Inspector
        // ============================================================
        let currentAgentTab = 'top-stakers';
        let lastStakers = [];

        function showAgentTab(tab, btnEl) {
            currentAgentTab = tab;
            document.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
            else { const first = document.querySelector('.agent-tab'); if (first) first.classList.add('active'); }
            renderAgentTab();
        }

        async function loadStakers() { lastStakers = await fetchJson('/api/holders'); renderAgentTab(); }

        function renderAgentTab() {
            const container = document.getElementById('agent-content');
            if (!container) return;
            if (!lastStakers.length) { container.innerHTML = '<div class="agent-placeholder">No holders yet. Run the simulation.</div>'; return; }
            const archNames = { believer: 'Believer', yield_seeker: 'Return-Sensitive', institution: 'Institution', speculator: 'Speculator' };

            if (currentAgentTab === 'top-stakers') {
                const sorted = [...lastStakers].filter(s => s.active).sort((a, b) => (b.rsc_held || 0) - (a.rsc_held || 0)).slice(0, 20);
                container.innerHTML = '<table class="agent-table"><thead><tr><th>ID</th><th>Archetype</th><th>RSC Held</th><th>Hold Duration</th><th>Multiplier</th><th>Credits</th><th>Deployed</th></tr></thead><tbody>' +
                    sorted.map(s => '<tr class="' + (highlightedAgentId === s.id ? 'highlighted' : '') + '"><td class="agent-id">' + s.id + '</td><td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td><td>' + formatNumber(s.rsc_held || s.stake || 0) + '</td><td>' + (s.weeks_held || 0) + 'wk</td><td style="color:var(--apy-line)">' + (s.multiplier_label || 'New') + ' ' + (s.multiplier || 1).toFixed(2) + 'x</td><td>' + formatNumber(s.credits) + '</td><td>' + formatNumber(s.total_deployed) + '</td></tr>').join('') + '</tbody></table>';
            } else if (currentAgentTab === 'recent-deployers') {
                const deployers = [...lastStakers].filter(s => s.total_deployed > 0).sort((a, b) => b.total_deployed - a.total_deployed).slice(0, 20);
                container.innerHTML = deployers.length ? '<table class="agent-table"><thead><tr><th>ID</th><th>Archetype</th><th>Deployed</th><th>Burned</th><th>Threshold</th><th>Status</th></tr></thead><tbody>' +
                    deployers.map(s => '<tr class="' + (!s.active ? 'churned' : '') + (highlightedAgentId === s.id ? ' highlighted' : '') + '"><td class="agent-id">' + s.id + (!s.active ? ' [exited]' : '') + '</td><td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td><td style="color:var(--success)">' + formatNumber(s.total_deployed) + '</td><td style="color:var(--danger)">' + formatNumber(s.total_burned) + '</td><td>' + ((s.yield_threshold || 0) * 100).toFixed(1) + '%</td><td>' + (s.active ? '<span style="color:var(--success)">Holding</span>' : '<span style="color:var(--danger)">Exited</span>') + '</td></tr>').join('') + '</tbody></table>'
                    : '<div class="agent-placeholder">No deployments yet.</div>';
            } else if (currentAgentTab === 'by-archetype') {
                const archetypes = ['believer', 'yield_seeker', 'institution', 'speculator'];
                const rows = archetypes.map(a => {
                    const group = lastStakers.filter(s => s.archetype === a);
                    const active = group.filter(s => s.active);
                    const totalRsc = active.reduce((acc, s) => acc + (s.rsc_held || s.stake || 0), 0);
                    const totalDeployed = group.reduce((acc, s) => acc + s.total_deployed, 0);
                    const avgWeeks = active.length > 0 ? active.reduce((acc, s) => acc + (s.weeks_held || 0), 0) / active.length : 0;
                    const avgMult = active.length > 0 ? active.reduce((acc, s) => acc + (s.multiplier || 1), 0) / active.length : 1;
                    return '<tr><td><span class="arch-badge ' + a + '">' + archNames[a] + '</span></td><td>' + active.length + '/' + group.length + '</td><td>' + formatNumber(totalRsc) + '</td><td>' + formatNumber(totalDeployed) + '</td><td>' + avgWeeks.toFixed(0) + 'wk</td><td>' + avgMult.toFixed(2) + 'x</td></tr>';
                });
                container.innerHTML = '<table class="agent-table"><thead><tr><th>Archetype</th><th>Active/Total</th><th>Total RSC</th><th>Total Deployed</th><th>Avg Hold</th><th>Avg Mult.</th></tr></thead><tbody>' + rows.join('') + '</tbody></table>';
            } else if (currentAgentTab === 'churned') {
                const exited = lastStakers.filter(s => !s.active);
                container.innerHTML = exited.length ? '<table class="agent-table"><thead><tr><th>ID</th><th>Archetype</th><th>RSC Held</th><th>Hold Duration</th><th>Threshold</th><th>Deployed</th></tr></thead><tbody>' +
                    exited.map(s => '<tr class="churned"><td class="agent-id">' + s.id + '</td><td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td><td>' + formatNumber(s.rsc_held || s.stake || 0) + '</td><td>' + (s.weeks_held || 0) + 'wk</td><td style="color:var(--danger)">' + ((s.yield_threshold || 0) * 100).toFixed(1) + '%</td><td>' + formatNumber(s.total_deployed) + '</td></tr>').join('') + '</tbody></table>'
                    : '<div class="agent-placeholder">No holders have exited yet.</div>';
            }
            setTimeout(() => { highlightedAgentId = null; }, 3000);
        }

        // ============================================================
        // Post-run summary
        // ============================================================
        function generateNarrativeSummary(model, stakers) {
            const archetypes = ['believer', 'yield_seeker', 'institution', 'speculator'];
            const archNamesPlural = { believer: 'Believers', yield_seeker: 'Return-Sensitive Holders', institution: 'Institutions', speculator: 'Speculators' };
            const archData = {};
            let totalDeployed = 0, totalChurned = 0;
            for (const arch of archetypes) {
                const group = stakers.filter(s => s.archetype === arch);
                const active = group.filter(s => s.active);
                const exited = group.filter(s => !s.active);
                const deployed = group.reduce((sum, s) => sum + s.total_deployed, 0);
                const avgCredits = active.length > 0 ? active.reduce((sum, s) => sum + s.credits, 0) / active.length : 0;
                const avgWeeks = active.length > 0 ? active.reduce((sum, s) => sum + s.weeks_held, 0) / active.length : 0;
                archData[arch] = { total: group.length, active: active.length, churned: exited.length, deployed, avgCredits, avgWeeks };
                totalDeployed += deployed;
                totalChurned += exited.length;
            }
            let topDeployer = archetypes[0];
            for (const arch of archetypes) { if (archData[arch].deployed > archData[topDeployer].deployed) topDeployer = arch; }
            const topDeployPct = totalDeployed > 0 ? ((archData[topDeployer].deployed / totalDeployed) * 100).toFixed(0) : 0;
            const topDeployPopPct = stakers.length > 0 ? ((archData[topDeployer].total / stakers.length) * 100).toFixed(0) : 0;
            let hoarder = archetypes[0];
            for (const arch of archetypes) { if (archData[arch].avgCredits > archData[hoarder].avgCredits) hoarder = arch; }
            let lowestCredits = archetypes[0];
            for (const arch of archetypes) { if (archData[arch].active > 0 && archData[arch].avgCredits < archData[lowestCredits].avgCredits) lowestCredits = arch; }
            const hoardRatio = archData[lowestCredits].avgCredits > 0 ? (archData[hoarder].avgCredits / archData[lowestCredits].avgCredits).toFixed(1) : 'N/A';
            let longestHolder = archetypes[0];
            for (const arch of archetypes) { if (archData[arch].active > 0 && archData[arch].avgWeeks > archData[longestHolder].avgWeeks) longestHolder = arch; }
            const burnPct = initialSnapshot && initialSnapshot.total_rsc_held > 0 ? ((model.total_burned / initialSnapshot.total_rsc_held) * 100).toFixed(1) : '0';
            const parts = [];
            parts.push('Over <span class="narrative-highlight">' + model.step + ' weeks</span>, the endowment generated <span class="narrative-highlight">' + formatNumber(model.total_credits_generated) + ' funding credits</span> and burned ' + formatNumber(model.total_burned) + ' RSC (' + burnPct + '% of initial stake).');
            parts.push(archNamesPlural[topDeployer] + ' were the most active deployers, contributing ' + topDeployPct + '% of all credit deployments despite being ' + topDeployPopPct + '% of the population.');
            if (hoarder !== lowestCredits && hoardRatio !== 'N/A') parts.push(archNamesPlural[hoarder] + ' hoarded credits — their average credit balance was <span class="narrative-highlight">' + hoardRatio + 'x higher</span> than ' + archNamesPlural[lowestCredits] + "'s.");
            if (totalChurned > 0) { const churnParts = archetypes.filter(a => archData[a].churned > 0).map(a => archData[a].churned + ' ' + archNamesPlural[a].toLowerCase()); parts.push('<span class="narrative-danger">' + totalChurned + ' holder' + (totalChurned > 1 ? 's' : '') + ' exited</span> (yield fell below threshold) (' + churnParts.join(', ') + ').'); }
            if (archData[longestHolder].active > 0) parts.push(archNamesPlural[longestHolder] + ' held longest on average (' + archData[longestHolder].avgWeeks.toFixed(0) + ' weeks), earning higher time-weight multipliers.');
            if (model.completed_proposals + model.failed_proposals > 0) { const totalResolved = model.completed_proposals + model.failed_proposals; const successPct = ((model.completed_proposals / totalResolved) * 100).toFixed(0); parts.push(totalResolved + ' proposals resolved: <span class="narrative-success">' + model.completed_proposals + ' completed</span>' + (model.failed_proposals > 0 ? ', <span class="narrative-danger">' + model.failed_proposals + ' failed</span>' : '') + ' (' + successPct + '% success rate).'); }
            return '<p>' + parts.join(' ') + '</p>';
        }

        function updateWhatHappened(model) {
            if (!initialSnapshot) return;
            const el = document.getElementById('what-happened');
            const body = document.getElementById('what-happened-body');
            const details = document.getElementById('metric-details');
            if (!el || !body || !details) return;

            // Narrative
            if (model.step >= 5 && lastStakers.length > 0) {
                body.innerHTML = generateNarrativeSummary(model, lastStakers);
            }

            // Metric deltas (inside the expandable)
            const deltas = [
                { label: 'RSC Held in RH', initial: initialSnapshot.total_rsc_held || 0, final: model.total_rsc_held || model.total_staked || 0 },
                { label: 'Active Holders', initial: initialSnapshot.active_holders || 0, final: model.active_holders || model.active_stakers || 0, fmt: 'int' },
                { label: 'Participation Rate', initial: initialSnapshot.participation_rate || 0, final: model.participation_rate || 0, fmt: 'pct' },
                { label: 'Current APY', initial: initialSnapshot.current_apy || 0, final: model.current_apy || 0, fmt: 'pct' },
                { label: 'Credits Deployed', initial: 0, final: model.total_credits_deployed || 0 },
                { label: 'Completed Proposals', initial: 0, final: model.completed_proposals || 0, fmt: 'int' },
                { label: 'Total Exited', initial: 0, final: model.exited_holders || model.churned_stakers || 0, fmt: 'int' },
            ];
            let dHtml = '';
            deltas.forEach(d => {
                const diff = d.final - d.initial;
                const sign = diff >= 0 ? '+' : '';
                const cls = diff >= 0 ? 'delta-pos' : 'delta-neg';
                let valStr, diffStr;
                if (d.fmt === 'pct') { valStr = (d.final * 100).toFixed(1) + '%'; diffStr = sign + (diff * 100).toFixed(1) + '%'; }
                else if (d.fmt === 'int') { valStr = d.final.toString(); diffStr = d.initial > 0 ? sign + diff : ''; }
                else { valStr = formatNumber(d.final); diffStr = sign + formatNumber(diff); }
                const deltaHtml = diffStr ? ' <span class="' + cls + '">(' + diffStr + ')</span>' : '';
                dHtml += '<div class="summary-delta"><span class="delta-label">' + d.label + '</span><span>' + valStr + deltaHtml + '</span></div>';
            });
            const tensions = [];
            if (model.total_credits > model.total_credits_deployed * 2 && model.step > 10) tensions.push('Credits accumulating faster than deployed — deployment pressure may build.');
            if ((model.current_apy || 0) > 0.5) tensions.push('APY above 50% — participation rate very low, strong incentive for new entrants.');
            const exited = model.exited_holders || model.churned_stakers || 0;
            const active = model.active_holders || model.active_stakers || 1;
            if (exited > active * 0.3) tensions.push('High exit rate — more than 30% of holders have left (yield below thresholds).');
            if (tensions.length > 0) { dHtml += '<div class="tension-warning"><strong>Watch:</strong><ul>'; tensions.forEach(t => { dHtml += '<li>' + t + '</li>'; }); dHtml += '</ul></div>'; }
            details.innerHTML = dHtml;

            el.style.display = 'block';
        }

        function updateGridArchetypeStrip(stakers) {
            const strip = document.getElementById('grid-arch-strip');
            if (!strip || !stakers || stakers.length === 0) return;
            const archs = [
                { key: 'believer',     label: 'Believers',         color: '#50c878' },
                { key: 'yield_seeker', label: 'Return-Sensitive',  color: '#c9a227' },
                { key: 'institution',  label: 'Institutions',      color: '#7856ff' },
                { key: 'speculator',   label: 'Speculators',       color: '#e05555' },
            ];
            const active = stakers.filter(s => s.active);
            let html = '';
            archs.forEach(a => {
                const group = active.filter(s => s.archetype === a.key);
                const count = group.length;
                const totalRsc = group.reduce((sum, s) => sum + (s.rsc_held || s.stake || 0), 0);
                const rscStr = totalRsc >= 1e6 ? (totalRsc / 1e6).toFixed(1) + 'M' : totalRsc >= 1e3 ? (totalRsc / 1e3).toFixed(0) + 'K' : Math.round(totalRsc).toString();
                html += '<div class="grid-arch-item">' +
                    '<div class="grid-arch-dot" style="background:' + a.color + '"></div>' +
                    '<span class="grid-arch-name">' + a.label + '</span>' +
                    '<span class="grid-arch-val">' + count + ' holders &nbsp;·&nbsp; ' + rscStr + ' RSC</span>' +
                    '</div>';
            });
            strip.innerHTML = html;
        }

        // ============================================================
        // Theme toggle — light is default (no attribute)
        // ============================================================
        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('theme-toggle-btn');
            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                btn.textContent = 'Dark mode';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                btn.textContent = 'Light mode';
                localStorage.setItem('theme', 'dark');
            }
            updateChart();
            updateYieldCharts();
        }

        function isLightMode() {
            return document.documentElement.getAttribute('data-theme') !== 'dark';
        }

        // ============================================================
        // Endowment projection calculator
        // ============================================================
        const RH_CIRC_BY_YEAR = [134157343, 143657343, 153055009, 162351444, 171547737, 180644968, 189644204, 198546501, 207352901, 216064440, 224682138];

        function formatDollars(n) {
            if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
            if (n >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
            return '$' + Math.round(n).toLocaleString();
        }

        function projectCumulativeCredits(partRate, dollarAmount) {
            let total = 0;
            const yr10Apy = (9500000 / Math.pow(2, 9 / 64)) / (RH_CIRC_BY_YEAR[9] * partRate);
            for (let y = 0; y < 10; y++) {
                const emission = 9500000 / Math.pow(2, y / 64);
                const circ = RH_CIRC_BY_YEAR[Math.min(y, RH_CIRC_BY_YEAR.length - 1)];
                const apy = emission / (circ * partRate);
                total += apy * dollarAmount;
            }
            return { cumulative: total, yr10Apy: yr10Apy };
        }

        let lastPartRate = 0.30;
        let lastApy = 0;

        function drawEndowSparkline(yearlyCredits) {
            const wrap = document.getElementById('endow-sparkline-wrap');
            const canvas = document.getElementById('endow-sparkline');
            if (!wrap || !canvas) return;
            wrap.style.display = 'block';

            if (endowSparkChart) { endowSparkChart.destroy(); endowSparkChart = null; }

            const light = isLightMode();
            const tickColor = light ? '#9CA3AF' : '#555';
            const fmtD = v => v >= 1e6 ? '$' + (v / 1e6).toFixed(1) + 'M' : '$' + (v / 1e3).toFixed(0) + 'K';
            const labels = yearlyCredits.map((_, i) => 'Y' + (i + 1));

            // Bars fade gently from full gold (Y1) to 55% opacity (Y10)
            const bgColors = yearlyCredits.map((_, i) => {
                const opacity = 1 - (i / yearlyCredits.length) * 0.45;
                return `rgba(201,162,39,${opacity.toFixed(2)})`;
            });

            endowSparkChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: yearlyCredits,
                        backgroundColor: bgColors,
                        borderColor: 'transparent',
                        borderRadius: 3,
                        borderSkipped: false,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 400 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: ctx => 'Year ' + ctx[0].dataIndex + 1,
                                label: ctx => ' ' + fmtD(ctx.parsed.y) + ' in credits',
                            },
                        },
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: tickColor, font: { size: 9 } } },
                        y: { display: false },
                    },
                },
            });
        }

        function updateEndowmentCard() {
            const inputEl = document.getElementById('endow-input');
            const amount = parseFloat(inputEl ? inputEl.value : 1000000) || 1000000;
            const partRate = lastPartRate > 0.01 ? lastPartRate : 0.30;
            const yr1Credits = amount * lastApy;
            const proj = projectCumulativeCredits(partRate, amount);

            // Per-year credits for sparkline (same formula as projectCumulativeCredits)
            if (lastApy > 0) {
                const yearlyCredits = [];
                for (let y = 0; y < 10; y++) {
                    const emission = 9500000 / Math.pow(2, y / 64);
                    const circ = RH_CIRC_BY_YEAR[Math.min(y, RH_CIRC_BY_YEAR.length - 1)];
                    yearlyCredits.push((emission / (circ * partRate)) * amount);
                }
                drawEndowSparkline(yearlyCredits);
            }

            // Hero result cards
            const yr1El = document.getElementById('endow-yr1');
            const yr10El = document.getElementById('endow-yr10');
            const principalEl = document.getElementById('endow-principal');
            const apyLabelEl = document.getElementById('endow-apy-label');
            const yr10ApyEl = document.getElementById('endow-yr10-apy');
            if (yr1El) yr1El.textContent = formatDollars(yr1Credits);
            if (yr10El) yr10El.textContent = formatDollars(proj.cumulative);
            if (principalEl) principalEl.textContent = formatDollars(amount);
            if (apyLabelEl) apyLabelEl.textContent = 'at ' + (lastApy * 100).toFixed(1) + '% APY';
            if (yr10ApyEl) yr10ApyEl.textContent = 'Year 10 APY: ' + (proj.yr10Apy * 100).toFixed(1) + '%';

            // Right column mini projection (IDs match endow-yr1-r etc in HTML)
            const yr1R = document.getElementById('endow-yr1-r');
            const yr10R = document.getElementById('endow-yr10-r');
            const aL = document.getElementById('endow-apy-label-r');
            const y10A = document.getElementById('endow-yr10-apy-r');
            if (yr1R) yr1R.textContent = formatDollars(yr1Credits);
            if (yr10R) yr10R.textContent = formatDollars(proj.cumulative);
            if (aL) aL.textContent = 'at ' + (lastApy * 100).toFixed(1) + '% APY';
            if (y10A) y10A.textContent = 'Year 10 APY: ' + (proj.yr10Apy * 100).toFixed(1) + '%';

            // Comparison table vs cash donation
            if (yr1Credits > 0) {
                const compare = document.getElementById('endow-compare');
                if (compare) compare.style.display = 'block';
                const fmtAmt = formatDollars(amount);
                const p = document.getElementById('compare-rsc-principal');
                const c1 = document.getElementById('compare-cash-yr1');
                const r1 = document.getElementById('compare-rsc-yr1');
                const c10 = document.getElementById('compare-cash-yr10');
                const r10 = document.getElementById('compare-rsc-yr10');
                const p10 = document.getElementById('compare-rsc-principal-10');
                if (p) p.textContent = fmtAmt + ' ✓';
                if (c1) c1.textContent = fmtAmt;
                if (r1) r1.textContent = formatDollars(yr1Credits) + ' (credits)';
                if (c10) c10.textContent = fmtAmt;
                if (r10) r10.textContent = formatDollars(proj.cumulative) + ' (credits)';
                if (p10) p10.textContent = fmtAmt + ' ✓';
            }
        }

        // ============================================================
        // Quick scenario loader (tab compat)
        // ============================================================
        async function loadScenario(participation, threshold) {
            const partSlider = document.getElementById('slider-participation');
            const partPct = Math.round(participation * 100);
            partSlider.value = partPct;
            document.getElementById('val-participation').textContent = partPct + '%';
            const threshSlider = document.getElementById('slider-threshold');
            const threshPct = Math.round(threshold * 100);
            threshSlider.value = threshPct;
            document.getElementById('val-threshold').textContent = threshPct + '%';
            updateArchBar();
            await resetWithParams();
        }

        // Stub tab functions for any code that calls switchTab
        function switchTab(tabId) {
            if (tabId === 'holder-activity') {
                const dtAccordion = document.querySelectorAll('details.accordion')[2];
                if (dtAccordion) dtAccordion.open = true;
            }
        }
        function toggleSection(header) {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.toggle');
            if (body) body.classList.toggle('collapsed');
            if (toggle) toggle.innerHTML = (body && body.classList.contains('collapsed')) ? '&#9654;' : '&#9660;';
        }

        // ============================================================
        // Init
        // ============================================================
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-toggle-btn').textContent = 'Light mode';
        }

        updateUI();
        updateArchBar();
    </script>
</body>
</html>
