<!--
  RSC Decentralized Endowment ABM — Single-page dashboard
  All CSS, HTML, and JS in one file for deployment simplicity.

  TABLE OF CONTENTS
  =================
  CSS
    Line ~10    Styles — sidebar, main area, grid, charts, modals
    Line ~40    Sidebar styles
    Line ~260   Main area styles

  HTML
    Line ~800   Sidebar — controls, parameters, archetype mix, tiers, advanced, scenarios
    Line ~1060  Main area — KPIs, tabs (Agent Field, Time Series, Proposals, Inspector)

  JAVASCRIPT
    Line ~1170  DotGrid class — agent field canvas rendering
    Line ~1310  State & API constants
    Line ~1340  Tab system
    Line ~1370  Archetype linked sliders (sum-to-100%)
    Line ~1460  getSliderParams / resetSliders
    Line ~1520  Main UI update loop
    Line ~1700  Chart system (Chart.js)
    Line ~1785  Actions — step(), run(), resetWithParams()
    Line ~1845  Scenarios — save, compare, modal
    Line ~1985  Design questions loader
    Line ~2000  Agent Inspector — tabs, detail panel
    Line ~2110  Narrative generation (weekly activity log)
    Line ~2160  Post-run summary with archetype cards
    Line ~2325  Init
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSC Endowment ABM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-alt: #0d0d0d;
            --bg-panel: #0f0f0f;
            --bg-card: #111;
            --bg-hover: #151515;
            --border: #1a1a1a;
            --border-light: #2a2a2a;
            --text: #d0d0d0;
            --text-muted: #888;
            --text-dim: #555;
            --accent: #c9a227;
            --success: #50c878;
            --danger: #e05555;
            --info: #4a9eff;
            --purple: #7856ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-width: 1200px;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: 320px;
            min-width: 320px;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg-alt);
            border-right: 1px solid var(--border);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .sidebar-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }
        .sidebar-header h1 {
            color: var(--accent);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .sidebar-header .subtitle {
            color: var(--text-muted);
            font-size: 10px;
            line-height: 1.4;
        }

        /* Controls */
        .controls {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        button {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            transition: all 0.15s;
        }
        button:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
            color: var(--accent);
        }
        button.primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }
        button.primary:hover { background: #d4ad32; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-badges {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        .step-badge {
            background: var(--bg-panel);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            font-size: 10px;
            color: var(--text-muted);
        }
        .step-badge span { color: var(--accent); font-weight: 600; }

        /* Sidebar Sections */
        .sidebar-section {
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
        }
        .sidebar-section-header {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .sidebar-section-header:hover { color: var(--text); }
        .sidebar-section-header .toggle { font-size: 8px; color: var(--text-dim); }
        .sidebar-section-body { padding: 12px; }
        .sidebar-section-body.collapsed { display: none; }

        /* Param Sliders (sidebar = single column) */
        .param-sliders {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }
        .slider-label { color: var(--text-muted); }
        .slider-value { color: var(--accent); font-weight: 600; font-family: monospace; }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .slider-hint {
            font-size: 9px;
            color: var(--text-dim);
        }

        /* Archetype bar */
        .archetype-bar {
            display: flex; height: 20px; border-radius: 4px; overflow: hidden;
            margin-bottom: 8px; border: 1px solid var(--border);
        }
        .arch-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 600; color: #000;
            transition: width 0.3s;
        }
        .arch-believer { background: var(--success); }
        .arch-yield_seeker { background: var(--accent); }
        .arch-governance { background: var(--purple); }
        .arch-speculator { background: var(--danger); }

        .arch-legend { display: flex; gap: 8px; flex-wrap: wrap; font-size: 10px; margin-bottom: 8px; }
        .arch-legend-item { display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
        .arch-dot { width: 6px; height: 6px; border-radius: 2px; }

        .apply-params {
            margin-top: 8px;
            width: 100%;
        }
        .btn-row { display: flex; gap: 6px; margin-top: 8px; }
        .btn-row button { flex: 1; }

        /* Design Lab */
        .design-toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; font-size: 11px;
        }
        .design-toggle-row label { color: var(--text-muted); cursor: pointer; }
        .design-hint { font-size: 9px; color: var(--text-dim); margin-bottom: 8px; }
        select {
            background: var(--bg-panel);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            width: 100%;
        }
        input[type="checkbox"] {
            accent-color: var(--accent);
        }

        /* Education (sidebar collapsible) */
        .edu-section {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
        }
        .edu-section:last-child { border-bottom: none; }
        .edu-section h3 {
            font-size: 11px;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .edu-section p, .edu-section li {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .edu-section ul, .edu-section ol {
            margin-left: 16px;
            margin-top: 4px;
        }
        .edu-section li { margin-bottom: 2px; }
        .edu-section strong { color: var(--text); }

        /* Design Questions in sidebar */
        .question {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .question:last-child { border-bottom: none; }
        .question-text { font-size: 11px; color: var(--text); margin-bottom: 4px; }
        .question-current {
            font-size: 10px;
            color: var(--text-dim);
        }
        .question-current span { color: var(--accent); }

        /* ==================== MAIN AREA ==================== */
        .main {
            flex: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Pinned Metrics Bar */
        .metrics-bar {
            display: flex;
            gap: 2px;
            padding: 8px 16px;
            background: var(--bg-alt);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .metric {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            background: var(--bg-panel);
            border-radius: 4px;
            position: relative;
            cursor: help;
            transition: transform 0.15s;
        }
        .metric.pulse {
            animation: metric-pulse 0.3s ease-out;
        }
        @keyframes metric-pulse {
            0% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'SF Mono', monospace;
            transition: color 0.4s ease;
        }
        .metric-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        .metric[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            color: var(--text);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 100;
            border: 1px solid var(--border-light);
            margin-bottom: 4px;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            gap: 0;
            background: var(--bg-alt);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            flex-shrink: 0;
        }
        .tab-btn {
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            padding: 10px 16px;
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .tab-btn:hover {
            color: var(--text);
            background: transparent;
            border-color: transparent;
        }
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: transparent;
        }

        /* Tab Content Area */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .tab-pane { display: none; height: 100%; }
        .tab-pane.active { display: flex; flex-direction: column; gap: 16px; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .card-header {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Sim Canvas */
        .sim-canvas-wrap {
            position: relative;
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
            background: #080808;
            flex: 1;
            min-height: 400px;
        }
        .agent-grid {
            display: grid;
            gap: 3px;
            padding: 24px;
            width: 100%;
            height: 100%;
            align-content: center;
            justify-content: center;
        }
        .agent-cell {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.4s, box-shadow 0.4s;
        }
        .agent-cell:hover {
            outline: 1.5px solid rgba(255,255,255,0.8);
            outline-offset: 1px;
            z-index: 1;
        }
        .agent-cell.churned {
            opacity: 0.06 !important;
            cursor: default;
        }
        .agent-cell.deploy-flash {
            animation: cell-flash 0.5s ease-out;
        }
        @keyframes cell-flash {
            0% { box-shadow: inset 0 0 14px rgba(255,255,255,0.8), 0 0 6px rgba(255,255,255,0.4); }
            100% { box-shadow: none; }
        }
        /* Canvas tooltip */
        .canvas-tooltip {
            display: none;
            position: absolute;
            background: rgba(20,20,20,0.95);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 10px;
            pointer-events: none;
            z-index: 50;
            max-width: 200px;
            line-height: 1.5;
        }
        .canvas-tooltip .tt-id { color: var(--accent); font-weight: 600; }
        .canvas-tooltip .tt-label { color: var(--text-muted); }
        .canvas-tooltip .tt-val { color: var(--text); }
        /* Canvas legend */
        .canvas-legend {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10,10,10,0.85);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 14px;
            font-size: 10px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            z-index: 40;
            white-space: nowrap;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-divider { width: 1px; height: 14px; background: var(--border); margin: 0; }
        .legend-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .legend-encoding { color: var(--text-dim); font-size: 9px; }

        /* Chart views */
        .chart-view-switcher {
            display: flex;
            gap: 0;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .chart-view-btn {
            background: transparent;
            border: none;
            border-right: 1px solid var(--border-light);
            color: var(--text-muted);
            padding: 6px 12px;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
        }
        .chart-view-btn:last-child { border-right: none; }
        .chart-view-btn:hover { color: var(--text); }
        .chart-view-btn.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }
        .chart-container { height: 280px; }

        /* Tier bars */
        .tier-bar {
            display: flex; height: 24px; border-radius: 4px; overflow: hidden;
            margin-bottom: 12px; border: 1px solid var(--border);
        }
        .tier-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 600; color: #000;
        }
        .tier-flexible { background: #536471; }
        .tier-3month { background: #4a9eff; }
        .tier-6month { background: #7856ff; }
        .tier-12month { background: var(--accent); }
        .tier-legend { display: flex; gap: 12px; flex-wrap: wrap; font-size: 11px; }
        .tier-legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .tier-dot { width: 8px; height: 8px; border-radius: 2px; }

        /* Proposals list */
        .list { max-height: 400px; overflow-y: auto; }
        .list-item {
            background: var(--bg-panel);
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .list-item:last-child { margin-bottom: 0; }
        .proposal-id { font-weight: 600; color: var(--text); font-family: monospace; }
        .progress-bar {
            width: 80px; height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            margin: 0 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .progress-fill { height: 100%; background: var(--success); border-radius: 2px; }
        .progress-pct { font-size: 10px; color: var(--text-dim); min-width: 32px; text-align: right; }
        .status { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-open { color: var(--info); }
        .status-funded { color: var(--success); }
        .status-completed { color: var(--success); }
        .status-failed { color: var(--danger); }

        /* Events */
        .event {
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }
        .event:last-child { border-bottom: none; }
        .event-step {
            color: var(--text-dim);
            font-family: monospace;
            margin-right: 8px;
        }
        .event-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }
        .event-type.funded { background: rgba(80,200,120,0.2); color: var(--success); }
        .event-type.completed { background: rgba(80,200,120,0.2); color: var(--success); }
        .event-type.failed { background: rgba(224,85,85,0.2); color: var(--danger); }
        .event-type.new_proposal { background: rgba(74,158,255,0.2); color: var(--info); }
        .event-type.init { background: rgba(201,162,39,0.2); color: var(--accent); }
        .event-type.churn { background: rgba(224,85,85,0.15); color: #c07070; }

        /* Archetype metrics grid */
        .arch-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            font-size: 11px;
        }
        @media (max-width: 1600px) {
            .arch-metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .arch-metric-card {
            background: var(--bg-panel);
            border-radius: 6px;
            padding: 10px;
            border-left: 3px solid var(--border-light);
        }
        .arch-metric-card.believer { border-left-color: var(--success); }
        .arch-metric-card.yield_seeker { border-left-color: var(--accent); }
        .arch-metric-card.governance { border-left-color: var(--purple); }
        .arch-metric-card.speculator { border-left-color: var(--danger); }
        .arch-card-name {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .arch-card-name.believer { color: var(--success); }
        .arch-card-name.yield_seeker { color: var(--accent); }
        .arch-card-name.governance { color: var(--purple); }
        .arch-card-name.speculator { color: var(--danger); }
        .arch-stat { display: flex; justify-content: space-between; color: var(--text-muted); padding: 2px 0; }
        .arch-stat-val { color: var(--text); font-family: monospace; }

        /* Narrative */
        .narrative { font-size: 13px; line-height: 1.7; }
        .narrative-placeholder { color: var(--text-dim); font-style: italic; }
        .narrative-highlight { color: var(--accent); font-weight: 600; }
        .narrative-success { color: var(--success); }
        .narrative-danger { color: var(--danger); }
        .narrative p { margin-bottom: 8px; }
        .narrative p:last-child { margin-bottom: 0; }

        /* Agent Inspector */
        .agent-tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .agent-tab {
            background: transparent;
            border: 1px solid var(--border);
            padding: 5px 10px;
            font-size: 10px;
        }
        .agent-tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        .agent-content { min-height: 120px; }
        .agent-placeholder { color: var(--text-dim); font-style: italic; font-size: 12px; }
        .agent-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        .agent-table th {
            text-align: left;
            padding: 8px;
            background: var(--bg-panel);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
        }
        .agent-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .agent-table tr:hover { background: var(--bg-hover); }
        .agent-table tr.churned { opacity: 0.5; }
        .agent-table tr.highlighted { background: rgba(201,162,39,0.1); outline: 1px solid var(--accent); }
        .agent-id { font-family: monospace; color: var(--accent); font-weight: 600; cursor: pointer; }
        .tier-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .tier-flexible { background: rgba(83,100,113,0.3); color: #536471; }
        .tier-3_month { background: rgba(74,158,255,0.2); color: #4a9eff; }
        .tier-6_month { background: rgba(120,86,255,0.2); color: #7856ff; }
        .tier-12_month { background: rgba(201,162,39,0.2); color: var(--accent); }
        .arch-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .arch-badge.believer { background: rgba(80,200,120,0.2); color: var(--success); }
        .arch-badge.yield_seeker { background: rgba(201,162,39,0.2); color: var(--accent); }
        .arch-badge.governance { background: rgba(120,86,255,0.2); color: var(--purple); }
        .arch-badge.speculator { background: rgba(224,85,85,0.2); color: var(--danger); }
        .sat-bar {
            width: 40px; height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }
        .sat-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Scenario Compare */
        .scenario-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        .scenario-table th, .scenario-table td {
            padding: 6px 10px;
            border: 1px solid var(--border);
            text-align: right;
        }
        .scenario-table th {
            background: var(--bg-panel);
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        .scenario-table th:first-child, .scenario-table td:first-child { text-align: left; }
        .scenario-name-input {
            background: var(--bg-panel);
            color: var(--text);
            border: 1px solid var(--border-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            width: 100%;
        }

        /* Summary panel */
        .summary-panel {
            background: var(--bg-panel);
            border-radius: 6px;
            padding: 16px;
            border-left: 3px solid var(--accent);
        }
        .summary-delta {
            display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px;
        }
        .delta-label { color: var(--text-muted); }
        .delta-pos { color: var(--success); }
        .delta-neg { color: var(--danger); }
        .tension-warning {
            margin-top: 8px; padding: 8px;
            background: rgba(224,85,85,0.1);
            border-radius: 4px;
            border: 1px solid rgba(224,85,85,0.3);
            font-size: 11px;
            color: var(--danger);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* Two-column layout inside tabs */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .three-col { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px; }
        @media (max-width: 1400px) {
            .two-col, .three-col { grid-template-columns: 1fr; }
        }

        /* Scenario comparison modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-body {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 0 4px;
        }
        .modal-close:hover { color: var(--text); }

        /* Metrics detail toggle */
        .detail-toggle {
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        .detail-toggle:hover { color: var(--text); }
    </style>
</head>
<body>
    <!-- ==================== SIDEBAR ==================== -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>RSC DECENTRALIZED ENDOWMENT</h1>
            <div class="subtitle">Stake RSC &rarr; Earn Funding Credits &rarr; Deploy to Research Proposals</div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="primary" onclick="step()">Step</button>
            <button onclick="run(10)">Run 10</button>
            <button onclick="run(52)">Run 1 Year</button>
            <button onclick="resetWithParams()">Reset</button>
        </div>

        <!-- Status Badges -->
        <div class="status-badges">
            <div class="step-badge">Week <span id="step-count">0</span></div>
            <div class="step-badge">Active <span id="active-count">0</span> / <span id="total-count">0</span></div>
            <div class="step-badge">Satisfaction <span id="avg-sat">1.00</span></div>
        </div>

        <!-- Parameters -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Parameters <span class="toggle">&#9660;</span>
            </div>
            <div class="sidebar-section-body">
                <div class="param-sliders">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Yield</span>
                            <span class="slider-value" id="val-yield">10%</span>
                        </div>
                        <input type="range" id="slider-yield" min="1" max="25" value="10" step="1"
                            oninput="document.getElementById('val-yield').textContent=this.value+'%'">
                        <div class="slider-hint">Annual return paid to stakers as funding credits. Higher yield = more credits flowing into the system.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Deploy Rate</span>
                            <span class="slider-value" id="val-deploy">30%</span>
                        </div>
                        <input type="range" id="slider-deploy" min="0" max="100" value="30" step="5"
                            oninput="document.getElementById('val-deploy').textContent=this.value+'%'">
                        <div class="slider-hint">How actively stakers fund proposals with their credits. Low = credits pile up. High = credits flow to research.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Proposal Success</span>
                            <span class="slider-value" id="val-success">80%</span>
                        </div>
                        <input type="range" id="slider-success" min="20" max="100" value="80" step="5"
                            oninput="document.getElementById('val-success').textContent=this.value+'%'">
                        <div class="slider-hint">How often funded research delivers results. Low success = more churn.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Stakers</span>
                            <span class="slider-value" id="val-stakers">100</span>
                        </div>
                        <input type="range" id="slider-stakers" min="20" max="500" value="100" step="10"
                            oninput="document.getElementById('val-stakers').textContent=this.value">
                        <div class="slider-hint">Total number of participants in the staking system.</div>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="primary" onclick="resetWithParams()">Apply & Reset</button>
                    <button onclick="resetSliders()">Defaults</button>
                </div>
            </div>
        </div>

        <!-- Archetype Mix -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Archetype Mix <span class="toggle">&#9660;</span>
            </div>
            <div class="sidebar-section-body">
                <div class="archetype-bar" id="arch-bar"></div>
                <div class="arch-legend">
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--success)"></div> Believer</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--accent)"></div> Yield</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--purple)"></div> Gov</div>
                    <div class="arch-legend-item"><div class="arch-dot" style="background:var(--danger)"></div> Spec</div>
                </div>
                <div class="param-sliders">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--success)">Believers</span>
                            <span class="slider-value" id="val-believer">25%</span>
                        </div>
                        <input type="range" id="slider-believer" min="5" max="85" value="25" step="5"
                            oninput="handleArchSliderChange('believer')">
                        <div class="slider-hint">Mission-driven. Deploy eagerly, back risky research, stick around.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--accent)">Yield Seekers</span>
                            <span class="slider-value" id="val-yield_seeker">30%</span>
                        </div>
                        <input type="range" id="slider-yield_seeker" min="5" max="85" value="30" step="5"
                            oninput="handleArchSliderChange('yield_seeker')">
                        <div class="slider-hint">Return-focused. Deploy selectively, leave if returns disappoint.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--purple)">Governance</span>
                            <span class="slider-value" id="val-governance">20%</span>
                        </div>
                        <input type="range" id="slider-governance" min="5" max="85" value="20" step="5"
                            oninput="handleArchSliderChange('governance')">
                        <div class="slider-hint">Community-oriented. Moderate deployers, value ecosystem health.</div>
                    </div>
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label" style="color:var(--danger)">Speculators</span>
                            <span class="slider-value" id="val-speculator">25%</span>
                        </div>
                        <input type="range" id="slider-speculator" min="5" max="85" value="25" step="5"
                            oninput="handleArchSliderChange('speculator')">
                        <div class="slider-hint">Short-term. Hoard credits, rarely deploy, first to churn.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staking Tiers (moved from Time Series) -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Staking Tiers <span class="toggle">&#9660;</span>
            </div>
            <div class="sidebar-section-body">
                <div class="tier-bar" id="tier-bar"></div>
                <div class="tier-legend" style="gap:8px">
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#536471"></div> Flexible 1x</div>
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#4a9eff"></div> 3mo 1.5x</div>
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#7856ff"></div> 6mo 2x</div>
                    <div class="tier-legend-item"><div class="tier-dot" style="background:#c9a227"></div> 12mo 3x</div>
                </div>
            </div>
        </div>

        <!-- Advanced -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Advanced <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed">
                <div class="slider-group" style="margin-bottom:12px">
                    <div class="slider-header">
                        <span class="slider-label">Burn Rate</span>
                        <span class="slider-value" id="val-burn">2%</span>
                    </div>
                    <input type="range" id="slider-burn" min="0.5" max="10" value="2" step="0.5"
                        oninput="document.getElementById('val-burn').textContent=this.value+'%'">
                    <div class="slider-hint">Fee burned when credits are deployed to proposals. Higher burn = more RSC removed from supply.</div>
                </div>
                <div class="design-toggle-row">
                    <label><input type="checkbox" id="chk-credit-expiry" onchange="updateDesignLabState()"> Credit Expiry</label>
                </div>
                <div id="credit-expiry-controls" style="display:none">
                    <div class="slider-group" style="margin-bottom:8px">
                        <div class="slider-header">
                            <span class="slider-label">Expiry Period</span>
                            <span class="slider-value" id="val-expiry-weeks">8 wk</span>
                        </div>
                        <input type="range" id="slider-expiry-weeks" min="4" max="16" value="8" step="1"
                            oninput="document.getElementById('val-expiry-weeks').textContent=this.value+' wk'">
                    </div>
                    <div class="design-hint">Unused credits expire, creating deployment urgency. Oldest credits consumed first (FIFO).</div>
                </div>

                <div class="design-toggle-row">
                    <label>Failure Mode</label>
                </div>
                <select id="select-failure-mode" onchange="updateFailureModeHint()">
                    <option value="nothing">Nothing (credits consumed)</option>
                    <option value="partial_refund">Partial Refund (50% credits back)</option>
                    <option value="satisfaction_only">Extra Satisfaction Penalty (-15%)</option>
                </select>
                <div class="design-hint" id="failure-mode-hint">Backers lose their deployed credits but stake is unaffected. Simple but may frustrate mission-aligned stakers.</div>

                <div class="design-toggle-row" style="margin-top:8px">
                    <label><input type="checkbox" id="chk-min-stake" onchange="updateDesignLabState()"> Min Stake</label>
                </div>
                <div id="min-stake-controls" style="display:none">
                    <div class="slider-group" style="margin-bottom:8px">
                        <div class="slider-header">
                            <span class="slider-label">Minimum RSC</span>
                            <span class="slider-value" id="val-min-stake">1000</span>
                        </div>
                        <input type="range" id="slider-min-stake" min="500" max="5000" value="1000" step="100"
                            oninput="document.getElementById('val-min-stake').textContent=this.value">
                    </div>
                    <div class="design-hint">Agents below the minimum cannot stake. Filters out small speculators but reduces accessibility.</div>
                </div>
            </div>
        </div>

        <!-- Scenario Save -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Scenarios <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed">
                <div style="display:flex;gap:6px;margin-bottom:8px">
                    <button onclick="saveScenario()" style="flex:1">Save Current</button>
                    <button onclick="openScenarioModal()" style="flex:1">Compare</button>
                </div>
                <div id="saved-scenarios-list" style="font-size:10px;color:var(--text-muted)">No saved scenarios</div>
                <button onclick="clearScenarios()" style="width:100%;margin-top:8px;font-size:10px">Clear All</button>
            </div>
        </div>

        <!-- Education -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                How It Works <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed">
                <div class="edu-section">
                    <h3>B = f(P, E)</h3>
                    <p>Each staker has <strong>Person attributes</strong> (mission alignment, risk tolerance, engagement, price sensitivity) that interact with <strong>Environment conditions</strong> to produce behavior.</p>
                </div>
                <div class="edu-section">
                    <h3>Each Step (Week)</h3>
                    <ol>
                        <li><strong>Credit Generation:</strong> All active stakers earn credits</li>
                        <li><strong>Deployment:</strong> Behavioral decision to deploy</li>
                        <li><strong>Proposal Selection:</strong> Mission-aligned pick near-funded</li>
                        <li><strong>Fee:</strong> Funding fee burned when credits deployed to proposals</li>
                        <li><strong>Satisfaction:</strong> Updated from outcomes</li>
                        <li><strong>Churn:</strong> Unsatisfied + unlocked may leave</li>
                    </ol>
                </div>
                <div class="edu-section">
                    <h3>Key Dynamics</h3>
                    <ul>
                        <li><strong>Archetypes:</strong> Believers deploy; Speculators hoard</li>
                        <li><strong>Churn:</strong> Failed proposals reduce satisfaction</li>
                        <li><strong>Tier distribution:</strong> Risk-tolerant lock longer</li>
                        <li><strong>Credit pressure:</strong> Sigmoid forces deployment</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Design Questions -->
        <div class="sidebar-section">
            <div class="sidebar-section-header" onclick="toggleSection(this)">
                Design Questions <span class="toggle">&#9654;</span>
            </div>
            <div class="sidebar-section-body collapsed" id="design-questions"></div>
        </div>
    </div>

    <!-- ==================== MAIN AREA ==================== -->
    <div class="main">
        <!-- Pinned Metrics Bar (3 KPIs) -->
        <div class="metrics-bar">
            <div class="metric" data-tooltip="Total RSC locked by active stakers">
                <div class="metric-value" id="total-staked" style="font-size:22px">0</div>
                <div class="metric-label">RSC Staked</div>
            </div>
            <div class="metric" data-tooltip="Average satisfaction across active stakers (1.0 = happy, 0 = churning)">
                <div class="metric-value" id="metric-satisfaction" style="font-size:22px;color:var(--success)">1.00</div>
                <div class="metric-label">Satisfaction</div>
            </div>
            <div class="metric" data-tooltip="Stakers who left the system (low satisfaction + unlocked)">
                <div class="metric-value" id="churned-count" style="font-size:22px;color:var(--danger)">0</div>
                <div class="metric-label">Churned</div>
            </div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="agent-field">Agent Field</button>
            <button class="tab-btn" data-tab="time-series">Time Series</button>
            <button class="tab-btn" data-tab="proposals-funding">Proposals & Funding</button>
            <button class="tab-btn" data-tab="agent-inspector">Agent Inspector</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- TAB: Agent Field -->
            <div class="tab-pane active" id="tab-agent-field">
                <div class="sim-canvas-wrap">
                    <div id="agent-grid" class="agent-grid"></div>
                    <div class="canvas-tooltip" id="canvas-tooltip"></div>
                    <div class="canvas-legend">
                        <div class="legend-item"><div class="legend-dot" style="background:var(--success)"></div> Believer</div>
                        <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> Yield Seeker</div>
                        <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div> Governance</div>
                        <div class="legend-item"><div class="legend-dot" style="background:var(--danger)"></div> Speculator</div>
                        <div class="legend-divider"></div>
                        <span class="legend-encoding">Opacity=Satisfaction</span>
                        <span class="legend-encoding">Glow=Credit Pressure</span>
                    </div>
                </div>
                <!-- Archetype Behavior (moved from Time Series) -->
                <div class="card">
                    <div class="card-header">Archetype Behavior</div>
                    <div class="arch-metrics-grid" id="arch-metrics"></div>
                </div>
                <!-- Post-run summary -->
                <div id="post-run-summary" style="display:none"></div>
            </div>

            <!-- TAB: Time Series -->
            <div class="tab-pane" id="tab-time-series">
                <div class="card">
                    <div class="card-header">Time Series</div>
                    <div class="chart-view-switcher">
                        <button class="chart-view-btn active" data-view="token-economics" onclick="switchChartView('token-economics')">Token Economics</button>
                        <button class="chart-view-btn" data-view="agent-health" onclick="switchChartView('agent-health')">Agent Health</button>
                        <button class="chart-view-btn" data-view="funding-flow" onclick="switchChartView('funding-flow')">Funding Flow</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="history-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TAB: Proposals & Funding -->
            <div class="tab-pane" id="tab-proposals-funding">
                <div class="two-col">
                    <div class="card">
                        <div class="card-header">Proposals</div>
                        <div class="list" id="proposals-list"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Event Log</div>
                        <div class="list" id="events-list" style="max-height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- TAB: Agent Inspector -->
            <div class="tab-pane" id="tab-agent-inspector">
                <div class="card">
                    <div class="agent-tabs">
                        <button class="agent-tab active" onclick="showAgentTab('top-stakers', this)">Top Stakers</button>
                        <button class="agent-tab" onclick="showAgentTab('recent-deployers', this)">Recent Deployers</button>
                        <button class="agent-tab" onclick="showAgentTab('by-archetype', this)">By Archetype</button>
                        <button class="agent-tab" onclick="showAgentTab('churned', this)">Churned</button>
                    </div>
                    <div id="agent-content" class="agent-content" style="max-height:600px;overflow-y:auto;">
                        <div class="agent-placeholder">Loading agents...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Scenario Comparison Modal -->
    <div class="modal-overlay" id="scenario-modal">
        <div class="modal-body">
            <div class="modal-header">
                <div class="card-header" style="margin:0;padding:0;border:0">Scenario Comparison</div>
                <button class="modal-close" onclick="closeScenarioModal()">&times;</button>
            </div>
            <div id="scenario-compare-content">
                <p style="color:var(--text-dim);font-size:12px;">Save scenarios from the sidebar to compare them here. Run a simulation, then click "Save Current Scenario".</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DotGrid -- GitHub-heatmap-style agent field
        // ============================================
        class DotGrid {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.cells = [];
                this.archColors = {
                    believer:     '#50c878',
                    yield_seeker: '#c9a227',
                    governance:   '#7856ff',
                    speculator:   '#e05555',
                };
            }

            update(stakers, stepDeployments) {
                // Sort: group by archetype, then by stake within group
                const archOrder = ['believer', 'yield_seeker', 'governance', 'speculator'];
                const sorted = [...stakers].sort((a, b) => {
                    const ai = archOrder.indexOf(a.archetype);
                    const bi = archOrder.indexOf(b.archetype);
                    if (ai !== bi) return ai - bi;
                    return b.stake - a.stake;
                });

                // Deployer set for flash
                const deployerIds = new Set();
                if (stepDeployments) {
                    stepDeployments.forEach(d => deployerIds.add(d.staker_id));
                }

                // Compute grid columns
                const cols = Math.ceil(Math.sqrt(sorted.length));
                this.container.style.gridTemplateColumns = 'repeat(' + cols + ', 28px)';

                // Rebuild cells if count changed
                if (this.cells.length !== sorted.length) {
                    this.container.innerHTML = '';
                    this.cells = [];
                    sorted.forEach(() => {
                        const cell = document.createElement('div');
                        cell.className = 'agent-cell';
                        this._attachEvents(cell);
                        this.container.appendChild(cell);
                        this.cells.push(cell);
                    });
                }

                // Update each cell
                sorted.forEach((s, i) => {
                    const cell = this.cells[i];
                    cell._staker = s;
                    this._updateCell(cell, s, deployerIds.has(s.id));
                });
            }

            _updateCell(cell, s, hasDeployment) {
                const color = this.archColors[s.archetype] || '#888';

                if (!s.active) {
                    cell.style.backgroundColor = color;
                    cell.style.opacity = '0.06';
                    cell.style.boxShadow = 'none';
                    cell.className = 'agent-cell churned';
                    return;
                }

                cell.className = 'agent-cell';
                cell.style.backgroundColor = color;
                cell.style.opacity = (0.15 + s.satisfaction * 0.85).toFixed(2);

                // Credit pressure = inner white glow
                const pressure = s.credits_pressure || 0;
                if (pressure > 0.2) {
                    const glowSize = 3 + pressure * 4;
                    const glowAlpha = Math.min(pressure * 0.35, 0.7);
                    cell.style.boxShadow = 'inset 0 0 ' + glowSize.toFixed(0) + 'px rgba(255,255,255,' + glowAlpha.toFixed(2) + ')';
                } else {
                    cell.style.boxShadow = 'none';
                }

                // Deployment flash via CSS animation
                if (hasDeployment) {
                    cell.classList.remove('deploy-flash');
                    void cell.offsetWidth;
                    cell.classList.add('deploy-flash');
                }
            }

            _attachEvents(cell) {
                cell.addEventListener('mouseenter', () => {
                    const s = cell._staker;
                    if (!s) return;
                    const tooltip = document.getElementById('canvas-tooltip');
                    tooltip.innerHTML =
                        '<div><span class="tt-id">' + s.id + '</span> <span class="tt-label">(' + s.archetype + ')</span></div>' +
                        '<div><span class="tt-label">Stake:</span> <span class="tt-val">' + formatNumber(s.stake) + '</span></div>' +
                        '<div><span class="tt-label">Credits:</span> <span class="tt-val">' + formatNumber(s.credits) + '</span></div>' +
                        '<div><span class="tt-label">Satisfaction:</span> <span class="tt-val">' + s.satisfaction.toFixed(2) + '</span></div>' +
                        '<div><span class="tt-label">Pressure:</span> <span class="tt-val">' + (s.credits_pressure || 0).toFixed(2) + '</span></div>' +
                        '<div><span class="tt-label">Deployed:</span> <span class="tt-val">' + formatNumber(s.total_deployed) + '</span></div>';
                    tooltip.style.display = 'block';
                    const rect = cell.getBoundingClientRect();
                    const wrapRect = cell.closest('.sim-canvas-wrap').getBoundingClientRect();
                    tooltip.style.left = Math.min(rect.right - wrapRect.left + 8, wrapRect.width - 220) + 'px';
                    tooltip.style.top = (rect.top - wrapRect.top) + 'px';
                });

                cell.addEventListener('mouseleave', () => {
                    document.getElementById('canvas-tooltip').style.display = 'none';
                });

                cell.addEventListener('click', () => {
                    const s = cell._staker;
                    if (s) {
                        switchTab('agent-inspector');
                        highlightedAgentId = s.id;
                        showAgentTab('top-stakers', document.querySelector('.agent-tab'));
                    }
                });
            }

            reset() {
                this.container.innerHTML = '';
                this.cells = [];
            }

            forceRedraw() {
                // CSS grid handles layout automatically
            }
        }

        const simCanvas = new DotGrid('agent-grid');

        // ============================================
        // State
        // ============================================
        const API = '';
        let chart = null;
        let currentChartView = 'token-economics';
        let historyData = {
            steps: [], staked: [], credits: [], burned: [], satisfaction: [], active: [],
            sat_believer: [], sat_yield_seeker: [], sat_governance: [], sat_speculator: [],
            credits_generated_step: [], credits_deployed_step: [], churn_step: [],
        };
        let highlightedAgentId = null;
        let savedScenarios = [];
        let initialSnapshot = null;

        async function fetchJson(url, options = {}) {
            const resp = await fetch(API + url, options);
            return resp.json();
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return Math.round(n).toLocaleString();
        }

        function satColor(sat) {
            if (sat >= 0.7) return 'var(--success)';
            if (sat >= 0.4) return 'var(--accent)';
            return 'var(--danger)';
        }

        // ============================================
        // Tab System
        // ============================================
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');

            // Resize canvas/chart when switching to their tabs
            if (tabId === 'agent-field') {
                setTimeout(() => simCanvas.forceRedraw(), 50);
            }
            if (tabId === 'time-series') {
                setTimeout(() => {
                    if (chart) chart.resize();
                }, 50);
            }
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Sidebar section toggle
        function toggleSection(header) {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.toggle');
            body.classList.toggle('collapsed');
            if (toggle) toggle.innerHTML = body.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
        }

        // ============================================
        // Archetype mix preview
        // ============================================
        function handleArchSliderChange(changedArch) {
            const archs = ['believer', 'yield_seeker', 'governance', 'speculator'];
            const slider = document.getElementById('slider-' + changedArch);
            let newVal = Math.max(5, Math.min(85, Math.round(parseInt(slider.value) / 5) * 5));
            slider.value = newVal;

            const others = archs.filter(a => a !== changedArch);
            const remaining = 100 - newVal;

            // Get old values for proportional redistribution
            let otherOldTotal = 0;
            const oldVals = {};
            others.forEach(a => {
                oldVals[a] = parseInt(document.getElementById('slider-' + a).value);
                otherOldTotal += oldVals[a];
            });

            // Distribute remaining proportionally
            const newVals = {};
            if (otherOldTotal > 0) {
                others.forEach(a => {
                    const proportion = oldVals[a] / otherOldTotal;
                    newVals[a] = Math.max(5, Math.round(remaining * proportion / 5) * 5);
                });
            } else {
                others.forEach(a => {
                    newVals[a] = Math.max(5, Math.floor(remaining / 3 / 5) * 5);
                });
            }

            // Fix rounding: adjust largest "other" to make sum exactly 100
            let otherSum = 0;
            others.forEach(a => { otherSum += newVals[a]; });
            const diff = remaining - otherSum;
            if (diff !== 0) {
                // Find the largest other to absorb the rounding error
                let largest = others[0];
                others.forEach(a => { if (newVals[a] > newVals[largest]) largest = a; });
                newVals[largest] = Math.max(5, newVals[largest] + diff);
            }

            // Apply values
            others.forEach(a => {
                document.getElementById('slider-' + a).value = newVals[a];
                document.getElementById('val-' + a).textContent = newVals[a] + '%';
            });
            document.getElementById('val-' + changedArch).textContent = newVal + '%';

            // Update archetype bar
            updateArchBar();
        }

        function updateArchBar() {
            const archs = ['believer', 'yield_seeker', 'governance', 'speculator'];
            const colors = {
                believer: 'var(--success)',
                yield_seeker: 'var(--accent)',
                governance: 'var(--purple)',
                speculator: 'var(--danger)'
            };
            const bar = document.getElementById('arch-bar');
            if (!bar) return;
            bar.innerHTML = '';
            archs.forEach(a => {
                const val = parseInt(document.getElementById('slider-' + a).value);
                const seg = document.createElement('div');
                seg.className = 'archetype-bar-segment';
                seg.style.width = val + '%';
                seg.style.background = colors[a];
                bar.appendChild(seg);
            });
        }

        function getSliderParams() {
            const archs = ['believer', 'yield_seeker', 'governance', 'speculator'];
            const mix = {};
            archs.forEach(a => {
                mix[a] = parseInt(document.getElementById('slider-' + a).value) / 100;
            });

            const params = {
                num_stakers: parseInt(document.getElementById('slider-stakers').value),
                base_apy: parseInt(document.getElementById('slider-yield').value) / 100,
                deploy_probability: parseInt(document.getElementById('slider-deploy').value) / 100,
                success_rate: parseInt(document.getElementById('slider-success').value) / 100,
                burn_rate: parseFloat(document.getElementById('slider-burn').value) / 100,
                archetype_mix: mix,
            };

            // Design Lab params
            if (document.getElementById('chk-credit-expiry').checked) {
                params.credit_expiry_enabled = true;
                params.credit_expiry_weeks = parseInt(document.getElementById('slider-expiry-weeks').value);
            }
            params.failure_mode = document.getElementById('select-failure-mode').value;
            if (document.getElementById('chk-min-stake').checked) {
                params.min_stake_enabled = true;
                params.min_stake_amount = parseInt(document.getElementById('slider-min-stake').value);
            }

            return params;
        }

        function resetSliders() {
            document.getElementById('slider-yield').value = 10;
            document.getElementById('val-yield').textContent = '10%';
            document.getElementById('slider-deploy').value = 30;
            document.getElementById('val-deploy').textContent = '30%';
            document.getElementById('slider-success').value = 80;
            document.getElementById('val-success').textContent = '80%';
            document.getElementById('slider-stakers').value = 100;
            document.getElementById('val-stakers').textContent = '100';
            document.getElementById('slider-burn').value = 2;
            document.getElementById('val-burn').textContent = '2%';
            document.getElementById('slider-believer').value = 25;
            document.getElementById('val-believer').textContent = '25%';
            document.getElementById('slider-yield_seeker').value = 30;
            document.getElementById('val-yield_seeker').textContent = '30%';
            document.getElementById('slider-governance').value = 20;
            document.getElementById('val-governance').textContent = '20%';
            document.getElementById('slider-speculator').value = 25;
            document.getElementById('val-speculator').textContent = '25%';
            updateArchBar();
        }

        // Design Lab state
        function updateFailureModeHint() {
            const hints = {
                'nothing': 'Backers lose their deployed credits but stake is unaffected. Simple but may frustrate mission-aligned stakers.',
                'partial_refund': '50% of deployed credits returned to backers on failure. Reduces risk for deployers but weakens the commitment signal.',
                'satisfaction_only': 'Credits are consumed but satisfaction takes a larger hit. Punishes backing bad proposals without financial cushion.',
            };
            const val = document.getElementById('select-failure-mode').value;
            document.getElementById('failure-mode-hint').textContent = hints[val] || '';
        }

        function updateDesignLabState() {
            document.getElementById('credit-expiry-controls').style.display =
                document.getElementById('chk-credit-expiry').checked ? 'block' : 'none';
            document.getElementById('min-stake-controls').style.display =
                document.getElementById('chk-min-stake').checked ? 'block' : 'none';
        }

        // ============================================
        // Main UI update
        // ============================================
        async function updateUI() {
            const state = await fetchJson('/api/state');
            const model = state.model;

            // Status badges
            document.getElementById('step-count').textContent = model.step;
            document.getElementById('active-count').textContent = model.active_stakers;
            document.getElementById('total-count').textContent = model.num_stakers;
            document.getElementById('avg-sat').textContent = model.avg_satisfaction.toFixed(2);

            // Metrics bar (3 KPIs)
            updateMetric('total-staked', model.total_staked);
            updateMetric('churned-count', model.churned_stakers);
            // Satisfaction (formatted differently)
            const satEl = document.getElementById('metric-satisfaction');
            const satText = model.avg_satisfaction.toFixed(2);
            if (satEl.textContent !== satText) {
                satEl.textContent = satText;
                satEl.style.color = satColor(model.avg_satisfaction);
                const satMetric = satEl.closest('.metric');
                if (satMetric) { satMetric.classList.remove('pulse'); void satMetric.offsetWidth; satMetric.classList.add('pulse'); }
            }

            // Tier distribution
            const dist = model.tier_distribution;
            const tierTotal = Object.values(dist).reduce((a, b) => a + b, 0) || 1;
            document.getElementById('tier-bar').innerHTML =
                '<div class="tier-segment tier-flexible" style="width:' + (dist.flexible / tierTotal * 100) + '%">' + dist.flexible + '</div>' +
                '<div class="tier-segment tier-3month" style="width:' + (dist['3_month'] / tierTotal * 100) + '%">' + dist['3_month'] + '</div>' +
                '<div class="tier-segment tier-6month" style="width:' + (dist['6_month'] / tierTotal * 100) + '%">' + dist['6_month'] + '</div>' +
                '<div class="tier-segment tier-12month" style="width:' + (dist['12_month'] / tierTotal * 100) + '%">' + dist['12_month'] + '</div>';

            // Archetype bar (sidebar)
            const archDist = model.archetype_distribution || {};
            const archTotal = Object.values(archDist).reduce((a, b) => a + b, 0) || 1;
            document.getElementById('arch-bar').innerHTML =
                ['believer', 'yield_seeker', 'governance', 'speculator'].map(a => {
                    const n = archDist[a] || 0;
                    return '<div class="arch-segment arch-' + a + '" style="width:' + (n / archTotal * 100) + '%">' + n + '</div>';
                }).join('');

            // Archetype metrics with sparklines
            const archMetrics = model.archetype_metrics || {};
            const archNames = { believer: 'Believer', yield_seeker: 'Yield Seeker', governance: 'Governance', speculator: 'Speculator' };
            const sparklineColors = { believer: '#50c878', yield_seeker: '#c9a227', governance: '#7856ff', speculator: '#e05555' };
            const satHistoryKeys = { believer: 'sat_believer', yield_seeker: 'sat_yield_seeker', governance: 'sat_governance', speculator: 'sat_speculator' };
            document.getElementById('arch-metrics').innerHTML =
                ['believer', 'yield_seeker', 'governance', 'speculator'].map(a => {
                    const m = archMetrics[a];
                    if (!m) return '<div class="arch-metric-card ' + a + '"><div class="arch-card-name ' + a + '">' + archNames[a] + '</div><div class="arch-stat" style="color:var(--text-dim)">No agents</div></div>';
                    // Build sparkline SVG from history data
                    const satHistory = historyData[satHistoryKeys[a]] || [];
                    let sparklineSvg = '';
                    if (satHistory.length >= 2) {
                        const w = 56, h = 18;
                        const vals = satHistory.filter(v => v !== null);
                        if (vals.length >= 2) {
                            const minV = 0, maxV = 1; // satisfaction range is 0-1
                            const points = vals.map((v, i) => {
                                const x = (i / (vals.length - 1)) * w;
                                const y = h - ((v - minV) / (maxV - minV)) * h;
                                return x.toFixed(1) + ',' + y.toFixed(1);
                            }).join(' ');
                            sparklineSvg = '<svg width="' + w + '" height="' + h + '" style="vertical-align:middle;margin-left:6px">' +
                                '<polyline points="' + points + '" fill="none" stroke="' + sparklineColors[a] + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        }
                    }
                    return '<div class="arch-metric-card ' + a + '">' +
                        '<div class="arch-card-name ' + a + '">' + archNames[a] + '</div>' +
                        '<div class="arch-stat"><span>Active</span><span class="arch-stat-val">' + m.active + '/' + m.total + '</span></div>' +
                        '<div class="arch-stat"><span>Avg Stake</span><span class="arch-stat-val">' + formatNumber(m.avg_stake) + '</span></div>' +
                        '<div class="arch-stat"><span>Satisfaction</span><span class="arch-stat-val" style="color:' + satColor(m.avg_satisfaction) + '">' + m.avg_satisfaction.toFixed(2) + sparklineSvg + '</span></div>' +
                        '<div class="arch-stat"><span>Deployed</span><span class="arch-stat-val">' + formatNumber(m.total_deployed) + '</span></div>' +
                        '<div class="arch-stat"><span>Burned</span><span class="arch-stat-val" style="color:var(--danger)">' + formatNumber(m.total_burned) + '</span></div>' +
                        '</div>';
                }).join('');

            // Events
            const eventsHtml = state.events.slice(0, 20).map(e =>
                '<div class="event">' +
                '<span class="event-step">[' + String(e.step).padStart(3, '0') + ']</span>' +
                '<span class="event-type ' + e.type + '">' + e.type + '</span>' +
                '<span>' + e.message + '</span>' +
                '</div>'
            ).join('');
            document.getElementById('events-list').innerHTML = eventsHtml || '<div class="event" style="color:var(--text-dim)">No events yet</div>';

            // Proposals
            const proposals = await fetchJson('/api/proposals');
            const proposalsHtml = proposals.slice(-12).reverse().map(p =>
                '<div class="list-item">' +
                '<span class="proposal-id">' + p.id + '</span>' +
                '<div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(p.funding_progress, 100) + '%"></div></div>' +
                '<span class="progress-pct">' + Math.round(p.funding_progress) + '%</span>' +
                '<span class="status status-' + p.status + '">' + p.status + '</span>' +
                '</div>'
            ).join('');
            document.getElementById('proposals-list').innerHTML = proposalsHtml || '<div class="list-item" style="color:var(--text-dim)">No proposals</div>';

            // History data
            if (model.step > 0 && !historyData.steps.includes(model.step)) {
                historyData.steps.push(model.step);
                historyData.staked.push(model.total_staked);
                historyData.credits.push(model.total_credits);
                historyData.burned.push(model.total_burned);
                historyData.satisfaction.push(model.avg_satisfaction);
                historyData.active.push(model.active_stakers);
                // Per-archetype satisfaction
                historyData.sat_believer.push(archMetrics.believer ? archMetrics.believer.avg_satisfaction : null);
                historyData.sat_yield_seeker.push(archMetrics.yield_seeker ? archMetrics.yield_seeker.avg_satisfaction : null);
                historyData.sat_governance.push(archMetrics.governance ? archMetrics.governance.avg_satisfaction : null);
                historyData.sat_speculator.push(archMetrics.speculator ? archMetrics.speculator.avg_satisfaction : null);
                // Per-step metrics from backend
                historyData.credits_generated_step.push(model.credits_generated_step || 0);
                historyData.credits_deployed_step.push(model.credits_deployed_step || 0);
                historyData.churn_step.push(model.churn_step || 0);
                updateChart();
            }

            await loadStakers();

            // Canvas
            simCanvas.update(lastStakers, model.step_deployments || []);

            // Post-run summary
            if (model.step >= 10 && initialSnapshot) {
                updatePostRunSummary(model);
            }
        }

        // Metric animation state
        const metricAnimations = {};

        function updateMetric(id, value) {
            const el = document.getElementById(id);
            const formatted = formatNumber(value);
            if (el.textContent === formatted) return;

            // Get previous numeric value from animation state
            const prev = metricAnimations[id];
            if (prev !== undefined && typeof value === 'number' && typeof prev === 'number') {
                // Animate from prev to value over 400ms
                const startVal = prev;
                const endVal = value;
                const startTime = performance.now();
                const duration = 400;

                function animateMetric(now) {
                    const elapsed = now - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    // Ease-out cubic
                    const eased = 1 - Math.pow(1 - progress, 3);
                    const current = startVal + (endVal - startVal) * eased;
                    el.textContent = formatNumber(current);
                    if (progress < 1) {
                        requestAnimationFrame(animateMetric);
                    } else {
                        el.textContent = formatNumber(endVal);
                    }
                }
                requestAnimationFrame(animateMetric);
            } else {
                el.textContent = formatted;
            }

            metricAnimations[id] = value;

            // Pulse animation
            const metric = el.closest('.metric');
            if (metric) {
                metric.classList.remove('pulse');
                void metric.offsetWidth;
                metric.classList.add('pulse');
            }
        }

        // ============================================
        // Chart System
        // ============================================
        function getChartConfig(view) {
            const common = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#888', font: { size: 10, family: 'monospace' }, boxWidth: 12 }
                    }
                },
                scales: {
                    x: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: '#1a1a1a' } },
                }
            };

            if (view === 'token-economics') {
                return {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Staked', data: historyData.staked, borderColor: '#c9a227', backgroundColor: 'rgba(201,162,39,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                            { label: 'Credits', data: historyData.credits, borderColor: '#50c878', backgroundColor: 'rgba(80,200,120,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                            { label: 'Burned', data: historyData.burned, borderColor: '#e05555', backgroundColor: 'rgba(224,85,85,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
                        ]
                    },
                    options: { ...common, scales: { ...common.scales, y: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: '#1a1a1a' } } } }
                };
            }

            if (view === 'agent-health') {
                return {
                    type: 'line',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Believer Sat', data: historyData.sat_believer, borderColor: '#50c878', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Yield Sat', data: historyData.sat_yield_seeker, borderColor: '#c9a227', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Gov Sat', data: historyData.sat_governance, borderColor: '#7856ff', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Spec Sat', data: historyData.sat_speculator, borderColor: '#e05555', tension: 0.3, yAxisID: 'y', pointRadius: 1 },
                            { label: 'Churn', data: historyData.churn_step, borderColor: 'rgba(224,85,85,0.5)', backgroundColor: 'rgba(224,85,85,0.2)', type: 'bar', yAxisID: 'y1' },
                        ]
                    },
                    options: {
                        ...common,
                        scales: {
                            ...common.scales,
                            y: { position: 'left', min: 0, max: 1, title: { display: true, text: 'Satisfaction', color: '#555' }, ticks: { color: '#555', font: { size: 10 } }, grid: { color: '#1a1a1a' } },
                            y1: { position: 'right', min: 0, title: { display: true, text: 'Churn', color: '#555' }, ticks: { color: '#555', font: { size: 10 } }, grid: { drawOnChartArea: false } },
                        }
                    }
                };
            }

            if (view === 'funding-flow') {
                return {
                    type: 'bar',
                    data: {
                        labels: historyData.steps,
                        datasets: [
                            { label: 'Generated', data: historyData.credits_generated_step, backgroundColor: 'rgba(80,200,120,0.5)', borderColor: '#50c878', borderWidth: 1 },
                            { label: 'Deployed', data: historyData.credits_deployed_step, backgroundColor: 'rgba(74,158,255,0.5)', borderColor: '#4a9eff', borderWidth: 1 },
                        ]
                    },
                    options: { ...common, scales: { ...common.scales, y: { ticks: { color: '#555', font: { size: 10 } }, grid: { color: '#1a1a1a' } } } }
                };
            }
        }

        function updateChart() {
            const ctx = document.getElementById('history-chart').getContext('2d');
            if (chart) { chart.destroy(); chart = null; }
            const config = getChartConfig(currentChartView);
            chart = new Chart(ctx, config);
        }

        function switchChartView(view) {
            currentChartView = view;
            document.querySelectorAll('.chart-view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-view="' + view + '"]').classList.add('active');
            updateChart();
        }

        // ============================================
        // Actions
        // ============================================
        async function step() {
            await fetchJson('/api/step', { method: 'POST' });
            await updateUI();
        }

        async function run(n) {
            await fetchJson('/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steps: n })
            });
            const history = await fetchJson('/api/history');
            historyData.steps = history.Step || [];
            historyData.staked = history.Total_Staked || [];
            historyData.credits = history.Total_Credits || [];
            historyData.burned = history.Total_Burned || [];
            historyData.satisfaction = history.Avg_Satisfaction || [];
            historyData.active = history.Active_Stakers || [];
            // New fields from backend
            historyData.sat_believer = history.Sat_Believer || [];
            historyData.sat_yield_seeker = history.Sat_YieldSeeker || [];
            historyData.sat_governance = history.Sat_Governance || [];
            historyData.sat_speculator = history.Sat_Speculator || [];
            historyData.credits_generated_step = history.Credits_Generated_Step || [];
            historyData.credits_deployed_step = history.Credits_Deployed_Step || [];
            historyData.churn_step = history.Churn_Step || [];
            updateChart();
            await updateUI();
            // Force canvas redraw after bulk run
            setTimeout(() => simCanvas.forceRedraw(), 100);
        }

        async function resetWithParams() {
            const params = getSliderParams();
            await fetchJson('/api/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            historyData = {
                steps: [], staked: [], credits: [], burned: [], satisfaction: [], active: [],
                sat_believer: [], sat_yield_seeker: [], sat_governance: [], sat_speculator: [],
                credits_generated_step: [], credits_deployed_step: [], churn_step: [],
            };
            if (chart) { chart.destroy(); chart = null; }
            simCanvas.reset();
            // Capture initial snapshot for post-run summary
            const state = await fetchJson('/api/state');
            initialSnapshot = {
                total_staked: state.model.total_staked,
                total_credits: state.model.total_credits,
                active_stakers: state.model.active_stakers,
                avg_satisfaction: state.model.avg_satisfaction,
                total_burned: state.model.total_burned,
            };
            document.getElementById('post-run-summary').style.display = 'none';
            await updateUI();
        }

        // ============================================
        // Scenarios
        // ============================================
        async function saveScenario() {
            if (savedScenarios.length >= 6) {
                alert('Maximum 6 scenarios. Clear some first.');
                return;
            }
            const state = await fetchJson('/api/state');
            const model = state.model;
            const params = model.params || {};
            // Use slider display values for consistency with what user sees
            const yieldDisplay = document.getElementById('slider-yield').value;
            const deployDisplay = document.getElementById('slider-deploy').value;
            const successDisplay = document.getElementById('slider-success').value;
            const defaultName = 'Scenario ' + (savedScenarios.length + 1) + ' \u2014 ' +
                yieldDisplay + '% yield, ' + deployDisplay + '% deploy, ' + successDisplay + '% success';
            const name = prompt('Scenario name:', defaultName);
            if (!name) return;

            savedScenarios.push({
                name: name,
                step: model.step,
                params: params,
                metrics: {
                    total_staked: model.total_staked,
                    total_credits: model.total_credits,
                    total_burned: model.total_burned,
                    active_stakers: model.active_stakers,
                    churned_stakers: model.churned_stakers,
                    avg_satisfaction: model.avg_satisfaction,
                    credit_generation_rate: model.credit_generation_rate,
                    deployment_rate: model.deployment_rate,
                    success_rate_actual: model.success_rate_actual,
                    completed_proposals: model.completed_proposals,
                    failed_proposals: model.failed_proposals,
                    open_proposals: model.open_proposals,
                    num_stakers: model.num_stakers,
                },
            });
            updateScenariosList();
            updateScenarioCompare();
        }

        function clearScenarios() {
            savedScenarios = [];
            updateScenariosList();
            updateScenarioCompare();
        }

        function updateScenariosList() {
            const el = document.getElementById('saved-scenarios-list');
            if (savedScenarios.length === 0) {
                el.innerHTML = 'No saved scenarios';
                return;
            }
            el.innerHTML = savedScenarios.map((s, i) =>
                '<div style="padding:3px 0;border-bottom:1px solid var(--border)">' +
                '<span style="color:var(--accent)">' + (i + 1) + '.</span> ' + s.name +
                ' <span style="color:var(--text-dim)">(wk ' + s.step + ')</span></div>'
            ).join('');
        }

        function updateScenarioCompare() {
            const el = document.getElementById('scenario-compare-content');
            if (savedScenarios.length === 0) {
                el.innerHTML = '<p style="color:var(--text-dim);font-size:12px;">Save scenarios from the sidebar to compare them here.</p>';
                return;
            }

            const metricLabels = {
                total_staked: 'RSC Staked',
                total_credits: 'Credits',
                total_burned: 'Burned',
                active_stakers: 'Active Stakers',
                churned_stakers: 'Churned',
                avg_satisfaction: 'Avg Satisfaction',
                credit_generation_rate: 'Credits/Wk',
                deployment_rate: 'Deployed/Wk',
                success_rate_actual: 'Success Rate',
                completed_proposals: 'Completed',
                failed_proposals: 'Failed',
                open_proposals: 'Open',
                num_stakers: 'Total Stakers',
            };

            let html = '<table class="scenario-table"><thead><tr><th>Metric</th>';
            savedScenarios.forEach(s => { html += '<th>' + s.name + '</th>'; });
            html += '</tr></thead><tbody>';

            for (const [key, label] of Object.entries(metricLabels)) {
                html += '<tr><td>' + label + '</td>';
                savedScenarios.forEach(s => {
                    const val = s.metrics[key];
                    const formatted = key === 'avg_satisfaction' ? val.toFixed(3)
                        : key === 'success_rate_actual' ? (val * 100).toFixed(0) + '%'
                        : typeof val === 'number' ? formatNumber(val) : val;
                    html += '<td>' + formatted + '</td>';
                });
                html += '</tr>';
            }
            html += '</tbody></table>';
            el.innerHTML = html;
        }

        // ============================================
        // Scenario Modal
        // ============================================
        function openScenarioModal() {
            document.getElementById('scenario-modal').classList.add('open');
            updateScenarioCompare();
        }

        function closeScenarioModal() {
            document.getElementById('scenario-modal').classList.remove('open');
        }

        // Close modal on backdrop click
        document.getElementById('scenario-modal').addEventListener('click', function(e) {
            if (e.target === this) closeScenarioModal();
        });

        // Metrics detail toggle
        function toggleMetricDetails(e) {
            e.preventDefault();
            const details = document.getElementById('metric-details');
            const link = e.target;
            if (details.style.display === 'none') {
                details.style.display = 'block';
                link.innerHTML = 'Hide detailed metrics &#9662;';
            } else {
                details.style.display = 'none';
                link.innerHTML = 'Show detailed metrics &#9656;';
            }
        }

        // ============================================
        // Design Questions
        // ============================================
        async function loadDesignQuestions() {
            const questions = await fetchJson('/api/design-questions');
            const html = questions.map(q =>
                '<div class="question">' +
                '<div class="question-text">' + q.question + '</div>' +
                '<div class="question-current">Current: <span>' + q.current + '</span></div>' +
                '</div>'
            ).join('');
            document.getElementById('design-questions').innerHTML = html;
        }

        // ============================================
        // Agent Inspector
        // ============================================
        let currentAgentTab = 'top-stakers';
        let lastStakers = [];

        function showAgentTab(tab, btnEl) {
            currentAgentTab = tab;
            document.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');
            else document.querySelector('.agent-tab').classList.add('active');
            renderAgentTab();
        }

        async function loadStakers() {
            lastStakers = await fetchJson('/api/stakers');
            renderAgentTab();
        }

        function renderAgentTab() {
            const container = document.getElementById('agent-content');
            if (!lastStakers.length) {
                container.innerHTML = '<div class="agent-placeholder">No stakers yet. Run the simulation.</div>';
                return;
            }

            if (currentAgentTab === 'top-stakers') {
                const sorted = [...lastStakers].filter(s => s.active).sort((a, b) => b.stake - a.stake).slice(0, 20);
                container.innerHTML =
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Stake</th><th>Tier</th><th>Credits</th><th>Deployed</th><th>Satisfaction</th>' +
                    '</tr></thead><tbody>' +
                    sorted.map(s =>
                        '<tr class="' + (highlightedAgentId === s.id ? 'highlighted' : '') + '">' +
                        '<td class="agent-id">' + s.id + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td>' + formatNumber(s.stake) + '</td>' +
                        '<td><span class="tier-badge tier-' + s.tier_id + '">' + s.tier + '</span></td>' +
                        '<td>' + formatNumber(s.credits) + '</td>' +
                        '<td>' + formatNumber(s.total_deployed) + '</td>' +
                        '<td><div class="sat-bar"><div class="sat-fill" style="width:' + (s.satisfaction * 100) + '%;background:' + satColor(s.satisfaction) + '"></div></div>' + s.satisfaction.toFixed(2) + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>';

            } else if (currentAgentTab === 'recent-deployers') {
                const deployers = [...lastStakers].filter(s => s.total_deployed > 0).sort((a, b) => b.total_deployed - a.total_deployed).slice(0, 20);
                container.innerHTML = deployers.length ?
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Deployed</th><th>Burned</th><th>Net Position</th><th>Satisfaction</th>' +
                    '</tr></thead><tbody>' +
                    deployers.map(s =>
                        '<tr class="' + (!s.active ? 'churned' : '') + (highlightedAgentId === s.id ? ' highlighted' : '') + '">' +
                        '<td class="agent-id">' + s.id + (s.active ? '' : ' [left]') + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td style="color:var(--success)">' + formatNumber(s.total_deployed) + '</td>' +
                        '<td style="color:var(--danger)">' + formatNumber(s.total_burned) + '</td>' +
                        '<td style="color:' + (s.stake > s.initial_stake ? 'var(--success)' : 'var(--danger)') + '">' +
                        (s.stake > s.initial_stake ? '+' : '') + formatNumber(s.stake - s.initial_stake) + '</td>' +
                        '<td>' + s.satisfaction.toFixed(2) + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>'
                    : '<div class="agent-placeholder">No deployments yet. Run more steps.</div>';

            } else if (currentAgentTab === 'by-archetype') {
                const archetypes = ['believer', 'yield_seeker', 'governance', 'speculator'];
                const archNames = { believer: 'Believer', yield_seeker: 'Yield Seeker', governance: 'Governance', speculator: 'Speculator' };
                const rows = archetypes.map(a => {
                    const group = lastStakers.filter(s => s.archetype === a);
                    const active = group.filter(s => s.active);
                    const totalStake = active.reduce((acc, s) => acc + s.stake, 0);
                    const totalDeployed = group.reduce((acc, s) => acc + s.total_deployed, 0);
                    const avgSat = active.length > 0 ? active.reduce((acc, s) => acc + s.satisfaction, 0) / active.length : 0;
                    const avgEng = active.length > 0 ? active.reduce((acc, s) => acc + s.engagement, 0) / active.length : 0;
                    return '<tr>' +
                        '<td><span class="arch-badge ' + a + '">' + archNames[a] + '</span></td>' +
                        '<td>' + active.length + '/' + group.length + '</td>' +
                        '<td>' + formatNumber(totalStake) + '</td>' +
                        '<td>' + formatNumber(totalDeployed) + '</td>' +
                        '<td style="color:' + satColor(avgSat) + '">' + avgSat.toFixed(2) + '</td>' +
                        '<td>' + avgEng.toFixed(2) + '</td>' +
                        '</tr>';
                });
                container.innerHTML =
                    '<table class="agent-table"><thead><tr>' +
                    '<th>Archetype</th><th>Active/Total</th><th>Total Stake</th><th>Total Deployed</th><th>Avg Satisfaction</th><th>Avg Engagement</th>' +
                    '</tr></thead><tbody>' + rows.join('') + '</tbody></table>';

            } else if (currentAgentTab === 'churned') {
                const churned = lastStakers.filter(s => !s.active);
                container.innerHTML = churned.length ?
                    '<table class="agent-table"><thead><tr>' +
                    '<th>ID</th><th>Archetype</th><th>Final Stake</th><th>Tier</th><th>Total Deployed</th><th>Final Satisfaction</th><th>Idle Steps</th>' +
                    '</tr></thead><tbody>' +
                    churned.map(s =>
                        '<tr class="churned">' +
                        '<td class="agent-id">' + s.id + '</td>' +
                        '<td><span class="arch-badge ' + s.archetype + '">' + s.archetype + '</span></td>' +
                        '<td>' + formatNumber(s.stake) + '</td>' +
                        '<td><span class="tier-badge tier-' + s.tier_id + '">' + s.tier + '</span></td>' +
                        '<td>' + formatNumber(s.total_deployed) + '</td>' +
                        '<td style="color:var(--danger)">' + s.satisfaction.toFixed(2) + '</td>' +
                        '<td>' + s.idle_steps + '</td>' +
                        '</tr>'
                    ).join('') +
                    '</tbody></table>'
                    : '<div class="agent-placeholder">No stakers have churned yet.</div>';
            }

            // Clear highlight after render
            setTimeout(() => { highlightedAgentId = null; }, 3000);
        }

        // ============================================
        // Narrative
        // ============================================
        function generateNarrative(model, events) {
            const parts = [];
            const step = model.step;
            const stepEvents = events.filter(e => e.step === step);
            const funded = stepEvents.filter(e => e.type === 'funded').length;
            const completed = stepEvents.filter(e => e.type === 'completed').length;
            const failed = stepEvents.filter(e => e.type === 'failed').length;
            const newProposals = stepEvents.filter(e => e.type === 'new_proposal').length;
            const churned = stepEvents.filter(e => e.type === 'churn').length;

            const creditsGen = model.credit_generation_rate;
            const deployed = model.deployment_rate;
            const burned = model.burn_rate_per_step;

            parts.push('<p><strong>Week ' + step + ':</strong> <span class="narrative-highlight">' + model.active_stakers + ' active stakers</span> (' + model.churned_stakers + ' churned) earned credits. ' +
                'Generation: <span class="narrative-highlight">' + formatNumber(creditsGen) + ' credits</span>. ' +
                'Avg satisfaction: ' + model.avg_satisfaction.toFixed(2) + '.</p>');

            if (deployed > 0) {
                parts.push('<p><span class="narrative-success">' + formatNumber(deployed) + ' credits</span> deployed to proposals, ' +
                    'triggering <span class="narrative-danger">' + formatNumber(burned) + ' RSC burn</span>.</p>');
            }

            if (funded > 0) {
                parts.push('<p><span class="narrative-success">' + funded + ' proposal' + (funded > 1 ? 's' : '') + ' reached funding target!</span></p>');
            }

            if (completed > 0 || failed > 0) {
                const resolutions = [];
                if (completed > 0) resolutions.push('<span class="narrative-success">' + completed + ' completed</span>');
                if (failed > 0) resolutions.push('<span class="narrative-danger">' + failed + ' failed</span>');
                parts.push('<p>Proposals resolved: ' + resolutions.join(', ') + '.</p>');
            }

            if (churned > 0) {
                parts.push('<p><span class="narrative-danger">' + churned + ' staker' + (churned > 1 ? 's' : '') + ' left the system</span> (low satisfaction).</p>');
            }

            if (newProposals > 0) {
                parts.push('<p><span class="narrative-highlight">' + newProposals + ' new proposal' + (newProposals > 1 ? 's' : '') + '</span> entered the queue.</p>');
            }

            return parts.join('') || '<p class="narrative-placeholder">No significant activity this week.</p>';
        }

        // updateNarrative removed — "This Week's Activity" section was removed in Round 3

        // ============================================
        // Post-Run Summary
        // ============================================
        function generateNarrativeSummary(model, stakers) {
            // Aggregate per-archetype data from staker list
            const archetypes = ['believer', 'yield_seeker', 'governance', 'speculator'];
            const archNames = { believer: 'Believers', yield_seeker: 'Yield Seekers', governance: 'Governance', speculator: 'Speculators' };
            const archData = {};
            let totalDeployed = 0;
            let totalChurned = 0;

            for (const arch of archetypes) {
                const group = stakers.filter(s => s.archetype === arch);
                const active = group.filter(s => s.active);
                const churned = group.filter(s => !s.active);
                const deployed = group.reduce((sum, s) => sum + s.total_deployed, 0);
                const avgCredits = active.length > 0 ? active.reduce((sum, s) => sum + s.credits, 0) / active.length : 0;
                const avgSat = active.length > 0 ? active.reduce((sum, s) => sum + s.satisfaction, 0) / active.length : 0;
                archData[arch] = { total: group.length, active: active.length, churned: churned.length, deployed, avgCredits, avgSat };
                totalDeployed += deployed;
                totalChurned += churned.length;
            }

            // Find top deployer archetype
            let topDeployer = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].deployed > archData[topDeployer].deployed) topDeployer = arch;
            }
            const topDeployPct = totalDeployed > 0 ? ((archData[topDeployer].deployed / totalDeployed) * 100).toFixed(0) : 0;
            const topDeployPopPct = ((archData[topDeployer].total / stakers.length) * 100).toFixed(0);

            // Find highest credit hoarder
            let hoarder = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].avgCredits > archData[hoarder].avgCredits) hoarder = arch;
            }
            let lowestCredits = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].active > 0 && archData[arch].avgCredits < archData[lowestCredits].avgCredits) lowestCredits = arch;
            }
            const hoardRatio = archData[lowestCredits].avgCredits > 0
                ? (archData[hoarder].avgCredits / archData[lowestCredits].avgCredits).toFixed(1)
                : 'N/A';

            // Find fastest satisfaction decline
            let fastestDrop = archetypes[0];
            for (const arch of archetypes) {
                if (archData[arch].active > 0 && archData[arch].avgSat < archData[fastestDrop].avgSat) fastestDrop = arch;
            }

            // Burn as % of initial stake
            const burnPct = initialSnapshot.total_staked > 0
                ? ((model.total_burned / initialSnapshot.total_staked) * 100).toFixed(1)
                : '0';

            // Build narrative
            const parts = [];
            parts.push('Over <span class="narrative-highlight">' + model.step + ' weeks</span>, the endowment generated ' +
                '<span class="narrative-highlight">' + formatNumber(model.total_credits_generated) + ' funding credits</span> and burned ' +
                '<span class="narrative-danger">' + formatNumber(model.total_burned) + ' RSC</span> (' + burnPct + '% of initial stake).');

            parts.push(archNames[topDeployer] + ' were the most active deployers, contributing ' +
                '<span class="narrative-success">' + topDeployPct + '% of all credit deployments</span> despite being ' +
                topDeployPopPct + '% of the population.');

            if (hoarder !== lowestCredits && hoardRatio !== 'N/A') {
                parts.push(archNames[hoarder] + ' hoarded credits — their average credit balance was ' +
                    '<span class="narrative-highlight">' + hoardRatio + 'x higher</span> than ' + archNames[lowestCredits] + '\'s.');
            }

            if (totalChurned > 0) {
                const churnParts = archetypes.filter(a => archData[a].churned > 0)
                    .map(a => archData[a].churned + ' ' + archNames[a].toLowerCase());
                parts.push('<span class="narrative-danger">' + totalChurned + ' staker' + (totalChurned > 1 ? 's' : '') +
                    ' churned</span> (' + churnParts.join(', ') + ').');
            }

            parts.push('Satisfaction declined from <span class="narrative-highlight">1.00 to ' +
                model.avg_satisfaction.toFixed(2) + '</span>, with ' + archNames[fastestDrop] +
                ' dropping fastest (to ' + archData[fastestDrop].avgSat.toFixed(2) + ').');

            // Proposal stats
            if (model.completed_proposals + model.failed_proposals > 0) {
                const totalResolved = model.completed_proposals + model.failed_proposals;
                const successPct = ((model.completed_proposals / totalResolved) * 100).toFixed(0);
                parts.push(totalResolved + ' proposals resolved: <span class="narrative-success">' +
                    model.completed_proposals + ' completed</span>' +
                    (model.failed_proposals > 0 ? ', <span class="narrative-danger">' + model.failed_proposals + ' failed</span>' : '') +
                    ' (' + successPct + '% success rate).');
            }

            return '<p>' + parts.join(' ') + '</p>';
        }

        function updatePostRunSummary(model) {
            if (!initialSnapshot) return;
            const el = document.getElementById('post-run-summary');

            // Generate narrative prose from staker data
            let html = '<div class="summary-panel"><div class="card-header">Run Summary (Week 0 &rarr; ' + model.step + ')</div>';
            if (model.step >= 10 && lastStakers.length > 0) {
                html += '<div class="narrative" style="margin-bottom:12px">' + generateNarrativeSummary(model, lastStakers) + '</div>';
            }

            // Collapsible metrics delta table
            html += '<a href="#" class="detail-toggle" onclick="toggleMetricDetails(event)">Show detailed metrics &#9656;</a>';
            html += '<div id="metric-details" style="display:none">';

            const deltas = [
                { label: 'RSC Staked', initial: initialSnapshot.total_staked, final: model.total_staked },
                { label: 'Credits', initial: initialSnapshot.total_credits, final: model.total_credits },
                { label: 'Active Stakers', initial: initialSnapshot.active_stakers, final: model.active_stakers },
                { label: 'Satisfaction', initial: initialSnapshot.avg_satisfaction, final: model.avg_satisfaction, fmt: 'pct' },
                { label: 'Total Burned', initial: initialSnapshot.total_burned, final: model.total_burned },
                { label: 'Credits Deployed', initial: 0, final: model.total_credits_deployed },
                { label: 'Completed Proposals', initial: 0, final: model.completed_proposals, fmt: 'int' },
                { label: 'Failed Proposals', initial: 0, final: model.failed_proposals, fmt: 'int' },
                { label: 'Open Proposals', initial: 0, final: model.open_proposals, fmt: 'int' },
                { label: 'Total Churned', initial: 0, final: model.churned_stakers, fmt: 'int' },
            ];

            deltas.forEach(d => {
                const diff = d.final - d.initial;
                const sign = diff >= 0 ? '+' : '';
                const cls = diff >= 0 ? 'delta-pos' : 'delta-neg';
                let valStr, diffStr;
                if (d.fmt === 'pct') {
                    valStr = (d.final * 100).toFixed(1) + '%';
                    diffStr = sign + (diff * 100).toFixed(1) + '%';
                } else if (d.fmt === 'int') {
                    valStr = d.final.toString();
                    diffStr = d.initial > 0 ? sign + diff : '';
                } else {
                    valStr = formatNumber(d.final);
                    diffStr = sign + formatNumber(diff);
                }
                const deltaHtml = diffStr ? ' <span class="' + cls + '">(' + diffStr + ')</span>' : '';
                html += '<div class="summary-delta"><span class="delta-label">' + d.label + '</span><span>' + valStr + deltaHtml + '</span></div>';
            });

            // Tension detection
            const tensions = [];
            if (model.total_credits > model.total_credits_deployed * 2 && model.step > 10) {
                tensions.push('Credits accumulating faster than deployed - deployment pressure may build.');
            }
            if (model.avg_satisfaction < 0.5) {
                tensions.push('Low average satisfaction - churn risk is elevated.');
            }
            if (model.churned_stakers > model.active_stakers * 0.3) {
                tensions.push('High churn rate - more than 30% of stakers have left.');
            }

            if (tensions.length > 0) {
                html += '<div class="tension-warning"><strong>Tensions:</strong><ul>';
                tensions.forEach(t => { html += '<li>' + t + '</li>'; });
                html += '</ul></div>';
            }

            html += '</div>'; // close metric-details
            html += '</div>'; // close summary-panel
            el.innerHTML = html;
            el.style.display = 'block';
        }

        // ============================================
        // Init
        // ============================================
        updateUI();
        loadDesignQuestions();
        updateArchBar();
    </script>
</body>
</html>
